---
title: "NEWCRC Dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    social: menu
    source_code: embed
    theme: default
    css: bootstrap.css
runtime: shiny
---

```{r global, include=FALSE}
# Desactive once installed
#install.packages(c("knitr", "flexdashboard", "shiny", "ggplot2", "plotly", "gganimate", "dplyr", "dygraphs", "viridis", "DT", "foreign", "haven", "readxl", "xts"))

rm(list = ls())

library(knitr)
library(flexdashboard)
library(shiny)
library(ggplot2)
library(plotly)
library(gganimate)
library(dplyr)
library(dygraphs)
library(viridis)
library(DT)
library(foreign)
library(haven)
library(readxl)
library(xts)
library(scales)
library(shinyjs)
library(data.table)
library(arrow)
library(reticulate)


setwd("../projects/Dashboard/initial_dataset/Data/")

# Bank List
banklist <- read_feather("banklist.feather")
banklist2 <- read_feather("banklist2.feather")

# Sector List
sectorlist <- read_feather("sectorlist.feather")

# Data Files
bankall <- read_feather("Dashboard_Stats_V1.feather")
bankall_FRM <- read_feather("bankall_FRM.feather")
bankall_PRV <- read_feather("bankall_PRV.feather")
bankall_moratoria <- read_feather("bankall_moratoria.feather")
bankall_FRM_moratoria <- read_feather("bankall_FRM_moratoria.feather")
bankall_PRV_moratoria <- read_feather("bankall_PRV_moratoria.feather")
  
```


Sidebar {.sidebar}
=======================================================================

### **Extraction: May 2021**

\

**General Filters**


```{r}
# Date
#selectInput("date", "Select Date:", c(unique(as.character(bankall$date))), selected = "2021-02-28")

selectInput("date", "Select Date:", c("2018-09"="2018-09-01","2018-10" = "2018-10-01","2018-11"="2018-11-01","2018-12"="2018-12-01","2019-01"="2019-01-01","2019-02" = "2019-02-01","2019-03"="2019-03-01","2019-04"="2019-04-01","2019-05"="2019-05-01","2019-06" = "2019-06-01","2019-07"="2019-07-01","2019-08"="2019-08-01","2019-09"="2019-09-01","2019-10" = "2019-10-01","2019-11"="2019-11-01","2019-12"="2019-12-01","2020-01"="2020-01-01","2020-02" = "2020-02-01","2020-03"="2020-03-01","2020-04"="2020-04-01","2020-05"="2020-05-01","2020-06" = "2020-06-01","2020-07"="2020-07-01","2020-08"="2020-08-01","2020-09"="2020-09-01","2020-10" = "2020-10-01","2020-11"="2020-11-01","2020-12"="2020-12-01", "2021-01"="2021-01-01","2021-02" = "2021-02-01","2021-03" = "2021-03-01"), selected ="2021-03-01")

# Population
selectInput("population", "Select Population:", c(unique(as.character(bankall$pop))), selected = "FRM")

# Level or Growth
selectInput("unit", "Select Mode:", c("Level", "MoM Abs Change", "MoM Rel Change", "YoY Abs Change", "YoY Rel Change"), selected = "Level")

```

\

**Bank and Product**

```{r}
# Bank list
selectInput("bank", "Select Bank:", c("All", unique(sort(as.character(bankall$Bank)))))

# Product list
selectInput("prod", "Select Product:", c("All", unique(sort(as.character(bankall$type)))))

```



\

**Firm Characteristics**

```{r}
# Size
selectInput("size", "Select Size:", c("All", "Micro", "Small", "Medium", "Big", "Not Available"="NA"), selected = "All")

# Age Group
selectInput("firmage", "Select Age Group:", c("All", "<3", "[3, 5)", "[5, 10)", "[10, 20)", "[20, 30)", ">=30", "Not Available"="NA"), selected = "All")

# Region
selectInput("region", "Select Region:", c("All", "Lisboa", "Norte", "Centro", "Alentejo", "Algarve", "Madeira", "Azores", "Not Available"="NA"), selected = "All")

# Sector
#selectInput("sector", "Select Sector:", c(unique(as.character(bankall_FRM$Sector))), selected = "A")
selectInput("sector", "Select Sector:", c("All", "A - Agriculture, farming of animals, hunting and forestry"="A","B - Mining and quarrying" = "B","C - Manufacturing"="C","D - Electricity, gas, steam, cold and hot water and cold air"="D","E - Water collection, treatment and distribution; sewerage, waste management and remediation activities"="E","F - Construction" = "F","G - Wholesale and retail trade; repair of motor vehicles and motorcycles
"="G","H - Transportation and storage"="H","I - Accommodation and food service activities"="I","J - Information and communication activities" = "J","K - Financial and insurance activities"="K","L - Real estate activities"="L","M - Consultancy, scientific and technical activities"="M","N - Administrative and support service activities" = "N","O - Public administration and defence; compulsory social security"="O","P - Education"="P","Q - Human health and social work activities"="Q","R - Arts, entertainment, sports and recreation activities" = "R","S - Other service activities"="S","T - Activities of households as employers; undifferentiated goods- and services-producing activities of households for own use"="T", "Not Available"="NA"), selected ="All")
```


\

**Household Characteristics**

```{r}
# Age Group
# Age Group
selectInput("age", "Select Age Group:", c("All", "<25", "[25, 35)", "[35, 45)", "[45, 55)", "[55, 65)", ">=65", "Not Available"="NA"), selected = "All")

# Gender
selectInput("gender", "Select Gender:", c("All", "Female"="F","Male"="M", "Not Available"="NA"), selected = "All")

# Region
selectInput("hregion", "Select Region:", c("All", "Lisboa", "Norte", "Centro", "Alentejo", "Algarve", "Madeira", "Azores", "Not Available"="NA"), selected = "All")

# Profession
selectInput("prof", "Select Profession:", c("All", "Employee", "Self-employed", "Unemployed", "Student", "Retired", "Outside market", "Not Available"="NA"), selected = "All")

# Education
selectInput("edu", "Select Education:", c("All", "No schooling", "Basic", "Secondary", "Superior", "Not Available"="NA"), selected = "All")

# Family
selectInput("fam", "Select Family:", c("All", "1", "2", "3", "4", ">=5", "Not Available"="NA"), selected = "All")
```

\

**Moratorium**

```{r}
# Moratorium programs
selectInput("moratoria", "Select Moratorium Program:", c("All", unique(as.character(bankall_moratoria$moratoria))))
```



Overview
=======================================================================

<p style="font-family: times, serif; font-size:15pt; font-style:italic">
    <mark>**Attention!**</mark> **The following filters need to be selected: Date, Population, and Mode.** 
</p>

```{r}
useShinyjs(rmd = TRUE)
actionButton("reset0", "Reset",
    icon("sliders"), 
    style="color: #fff; background-color: #71afe3; border-radius: 0%; border-color: #71afe3; padding:8px; font-size:100%; width:70px")

observeEvent(input$reset0, {
  shinyjs::reset("date")
 shinyjs::reset("population")
 shinyjs::reset("unit")
})
```

```{r}


renderText({
  mydate = substr(input$date, 1,7)
  paste("Your Choice: Date = ", mydate, ", Population = ", input$population, ", Mode = ", input$unit) 
})

renderText({
  paste(" ") 
  
})
```


Row
-----------------------------------------------------------------------

### Global Credit {.value-box}

```{r}
number1 <- reactive({ 
  if (input$unit=="Level")
  bankall %>% filter(date==input$date) %>% filter(pop==input$population) %>% 
    summarise_at(vars(Valor_Glob), funs(sum)) %>%
    mutate_at(vars(Valor_Glob), funs(./ 1000000))
  
  else if (input$unit=="MoM Abs Change")
  bankall %>% filter(pop==input$population) %>%  
  group_by(date) %>% 
  summarise_at(vars(Valor_Glob), funs(sum)) %>%
  mutate_at(vars(Valor_Glob), funs(./ 1000000)) %>%
  arrange(date) %>%
  mutate(Valor_Glob_ch= Valor_Glob - lag(Valor_Glob))%>% 
  filter(date==input$date) %>% 
  select(Valor_Glob_ch) %>%
  rename(Valor_Glob = Valor_Glob_ch)
  
  else if (input$unit=="MoM Rel Change")
  bankall %>% filter(pop==input$population) %>%  
  group_by(date) %>% 
  summarise_at(vars(Valor_Glob), funs(sum)) %>%
  mutate_at(vars(Valor_Glob), funs(./ 1000000)) %>%
  arrange(date) %>%
  mutate(Valor_Glob_ch= 100*(Valor_Glob - lag(Valor_Glob))/lag(Valor_Glob))%>% 
  filter(date==input$date) %>% 
  select(Valor_Glob_ch) %>%
  rename(Valor_Glob = Valor_Glob_ch)
  
  else if (input$unit=="YoY Abs Change")
  bankall %>% filter(pop==input$population) %>%  
  group_by(date) %>% 
  summarise_at(vars(Valor_Glob), funs(sum)) %>%
  mutate_at(vars(Valor_Glob), funs(./ 1000000)) %>%
  arrange(date) %>%
  mutate(Valor_Glob_ch= Valor_Glob - lag(Valor_Glob, 12))%>% 
  filter(date==input$date) %>% 
  select(Valor_Glob_ch) %>%
  rename(Valor_Glob = Valor_Glob_ch)
  
  else if (input$unit=="YoY Rel Change")
  bankall %>% filter(pop==input$population) %>%  
  group_by(date) %>% 
  summarise_at(vars(Valor_Glob), funs(sum)) %>%
  mutate_at(vars(Valor_Glob), funs(./ 1000000)) %>%
  arrange(date) %>%
  mutate(Valor_Glob_ch= 100*(Valor_Glob - lag(Valor_Glob, 12))/lag(Valor_Glob, 12))%>% 
  filter(date==input$date) %>% 
  select(Valor_Glob_ch) %>%
  rename(Valor_Glob = Valor_Glob_ch)

})


renderValueBox({
  rate1=as.numeric(number1()$Valor_Glob) 
  
  valueBox(
    if (input$unit=="Level" | input$unit=="MoM Abs Change" | input$unit=="YoY Abs Change") 
      value = scales::dollar(round(rate1,digits=2), prefix = "\u20AC", suffix = " M")
    else if (input$unit=="MoM Rel Change" | input$unit=="YoY Rel Change") 
      value = scales::dollar(round(rate1,digits=2), prefix = "", suffix = "%"),
    
      icon = "fa-area-chart",
      color = "primary"    
  )
})
```


### New Credit {.value-box}

```{r}
number2 <- reactive({ 
  if (input$unit=="Level")
  bankall %>% filter(date==input$date) %>% filter(pop==input$population) %>% 
    summarise_at(vars(Valor_New), funs(sum)) %>%
    mutate_at(vars(Valor_New), funs(./ 1000000))
  
  else if (input$unit=="MoM Abs Change")
  bankall %>% filter(pop==input$population) %>%  
  group_by(date) %>% 
  summarise_at(vars(Valor_New), funs(sum)) %>%
  mutate_at(vars(Valor_New), funs(./ 1000000)) %>%
  arrange(date) %>%
  mutate(Valor_New_ch= Valor_New- lag(Valor_New))%>% 
  filter(date==input$date) %>% 
  select(Valor_New_ch) %>%
  rename(Valor_New = Valor_New_ch)    
  
  else if (input$unit=="MoM Rel Change")
  bankall %>% filter(pop==input$population) %>%  
  group_by(date) %>% 
  summarise_at(vars(Valor_New), funs(sum)) %>%
  mutate_at(vars(Valor_New), funs(./ 1000000)) %>%
  arrange(date) %>%
  mutate(Valor_New_ch= 100*(Valor_New- lag(Valor_New))/lag(Valor_New))%>% 
  filter(date==input$date) %>% 
  select(Valor_New_ch) %>%
  rename(Valor_New = Valor_New_ch)    
  
  else if (input$unit=="YoY Abs Change")
  bankall %>% filter(pop==input$population) %>%  
  group_by(date) %>% 
  summarise_at(vars(Valor_New), funs(sum)) %>%
  mutate_at(vars(Valor_New), funs(./ 1000000)) %>%
  arrange(date) %>%
  mutate(Valor_New_ch= Valor_New- lag(Valor_New, 12))%>% 
  filter(date==input$date) %>% 
  select(Valor_New_ch) %>%
  rename(Valor_New = Valor_New_ch)    
  
  else if (input$unit=="YoY Rel Change")
  bankall %>% filter(pop==input$population) %>%  
  group_by(date) %>% 
  summarise_at(vars(Valor_New), funs(sum)) %>%
  mutate_at(vars(Valor_New), funs(./ 1000000)) %>%
  arrange(date) %>%
  mutate(Valor_New_ch= 100*(Valor_New- lag(Valor_New, 12))/lag(Valor_New, 12))%>% 
  filter(date==input$date) %>% 
  select(Valor_New_ch) %>%
  rename(Valor_New = Valor_New_ch)   
})

renderValueBox({
  rate2=as.numeric(number2()$Valor_New)
  
  valueBox(
    if (input$unit=="Level" | input$unit=="MoM Abs Change" | input$unit=="YoY Abs Change") 
      value = scales::dollar(round(rate2,digits=2), prefix = "\u20AC", suffix = " M")
    else if (input$unit=="MoM Rel Change" | input$unit=="YoY Rel Change") 
      value = scales::dollar(round(rate2,digits=2), prefix = "", suffix = "%"),
    
    icon = "fa-line-chart",
    color = "success"
  )
})

```


### Overdue Credit {.value-box}

```{r}
number3 <- reactive({ 
  if (input$unit=="Level")
  bankall %>% filter(date==input$date) %>% filter(pop==input$population) %>% 
    summarise_at(vars(Valor_Vencido), funs(sum)) %>%
    mutate_at(vars(Valor_Vencido), funs(./ 1000000))
  
  else if (input$unit=="MoM Abs Change")
  bankall %>% filter(pop==input$population) %>%  
  group_by(date) %>% 
  summarise_at(vars(Valor_Vencido), funs(sum)) %>%
  mutate_at(vars(Valor_Vencido), funs(./ 1000000)) %>%
  arrange(date) %>%
  mutate(Valor_Vencido_ch= Valor_Vencido- lag(Valor_Vencido))%>% 
  filter(date==input$date) %>% 
  select(Valor_Vencido_ch) %>%
  rename(Valor_Vencido = Valor_Vencido_ch)  
  
  else if (input$unit=="MoM Rel Change")
  bankall %>% filter(pop==input$population) %>%  
  group_by(date) %>% 
  summarise_at(vars(Valor_Vencido), funs(sum)) %>%
  mutate_at(vars(Valor_Vencido), funs(./ 1000000)) %>%
  arrange(date) %>%
  mutate(Valor_Vencido_ch= 100*(Valor_Vencido- lag(Valor_Vencido))/lag(Valor_Vencido))%>% 
  filter(date==input$date) %>% 
  select(Valor_Vencido_ch) %>%
  rename(Valor_Vencido = Valor_Vencido_ch) 
  
  else if (input$unit=="YoY Abs Change")
  bankall %>% filter(pop==input$population) %>%  
  group_by(date) %>% 
  summarise_at(vars(Valor_Vencido), funs(sum)) %>%
  mutate_at(vars(Valor_Vencido), funs(./ 1000000)) %>%
  arrange(date) %>%
  mutate(Valor_Vencido_ch= Valor_Vencido- lag(Valor_Vencido, 12))%>% 
  filter(date==input$date) %>% 
  select(Valor_Vencido_ch) %>%
  rename(Valor_Vencido = Valor_Vencido_ch)  

  else if (input$unit=="YoY Rel Change")
  bankall %>% filter(pop==input$population) %>%  
  group_by(date) %>% 
  summarise_at(vars(Valor_Vencido), funs(sum)) %>%
  mutate_at(vars(Valor_Vencido), funs(./ 1000000)) %>%
  arrange(date) %>%
  mutate(Valor_Vencido_ch= 100*(Valor_Vencido- lag(Valor_Vencido, 12))/lag(Valor_Vencido, 12))%>% 
  filter(date==input$date) %>% 
  select(Valor_Vencido_ch) %>%
  rename(Valor_Vencido = Valor_Vencido_ch) 
})

renderValueBox({
  rate3=as.numeric(number3()$Valor_Vencido)
  
  valueBox(
    if (input$unit=="Level" | input$unit=="MoM Abs Change" | input$unit=="YoY Abs Change") 
      value = scales::dollar(round(rate3,digits=2), prefix = "\u20AC", suffix = " M")
    else if (input$unit=="MoM Rel Change" | input$unit=="YoY Rel Change") 
      value = scales::dollar(round(rate3,digits=2), prefix = "", suffix = "%"),
    
    icon = "fa-bell-slash-o",
    color = "warning"
  )
})

```


### Written-Off Credit {.value-box}

```{r}
number4 <- reactive({ 
  if (input$unit=="Level")
  bankall %>% filter(date==input$date) %>% filter(pop==input$population) %>% 
    summarise_at(vars(Valor_AbAtv), funs(sum)) %>%
    mutate_at(vars(Valor_AbAtv), funs(./ 1000000))
  
  else if (input$unit=="MoM Abs Change")
  bankall %>% filter(pop==input$population) %>%  
  group_by(date) %>% 
  summarise_at(vars(Valor_AbAtv), funs(sum)) %>%
  mutate_at(vars(Valor_AbAtv), funs(./ 1000000)) %>%
  arrange(date) %>%
  mutate(Valor_AbAtv_ch= Valor_AbAtv- lag(Valor_AbAtv))%>% 
  filter(date==input$date) %>% 
  select(Valor_AbAtv_ch) %>%
  rename(Valor_AbAtv = Valor_AbAtv_ch)  
  
  else if (input$unit=="MoM Rel Change")
  bankall %>% filter(pop==input$population) %>%  
  group_by(date) %>% 
  summarise_at(vars(Valor_AbAtv), funs(sum)) %>%
  mutate_at(vars(Valor_AbAtv), funs(./ 1000000)) %>%
  arrange(date) %>%
  mutate(Valor_AbAtv_ch= 100*(Valor_AbAtv- lag(Valor_AbAtv))/lag(Valor_AbAtv))%>% 
  filter(date==input$date) %>% 
  select(Valor_AbAtv_ch) %>%
  rename(Valor_AbAtv = Valor_AbAtv_ch)  
  
  
  else if (input$unit=="YoY Abs Change")
  bankall %>% filter(pop==input$population) %>%  
  group_by(date) %>% 
  summarise_at(vars(Valor_AbAtv), funs(sum)) %>%
  mutate_at(vars(Valor_AbAtv), funs(./ 1000000)) %>%
  arrange(date) %>%
  mutate(Valor_AbAtv_ch= Valor_AbAtv- lag(Valor_AbAtv, 12))%>% 
  filter(date==input$date) %>% 
  select(Valor_AbAtv_ch) %>%
  rename(Valor_AbAtv = Valor_AbAtv_ch)  
  
  else if (input$unit=="YoY Rel Change")
  bankall %>% filter(pop==input$population) %>%  
  group_by(date) %>% 
  summarise_at(vars(Valor_AbAtv), funs(sum)) %>%
  mutate_at(vars(Valor_AbAtv), funs(./ 1000000)) %>%
  arrange(date) %>%
  mutate(Valor_AbAtv_ch= 100*(Valor_AbAtv- lag(Valor_AbAtv, 12))/lag(Valor_AbAtv, 12))%>% 
  filter(date==input$date) %>% 
  select(Valor_AbAtv_ch) %>%
  rename(Valor_AbAtv = Valor_AbAtv_ch)  
})

renderValueBox({
  rate4=as.numeric(number4()$Valor_AbAtv)
  
  valueBox(
    if (input$unit=="Level" | input$unit=="MoM Abs Change" | input$unit=="YoY Abs Change") 
      value = scales::dollar(round(rate4,digits=2), prefix = "\u20AC", suffix = " M")
    else if (input$unit=="MoM Rel Change" | input$unit=="YoY Rel Change") 
      value = scales::dollar(round(rate4,digits=2), prefix = "", suffix = "%"),
    
    icon = "fa-warning",
    color = "danger"
  )
})

```


Row  {.tabset}
----------------------------------------------------------------------
 
### Global Credit

```{r}
dataset <- reactive({ 
  if (input$unit=="Level")
  bankall %>% filter(date==input$date) %>% filter(pop==input$population) %>% filter(largebank==1) %>%
    group_by(Bank) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST), funs(sum)) %>%
    mutate_at(vars(Valor_Glob: Valor_ST), funs(./ 1000000))  %>% 
    arrange(desc(Valor_Glob))%>% mutate_if(is.numeric, round, 2)  %>% 
    rename(Global = Valor_Glob, Effective = Valor_Eff, New = Valor_New, Overdue = Valor_Vencido, Potential = Valor_Pot, Short = Valor_ST)
  
  
  else if (input$unit=="MoM Abs Change")  
  bankall %>% filter(pop==input$population) %>% filter(largebank==1) %>%
    group_by(Bank, date) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST), funs(sum)) %>%
    mutate_at(vars(Valor_Glob: Valor_ST), funs(./ 1000000)) %>% 
    arrange(Bank, date) %>%
    mutate(Valor_Glob_ch= Valor_Glob- lag(Valor_Glob))%>% 
    mutate(Valor_Eff_ch= Valor_Eff- lag(Valor_Eff))%>% 
    mutate(Valor_New_ch= Valor_New- lag(Valor_New))%>% 
    mutate(Valor_Vencido_ch= Valor_Vencido- lag(Valor_Vencido))%>% 
    mutate(Valor_Pot_ch= Valor_Pot- lag(Valor_Pot))%>% 
    mutate(Valor_ST_ch= Valor_ST- lag(Valor_ST))%>% 
    select(Bank, date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch) %>%
    filter(date==input$date)  %>% 
    mutate(abs_ch= abs(Valor_Glob_ch))%>% 
    arrange(desc(abs_ch))%>% mutate_if(is.numeric, round, 2)  %>% 
    rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch)
  
  
  else if (input$unit=="MoM Rel Change")  
  bankall %>% filter(pop==input$population) %>% filter(largebank==1) %>%
    group_by(Bank, date) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST), funs(sum)) %>%
    mutate_at(vars(Valor_Glob: Valor_ST), funs(./ 1000000)) %>% 
    arrange(Bank, date) %>%
    mutate(Valor_Glob_ch= 100*(Valor_Glob- lag(Valor_Glob))/lag(Valor_Glob))%>% 
    mutate(Valor_Eff_ch= 100*(Valor_Eff- lag(Valor_Eff))/lag(Valor_Eff))%>% 
    mutate(Valor_New_ch= 100*(Valor_New- lag(Valor_New))/lag(Valor_New))%>% 
    mutate(Valor_Vencido_ch= 100*(Valor_Vencido- lag(Valor_Vencido))/lag(Valor_Vencido))%>% 
    mutate(Valor_Pot_ch= 100*(Valor_Pot- lag(Valor_Pot))/lag(Valor_Pot))%>% 
    mutate(Valor_ST_ch= 100*(Valor_ST- lag(Valor_ST))/lag(Valor_ST))%>% 
    select(Bank, date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch) %>%
    filter(date==input$date)  %>% 
    mutate(abs_ch= abs(Valor_Glob_ch))%>% 
    arrange(desc(abs_ch))%>% mutate_if(is.numeric, round, 2)  %>% 
    rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch)
  
  
  else if (input$unit=="YoY Abs Change")  
  bankall %>% filter(pop==input$population) %>% filter(largebank==1) %>%
    group_by(Bank, date) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST), funs(sum)) %>%
    mutate_at(vars(Valor_Glob: Valor_ST), funs(./ 1000000)) %>% 
    arrange(Bank, date) %>%
    mutate(Valor_Glob_ch= Valor_Glob- lag(Valor_Glob, 12))%>% 
    mutate(Valor_Eff_ch= Valor_Eff- lag(Valor_Eff, 12))%>% 
    mutate(Valor_New_ch= Valor_New- lag(Valor_New, 12))%>% 
    mutate(Valor_Vencido_ch= Valor_Vencido- lag(Valor_Vencido, 12))%>% 
    mutate(Valor_Pot_ch= Valor_Pot- lag(Valor_Pot, 12))%>% 
    mutate(Valor_ST_ch= Valor_ST- lag(Valor_ST, 12))%>% 
    select(Bank, date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch) %>%
    filter(date==input$date)  %>% 
    mutate(abs_ch= abs(Valor_Glob_ch))%>% 
    arrange(desc(abs_ch))%>% mutate_if(is.numeric, round, 2)  %>% 
    rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch)
  
  
  else if (input$unit=="YoY Rel Change")  
  bankall %>% filter(pop==input$population) %>% filter(largebank==1) %>%
    group_by(Bank, date) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST), funs(sum)) %>%
    mutate_at(vars(Valor_Glob: Valor_ST), funs(./ 1000000)) %>% 
    arrange(Bank, date) %>%
    mutate(Valor_Glob_ch= 100*(Valor_Glob- lag(Valor_Glob, 12))/lag(Valor_Glob, 12))%>% 
    mutate(Valor_Eff_ch= 100*(Valor_Eff- lag(Valor_Eff, 12))/lag(Valor_Eff, 12))%>% 
    mutate(Valor_New_ch= 100*(Valor_New- lag(Valor_New, 12))/lag(Valor_New, 12))%>% 
    mutate(Valor_Vencido_ch= 100*(Valor_Vencido- lag(Valor_Vencido, 12))/lag(Valor_Vencido, 12))%>% 
    mutate(Valor_Pot_ch= 100*(Valor_Pot- lag(Valor_Pot, 12))/lag(Valor_Pot, 12))%>% 
    mutate(Valor_ST_ch= 100*(Valor_ST- lag(Valor_ST, 12))/lag(Valor_ST, 12))%>% 
    select(Bank, date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch) %>%
    filter(date==input$date)  %>% 
    mutate(abs_ch= abs(Valor_Glob_ch))%>% 
    arrange(desc(abs_ch))%>% mutate_if(is.numeric, round, 2)  %>% 
    rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch)
  
  
})

renderPlotly({
  
  if  (input$unit=="Level")  
  myytitle = "Amount (million euros)"
  else if  (input$unit=="MoM Abs Change")  
  myytitle = "Monthly Amount Change (million euros)"
  else if  (input$unit=="MoM Rel Change")  
  myytitle = "Monthly Percentage Change (%)"
  else if  (input$unit=="YoY Abs Change")  
  myytitle = "Yearly Amount Change (million euros)"
  else if  (input$unit=="YoY Rel Change")  
  myytitle = "Yearly Percentage Change (%)"
  
  datasettop <- dataset() %>% head(10)

  p <- ggplot(data=datasettop, aes(x= reorder(Bank,Global),Global)) + 
    geom_bar(stat="identity", fill="steelblue") + 
    coord_flip() +
    theme_minimal() + ggtitle("Top Bank") + labs(x="Bank (Bank)", y = myytitle)
  
  ggplotly(p)
}) 
``` 

### New Credit

```{r}
dataset2 <- reactive({ 
  if (input$unit=="Level")
  bankall %>% filter(date==input$date) %>% filter(pop==input$population) %>% filter(largebank==1) %>%
    group_by(Bank) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST), funs(sum)) %>%
    mutate_at(vars(Valor_Glob: Valor_ST), funs(./ 1000000))  %>% 
    arrange(desc(Valor_New))%>% mutate_if(is.numeric, round, 2)  %>% 
    rename(Global = Valor_Glob, Effective = Valor_Eff, New = Valor_New, Overdue = Valor_Vencido, Potential = Valor_Pot, Short = Valor_ST)
  
  else if (input$unit=="MoM Abs Change")
  bankall %>% filter(pop==input$population) %>% filter(largebank==1) %>%
    group_by(Bank, date) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST), funs(sum)) %>%
    mutate_at(vars(Valor_Glob: Valor_ST), funs(./ 1000000)) %>% 
    arrange(Bank, date) %>%
    mutate(Valor_Glob_ch= Valor_Glob- lag(Valor_Glob))%>% 
    mutate(Valor_Eff_ch= Valor_Eff- lag(Valor_Eff))%>% 
    mutate(Valor_New_ch= Valor_New- lag(Valor_New))%>% 
    mutate(Valor_Vencido_ch= Valor_Vencido- lag(Valor_Vencido))%>% 
    mutate(Valor_Pot_ch= Valor_Pot- lag(Valor_Pot))%>% 
    mutate(Valor_ST_ch= Valor_ST- lag(Valor_ST))%>% 
    select(Bank, date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch) %>%
    filter(date==input$date)  %>% 
    mutate(abs_ch= abs(Valor_New_ch))%>% 
    arrange(desc(abs_ch))%>% mutate_if(is.numeric, round, 2)  %>% 
    rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch)
  
  else if (input$unit=="MoM Rel Change")  
  bankall %>% filter(pop==input$population) %>% filter(largebank==1) %>%
    group_by(Bank, date) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST), funs(sum)) %>%
    mutate_at(vars(Valor_Glob: Valor_ST), funs(./ 1000000)) %>% 
    arrange(Bank, date) %>%
    mutate(Valor_Glob_ch= 100*(Valor_Glob- lag(Valor_Glob))/lag(Valor_Glob))%>% 
    mutate(Valor_Eff_ch= 100*(Valor_Eff- lag(Valor_Eff))/lag(Valor_Eff))%>% 
    mutate(Valor_New_ch= 100*(Valor_New- lag(Valor_New))/lag(Valor_New))%>% 
    mutate(Valor_Vencido_ch= 100*(Valor_Vencido- lag(Valor_Vencido))/lag(Valor_Vencido))%>% 
    mutate(Valor_Pot_ch= 100*(Valor_Pot- lag(Valor_Pot))/lag(Valor_Pot))%>% 
    mutate(Valor_ST_ch= 100*(Valor_ST- lag(Valor_ST))/lag(Valor_ST))%>% 
    select(Bank, date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch) %>%
    filter(date==input$date)  %>% 
    mutate(abs_ch= abs(Valor_New_ch))%>% 
    arrange(desc(abs_ch))%>% mutate_if(is.numeric, round, 2)  %>% 
    rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch)
  
  
  else if (input$unit=="YoY Abs Change")
  bankall %>% filter(pop==input$population) %>% filter(largebank==1) %>%
    group_by(Bank, date) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST), funs(sum)) %>%
    mutate_at(vars(Valor_Glob: Valor_ST), funs(./ 1000000)) %>% 
    arrange(Bank, date) %>%
    mutate(Valor_Glob_ch= Valor_Glob- lag(Valor_Glob, 12))%>% 
    mutate(Valor_Eff_ch= Valor_Eff- lag(Valor_Eff, 12))%>% 
    mutate(Valor_New_ch= Valor_New- lag(Valor_New, 12))%>% 
    mutate(Valor_Vencido_ch= Valor_Vencido- lag(Valor_Vencido, 12))%>% 
    mutate(Valor_Pot_ch= Valor_Pot- lag(Valor_Pot, 12))%>% 
    mutate(Valor_ST_ch= Valor_ST- lag(Valor_ST, 12))%>% 
    select(Bank, date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch) %>%
    filter(date==input$date)  %>% 
    mutate(abs_ch= abs(Valor_New_ch))%>% 
    arrange(desc(abs_ch))%>% mutate_if(is.numeric, round, 2)  %>% 
    rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch)
  
  else if (input$unit=="YoY Rel Change")  
  bankall %>% filter(pop==input$population) %>% filter(largebank==1) %>%
    group_by(Bank, date) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST), funs(sum)) %>%
    mutate_at(vars(Valor_Glob: Valor_ST), funs(./ 1000000)) %>% 
    arrange(Bank, date) %>%
    mutate(Valor_Glob_ch= 100*(Valor_Glob- lag(Valor_Glob, 12))/lag(Valor_Glob, 12))%>% 
    mutate(Valor_Eff_ch= 100*(Valor_Eff- lag(Valor_Eff, 12))/lag(Valor_Eff, 12))%>% 
    mutate(Valor_New_ch= 100*(Valor_New- lag(Valor_New, 12))/lag(Valor_New, 12))%>% 
    mutate(Valor_Vencido_ch= 100*(Valor_Vencido- lag(Valor_Vencido, 12))/lag(Valor_Vencido, 12))%>% 
    mutate(Valor_Pot_ch= 100*(Valor_Pot- lag(Valor_Pot, 12))/lag(Valor_Pot, 12))%>% 
    mutate(Valor_ST_ch= 100*(Valor_ST- lag(Valor_ST, 12))/lag(Valor_ST, 12))%>% 
    select(Bank, date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch) %>%
    filter(date==input$date)  %>% 
    mutate(abs_ch= abs(Valor_New_ch))%>% 
    arrange(desc(abs_ch))%>% mutate_if(is.numeric, round, 2)  %>% 
    rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch)
  
})

renderPlotly({
  
  if  (input$unit=="Level")  
  myytitle = "Amount (million euros)"
  else if  (input$unit=="MoM Abs Change")  
  myytitle = "Monthly Amount Change (million euros)"
  else if  (input$unit=="MoM Rel Change")  
  myytitle = "Monthly Percentage Change (%)"
  else if  (input$unit=="YoY Abs Change")  
  myytitle = "Yearly Amount Change (million euros)"
  else if  (input$unit=="YoY Rel Change")  
  myytitle = "Yearly Percentage Change (%)"
  
  datasettop2 <- dataset2() %>% head(10)

  p <- ggplot(data=datasettop2, aes(x= reorder(Bank,New),New)) + 
    geom_bar(stat="identity", fill="darkolivegreen3") + 
    coord_flip() +
    theme_minimal() + ggtitle("Top Bank") + labs(x="Bank (Bank)", y = myytitle)
  
  ggplotly(p)
}) 
```  


### Overdue Credit

```{r}
dataset3 <- reactive({ 
  if (input$unit=="Level")
  bankall %>% filter(date==input$date) %>% filter(pop==input$population) %>% filter(largebank==1) %>%
    group_by(Bank) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST), funs(sum)) %>%
    mutate_at(vars(Valor_Glob: Valor_ST), funs(./ 1000000))  %>% 
    arrange(desc(Valor_Vencido))%>% mutate_if(is.numeric, round, 2)  %>% 
    rename(Global = Valor_Glob, Effective = Valor_Eff, New = Valor_New, Overdue = Valor_Vencido, Potential = Valor_Pot, Short = Valor_ST)
  
  else if (input$unit=="MoM Abs Change")
  bankall %>% filter(pop==input$population) %>% filter(largebank==1) %>%
    group_by(Bank, date) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST), funs(sum)) %>%
    mutate_at(vars(Valor_Glob: Valor_ST), funs(./ 1000000)) %>% 
    arrange(Bank, date) %>%
    mutate(Valor_Glob_ch= Valor_Glob- lag(Valor_Glob))%>% 
    mutate(Valor_Eff_ch= Valor_Eff- lag(Valor_Eff))%>% 
    mutate(Valor_New_ch= Valor_New- lag(Valor_New))%>% 
    mutate(Valor_Vencido_ch= Valor_Vencido- lag(Valor_Vencido))%>% 
    mutate(Valor_Pot_ch= Valor_Pot- lag(Valor_Pot))%>% 
    mutate(Valor_ST_ch= Valor_ST- lag(Valor_ST))%>% 
    select(Bank, date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch) %>%
    filter(date==input$date)  %>% 
    mutate(abs_ch= abs(Valor_Vencido_ch))%>%
    arrange(desc(abs_ch))%>% mutate_if(is.numeric, round, 2)  %>% 
    rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch)
  
  else if (input$unit=="MoM Rel Change")  
  bankall %>% filter(pop==input$population) %>% filter(largebank==1) %>%
    group_by(Bank, date) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST), funs(sum)) %>%
    mutate_at(vars(Valor_Glob: Valor_ST), funs(./ 1000000)) %>% 
    arrange(Bank, date) %>%
    mutate(Valor_Glob_ch= 100*(Valor_Glob- lag(Valor_Glob))/lag(Valor_Glob))%>% 
    mutate(Valor_Eff_ch= 100*(Valor_Eff- lag(Valor_Eff))/lag(Valor_Eff))%>% 
    mutate(Valor_New_ch= 100*(Valor_New- lag(Valor_New))/lag(Valor_New))%>% 
    mutate(Valor_Vencido_ch= 100*(Valor_Vencido- lag(Valor_Vencido))/lag(Valor_Vencido))%>% 
    mutate(Valor_Pot_ch= 100*(Valor_Pot- lag(Valor_Pot))/lag(Valor_Pot))%>% 
    mutate(Valor_ST_ch= 100*(Valor_ST- lag(Valor_ST))/lag(Valor_ST))%>% 
    select(Bank, date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch) %>%
    filter(date==input$date)  %>% 
    mutate(abs_ch= abs(Valor_Vencido_ch))%>% 
    arrange(desc(abs_ch))%>% mutate_if(is.numeric, round, 2)  %>% 
    rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch)
  
  
  else if (input$unit=="YoY Abs Change")
  bankall %>% filter(pop==input$population) %>% filter(largebank==1) %>%
    group_by(Bank, date) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST), funs(sum)) %>%
    mutate_at(vars(Valor_Glob: Valor_ST), funs(./ 1000000)) %>% 
    arrange(Bank, date) %>%
    mutate(Valor_Glob_ch= Valor_Glob- lag(Valor_Glob, 12))%>% 
    mutate(Valor_Eff_ch= Valor_Eff- lag(Valor_Eff, 12))%>% 
    mutate(Valor_New_ch= Valor_New- lag(Valor_New, 12))%>% 
    mutate(Valor_Vencido_ch= Valor_Vencido- lag(Valor_Vencido, 12))%>% 
    mutate(Valor_Pot_ch= Valor_Pot- lag(Valor_Pot, 12))%>% 
    mutate(Valor_ST_ch= Valor_ST- lag(Valor_ST, 12))%>% 
    select(Bank, date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch) %>%
    filter(date==input$date)  %>% 
    mutate(abs_ch= abs(Valor_Vencido_ch))%>%
    arrange(desc(abs_ch))%>% mutate_if(is.numeric, round, 2)  %>% 
    rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch)
  
  else if (input$unit=="YoY Rel Change")  
  bankall %>% filter(pop==input$population) %>% filter(largebank==1) %>%
    group_by(Bank, date) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST), funs(sum)) %>%
    mutate_at(vars(Valor_Glob: Valor_ST), funs(./ 1000000)) %>% 
    arrange(Bank, date) %>%
    mutate(Valor_Glob_ch= 100*(Valor_Glob- lag(Valor_Glob, 12))/lag(Valor_Glob, 12))%>% 
    mutate(Valor_Eff_ch= 100*(Valor_Eff- lag(Valor_Eff, 12))/lag(Valor_Eff, 12))%>% 
    mutate(Valor_New_ch= 100*(Valor_New- lag(Valor_New, 12))/lag(Valor_New, 12))%>% 
    mutate(Valor_Vencido_ch= 100*(Valor_Vencido- lag(Valor_Vencido, 12))/lag(Valor_Vencido, 12))%>% 
    mutate(Valor_Pot_ch= 100*(Valor_Pot- lag(Valor_Pot, 12))/lag(Valor_Pot, 12))%>% 
    mutate(Valor_ST_ch= 100*(Valor_ST- lag(Valor_ST, 12))/lag(Valor_ST, 12))%>% 
    select(Bank, date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch) %>%
    filter(date==input$date)  %>% 
    mutate(abs_ch= abs(Valor_Vencido_ch))%>% 
    arrange(desc(abs_ch))%>% mutate_if(is.numeric, round, 2)  %>% 
    rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch)
  
})

renderPlotly({
  
  if  (input$unit=="Level")  
  myytitle = "Amount (million euros)"
  else if  (input$unit=="MoM Abs Change")  
  myytitle = "Monthly Amount Change (million euros)"
  else if  (input$unit=="MoM Rel Change")  
  myytitle = "Monthly Percentage Change (%)"
  else if  (input$unit=="YoY Abs Change")  
  myytitle = "Yearly Amount Change (million euros)"
  else if  (input$unit=="YoY Rel Change")  
  myytitle = "Yearly Percentage Change (%)"
  
  datasettop3 <- dataset3() %>% head(10)

  p <- ggplot(data=datasettop3, aes(x= reorder(Bank,Overdue),Overdue)) + 
    geom_bar(stat="identity", fill="darkorange1") + 
    coord_flip() +
    theme_minimal() + ggtitle("Top Bank") + labs(x="Bank (Bank)", y = myytitle)
  
  ggplotly(p)
}) 
```  


### Written-Off Credit

```{r}
dataset4 <- reactive({ 
  if (input$unit=="Level")
  bankall %>% filter(date==input$date) %>% filter(pop==input$population) %>% filter(largebank==1) %>%
    group_by(Bank) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST, Valor_AbAtv), funs(sum)) %>%
    mutate_at(vars(Valor_Glob: Valor_AbAtv), funs(./ 1000000))  %>% 
    arrange(desc(Valor_AbAtv)) %>% mutate_if(is.numeric, round, 2)  %>% 
    rename(Global = Valor_Glob, Effective = Valor_Eff, New = Valor_New, Overdue = Valor_Vencido, Potential = Valor_Pot, Short = Valor_ST, Writeoff = Valor_AbAtv)
  
  else if (input$unit=="MoM Abs Change")
  bankall %>% filter(pop==input$population) %>% filter(largebank==1) %>%
    group_by(Bank, date) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST, Valor_AbAtv), funs(sum)) %>%
    mutate_at(vars(Valor_Glob: Valor_AbAtv), funs(./ 1000000)) %>% 
    arrange(Bank, date) %>%
    mutate(Valor_Glob_ch= Valor_Glob- lag(Valor_Glob))%>% 
    mutate(Valor_Eff_ch= Valor_Eff- lag(Valor_Eff))%>% 
    mutate(Valor_New_ch= Valor_New- lag(Valor_New))%>% 
    mutate(Valor_Vencido_ch= Valor_Vencido- lag(Valor_Vencido))%>% 
    mutate(Valor_Pot_ch= Valor_Pot- lag(Valor_Pot))%>% 
    mutate(Valor_ST_ch= Valor_ST- lag(Valor_ST))%>% 
    mutate(Valor_AbAtv_ch= Valor_AbAtv- lag(Valor_AbAtv))%>% 
    select(Bank, date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch, Valor_AbAtv_ch) %>%
    filter(date==input$date)  %>% 
    mutate(abs_ch= abs(Valor_AbAtv_ch))%>% 
    arrange(desc(abs_ch))%>% mutate_if(is.numeric, round, 2)  %>% 
    rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch, Writeoff = Valor_AbAtv_ch)
  
  else if (input$unit=="MoM Rel Change")  
  bankall %>% filter(pop==input$population) %>% filter(largebank==1) %>%
    group_by(Bank, date) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST, Valor_AbAtv), funs(sum)) %>%
    mutate_at(vars(Valor_Glob: Valor_AbAtv), funs(./ 1000000)) %>% 
    arrange(Bank, date) %>%
    mutate(Valor_Glob_ch= 100*(Valor_Glob- lag(Valor_Glob))/lag(Valor_Glob))%>% 
    mutate(Valor_Eff_ch= 100*(Valor_Eff- lag(Valor_Eff))/lag(Valor_Eff))%>% 
    mutate(Valor_New_ch= 100*(Valor_New- lag(Valor_New))/lag(Valor_New))%>% 
    mutate(Valor_Vencido_ch= 100*(Valor_Vencido- lag(Valor_Vencido))/lag(Valor_Vencido))%>% 
    mutate(Valor_Pot_ch= 100*(Valor_Pot- lag(Valor_Pot))/lag(Valor_Pot))%>% 
    mutate(Valor_ST_ch= 100*(Valor_ST- lag(Valor_ST))/lag(Valor_ST))%>% 
    mutate(Valor_AbAtv_ch= 100*(Valor_AbAtv- lag(Valor_AbAtv))/lag(Valor_AbAtv))%>% 
    select(Bank, date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch,Valor_AbAtv_ch) %>%
    filter(date==input$date)  %>% 
    mutate(abs_ch= abs(Valor_AbAtv_ch))%>% 
    arrange(desc(abs_ch))%>% mutate_if(is.numeric, round, 2)  %>% 
    rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch, Writeoff = Valor_AbAtv_ch)
  
  else if (input$unit=="YoY Abs Change")
  bankall %>% filter(pop==input$population) %>% filter(largebank==1) %>%
    group_by(Bank, date) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST, Valor_AbAtv), funs(sum)) %>%
    mutate_at(vars(Valor_Glob: Valor_AbAtv), funs(./ 1000000)) %>% 
    arrange(Bank, date) %>%
    mutate(Valor_Glob_ch= Valor_Glob- lag(Valor_Glob, 12))%>% 
    mutate(Valor_Eff_ch= Valor_Eff- lag(Valor_Eff, 12))%>% 
    mutate(Valor_New_ch= Valor_New- lag(Valor_New, 12))%>% 
    mutate(Valor_Vencido_ch= Valor_Vencido- lag(Valor_Vencido, 12))%>% 
    mutate(Valor_Pot_ch= Valor_Pot- lag(Valor_Pot, 12))%>% 
    mutate(Valor_ST_ch= Valor_ST- lag(Valor_ST, 12))%>% 
    mutate(Valor_AbAtv_ch= Valor_AbAtv- lag(Valor_AbAtv, 12))%>% 
    select(Bank, date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch, Valor_AbAtv_ch) %>%
    filter(date==input$date)  %>% 
    mutate(abs_ch= abs(Valor_AbAtv_ch))%>% 
    arrange(desc(abs_ch))%>% mutate_if(is.numeric, round, 2)  %>% 
    rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch, Writeoff = Valor_AbAtv_ch)
  
  else if (input$unit=="YoY Rel Change")  
  bankall %>% filter(pop==input$population) %>% filter(largebank==1) %>%
    group_by(Bank, date) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST, Valor_AbAtv), funs(sum)) %>%
    mutate_at(vars(Valor_Glob: Valor_AbAtv), funs(./ 1000000)) %>% 
    arrange(Bank, date) %>%
    mutate(Valor_Glob_ch= 100*(Valor_Glob- lag(Valor_Glob, 12))/lag(Valor_Glob, 12))%>% 
    mutate(Valor_Eff_ch= 100*(Valor_Eff- lag(Valor_Eff, 12))/lag(Valor_Eff, 12))%>% 
    mutate(Valor_New_ch= 100*(Valor_New- lag(Valor_New, 12))/lag(Valor_New, 12))%>% 
    mutate(Valor_Vencido_ch= 100*(Valor_Vencido- lag(Valor_Vencido, 12))/lag(Valor_Vencido, 12))%>% 
    mutate(Valor_Pot_ch= 100*(Valor_Pot- lag(Valor_Pot, 12))/lag(Valor_Pot, 12))%>% 
    mutate(Valor_ST_ch= 100*(Valor_ST- lag(Valor_ST, 12))/lag(Valor_ST, 12))%>% 
    mutate(Valor_AbAtv_ch= 100*(Valor_AbAtv- lag(Valor_AbAtv, 12))/lag(Valor_AbAtv, 12))%>% 
    select(Bank, date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch,Valor_AbAtv_ch) %>%
    filter(date==input$date)  %>% 
    mutate(abs_ch= abs(Valor_AbAtv_ch))%>% 
    arrange(desc(abs_ch))%>% mutate_if(is.numeric, round, 2)  %>% 
    rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch, Writeoff = Valor_AbAtv_ch)
  
})

renderPlotly({
  
  if  (input$unit=="Level")  
  myytitle = "Amount (million euros)"
  else if  (input$unit=="MoM Abs Change")  
  myytitle = "Monthly Amount Change (million euros)"
  else if  (input$unit=="MoM Rel Change")  
  myytitle = "Monthly Percentage Change (%)"
  else if  (input$unit=="YoY Abs Change")  
  myytitle = "Yearly Amount Change (million euros)"
  else if  (input$unit=="YoY Rel Change")  
  myytitle = "Yearly Percentage Change (%)"
  
  datasettop4 <- dataset4() %>% head(10)

  p <- ggplot(data=datasettop4, aes(x= reorder(Bank,Writeoff),Writeoff)) + 
    geom_bar(stat="identity", fill="lightcoral") + 
    coord_flip() +
    theme_minimal() + ggtitle("Top Bank") + labs(x="Bank (Bank)", y = myytitle)
  
  ggplotly(p)
}) 
```  



Row  {.tabset}
----------------------------------------------------------------------
 
### Global Credit

```{r}
datasetpp <- reactive({ 
  if (input$unit=="Level")
  bankall %>% filter(date==input$date) %>% filter(pop==input$population) %>% 
    group_by(type) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST), funs(sum)) %>%
    mutate_at(vars(Valor_Glob: Valor_ST), funs(./ 1000000))  %>% 
    arrange(desc(Valor_Glob))%>% mutate_if(is.numeric, round, 2)  %>% 
    rename(Product = type, Global = Valor_Glob, Effective = Valor_Eff, New = Valor_New, Overdue = Valor_Vencido, Potential = Valor_Pot, Short = Valor_ST) 
  
  else if (input$unit=="MoM Abs Change")
  bankall %>% filter(pop==input$population) %>% 
    group_by(type, date) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST), funs(sum)) %>%
    mutate_at(vars(Valor_Glob: Valor_ST), funs(./ 1000000)) %>% 
    arrange(type, date) %>%
    mutate(Valor_Glob_ch= Valor_Glob- lag(Valor_Glob))%>% 
    mutate(Valor_Eff_ch= Valor_Eff- lag(Valor_Eff))%>% 
    mutate(Valor_New_ch= Valor_New- lag(Valor_New))%>% 
    mutate(Valor_Vencido_ch= Valor_Vencido- lag(Valor_Vencido))%>% 
    mutate(Valor_Pot_ch= Valor_Pot- lag(Valor_Pot))%>% 
    mutate(Valor_ST_ch= Valor_ST- lag(Valor_ST))%>% 
    select(type, date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch) %>%
    filter(date==input$date)  %>% 
    arrange(desc(Valor_Glob_ch))%>% mutate_if(is.numeric, round, 2)  %>% 
    rename(Product = type, Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch)  
  
  
  else if (input$unit=="MoM Rel Change")
  bankall %>% filter(pop==input$population) %>% 
    group_by(type, date) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST), funs(sum)) %>%
    mutate_at(vars(Valor_Glob: Valor_ST), funs(./ 1000000)) %>% 
    arrange(type, date) %>%
    mutate(Valor_Glob_ch= 100*(Valor_Glob- lag(Valor_Glob))/lag(Valor_Glob))%>% 
    mutate(Valor_Eff_ch= 100*(Valor_Eff- lag(Valor_Eff))/lag(Valor_Eff))%>% 
    mutate(Valor_New_ch= 100*(Valor_New- lag(Valor_New))/lag(Valor_New))%>% 
    mutate(Valor_Vencido_ch= 100*(Valor_Vencido- lag(Valor_Vencido))/lag(Valor_Vencido))%>% 
    mutate(Valor_Pot_ch= 100*(Valor_Pot- lag(Valor_Pot))/lag(Valor_Pot))%>% 
    mutate(Valor_ST_ch= 100*(Valor_ST- lag(Valor_ST))/lag(Valor_ST))%>% 
    select(type, date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch) %>%
    filter(date==input$date)  %>% 
    arrange(desc(Valor_Glob_ch))%>% mutate_if(is.numeric, round, 2)  %>% 
    rename(Product = type, Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch) 
  
  
  else if (input$unit=="YoY Abs Change")
  bankall %>% filter(pop==input$population) %>% 
    group_by(type, date) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST), funs(sum)) %>%
    mutate_at(vars(Valor_Glob: Valor_ST), funs(./ 1000000)) %>% 
    arrange(type, date) %>%
    mutate(Valor_Glob_ch= Valor_Glob- lag(Valor_Glob, 12))%>% 
    mutate(Valor_Eff_ch= Valor_Eff- lag(Valor_Eff, 12))%>% 
    mutate(Valor_New_ch= Valor_New- lag(Valor_New, 12))%>% 
    mutate(Valor_Vencido_ch= Valor_Vencido- lag(Valor_Vencido, 12))%>% 
    mutate(Valor_Pot_ch= Valor_Pot- lag(Valor_Pot, 12))%>% 
    mutate(Valor_ST_ch= Valor_ST- lag(Valor_ST, 12))%>% 
    select(type, date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch) %>%
    filter(date==input$date)  %>% 
    arrange(desc(Valor_Glob_ch))%>% mutate_if(is.numeric, round, 2)  %>% 
    rename(Product = type, Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch)  
  
  
  else if (input$unit=="YoY Rel Change")
  bankall %>% filter(pop==input$population) %>% 
    group_by(type, date) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST), funs(sum)) %>%
    mutate_at(vars(Valor_Glob: Valor_ST), funs(./ 1000000)) %>% 
    arrange(type, date) %>%
    mutate(Valor_Glob_ch= 100*(Valor_Glob- lag(Valor_Glob, 12))/lag(Valor_Glob, 12))%>% 
    mutate(Valor_Eff_ch= 100*(Valor_Eff- lag(Valor_Eff, 12))/lag(Valor_Eff, 12))%>% 
    mutate(Valor_New_ch= 100*(Valor_New- lag(Valor_New, 12))/lag(Valor_New, 12))%>% 
    mutate(Valor_Vencido_ch= 100*(Valor_Vencido- lag(Valor_Vencido, 12))/lag(Valor_Vencido, 12))%>% 
    mutate(Valor_Pot_ch= 100*(Valor_Pot- lag(Valor_Pot, 12))/lag(Valor_Pot, 12))%>% 
    mutate(Valor_ST_ch= 100*(Valor_ST- lag(Valor_ST, 12))/lag(Valor_ST, 12))%>% 
    select(type, date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch) %>%
    filter(date==input$date)  %>% 
    arrange(desc(Valor_Glob_ch))%>% mutate_if(is.numeric, round, 2)  %>% 
    rename(Product = type, Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch) 
    
})

renderPlotly({
  
  if  (input$unit=="Level")  
  myytitle = "Amount (million euros)"
  else if  (input$unit=="MoM Abs Change")  
  myytitle = "Monthly Amount Change (million euros)"
  else if  (input$unit=="MoM Rel Change")  
  myytitle = "Monthly Percentage Change (%)"
  else if  (input$unit=="YoY Abs Change")  
  myytitle = "Yearly Amount Change (million euros)"
  else if  (input$unit=="YoY Rel Change")  
  myytitle = "Yearly Percentage Change (%)"
  
  datasetpp2 <- datasetpp() %>% head(10)

  p <- ggplot(data=datasetpp2, aes(x= reorder(Product, Global),Global)) + 
    geom_bar(stat="identity", fill="steelblue") + 
    coord_flip() +
    theme_minimal() + ggtitle("Top Product") + labs(x="Financial product", y = myytitle)
  
  ggplotly(p)
}) 
``` 


### New Credit

```{r}
datasetop <- reactive({ 
  if (input$unit=="Level")
  bankall %>% filter(date==input$date) %>% filter(pop==input$population) %>% 
    group_by(type) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST), funs(sum)) %>%
    mutate_at(vars(Valor_Glob: Valor_ST), funs(./ 1000000))  %>% 
    arrange(desc(Valor_New))%>% mutate_if(is.numeric, round, 2)  %>% 
    rename(Product = type, Global = Valor_Glob, Effective = Valor_Eff, New = Valor_New, Overdue = Valor_Vencido, Potential = Valor_Pot, Short = Valor_ST) 
  
  else if (input$unit=="MoM Abs Change")
  bankall %>% filter(pop==input$population) %>% 
    group_by(type, date) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST), funs(sum)) %>%
    mutate_at(vars(Valor_Glob: Valor_ST), funs(./ 1000000)) %>% 
    arrange(type, date) %>%
    mutate(Valor_Glob_ch= Valor_Glob- lag(Valor_Glob))%>% 
    mutate(Valor_Eff_ch= Valor_Eff- lag(Valor_Eff))%>% 
    mutate(Valor_New_ch= Valor_New- lag(Valor_New))%>% 
    mutate(Valor_Vencido_ch= Valor_Vencido- lag(Valor_Vencido))%>% 
    mutate(Valor_Pot_ch= Valor_Pot- lag(Valor_Pot))%>% 
    mutate(Valor_ST_ch= Valor_ST- lag(Valor_ST))%>% 
    select(type, date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch) %>%
    filter(date==input$date)  %>% 
    arrange(desc(Valor_New_ch))%>% mutate_if(is.numeric, round, 2)  %>% 
    rename(Product = type, Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch) 
  
  
  else if (input$unit=="MoM Rel Change")
  bankall %>% filter(pop==input$population) %>% 
    group_by(type, date) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST), funs(sum)) %>%
    mutate_at(vars(Valor_Glob: Valor_ST), funs(./ 1000000)) %>% 
    arrange(type, date) %>%
    mutate(Valor_Glob_ch= 100*(Valor_Glob- lag(Valor_Glob))/lag(Valor_Glob))%>% 
    mutate(Valor_Eff_ch= 100*(Valor_Eff- lag(Valor_Eff))/lag(Valor_Eff))%>% 
    mutate(Valor_New_ch= 100*(Valor_New- lag(Valor_New))/lag(Valor_New))%>% 
    mutate(Valor_Vencido_ch= 100*(Valor_Vencido- lag(Valor_Vencido))/lag(Valor_Vencido))%>% 
    mutate(Valor_Pot_ch= 100*(Valor_Pot- lag(Valor_Pot))/lag(Valor_Pot))%>% 
    mutate(Valor_ST_ch= 100*(Valor_ST- lag(Valor_ST))/lag(Valor_ST))%>% 
    select(type, date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch) %>%
    filter(date==input$date)  %>% 
    arrange(desc(Valor_New_ch))%>% mutate_if(is.numeric, round, 2)  %>% 
    rename(Product = type, Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch) 
  
  
  else if (input$unit=="YoY Abs Change")
  bankall %>% filter(pop==input$population) %>% 
    group_by(type, date) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST), funs(sum)) %>%
    mutate_at(vars(Valor_Glob: Valor_ST), funs(./ 1000000)) %>% 
    arrange(type, date) %>%
    mutate(Valor_Glob_ch= Valor_Glob- lag(Valor_Glob, 12))%>% 
    mutate(Valor_Eff_ch= Valor_Eff- lag(Valor_Eff, 12))%>% 
    mutate(Valor_New_ch= Valor_New- lag(Valor_New, 12))%>% 
    mutate(Valor_Vencido_ch= Valor_Vencido- lag(Valor_Vencido, 12))%>% 
    mutate(Valor_Pot_ch= Valor_Pot- lag(Valor_Pot, 12))%>% 
    mutate(Valor_ST_ch= Valor_ST- lag(Valor_ST, 12))%>% 
    select(type, date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch) %>%
    filter(date==input$date)  %>% 
    arrange(desc(Valor_New_ch))%>% mutate_if(is.numeric, round, 2)  %>% 
    rename(Product = type, Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch) 
  
  
  else if (input$unit=="YoY Rel Change")
  bankall %>% filter(pop==input$population) %>% 
    group_by(type, date) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST), funs(sum)) %>%
    mutate_at(vars(Valor_Glob: Valor_ST), funs(./ 1000000)) %>% 
    arrange(type, date) %>%
    mutate(Valor_Glob_ch= 100*(Valor_Glob- lag(Valor_Glob, 12))/lag(Valor_Glob, 12))%>% 
    mutate(Valor_Eff_ch= 100*(Valor_Eff- lag(Valor_Eff, 12))/lag(Valor_Eff, 12))%>% 
    mutate(Valor_New_ch= 100*(Valor_New- lag(Valor_New, 12))/lag(Valor_New, 12))%>% 
    mutate(Valor_Vencido_ch= 100*(Valor_Vencido- lag(Valor_Vencido, 12))/lag(Valor_Vencido, 12))%>% 
    mutate(Valor_Pot_ch= 100*(Valor_Pot- lag(Valor_Pot, 12))/lag(Valor_Pot, 12))%>% 
    mutate(Valor_ST_ch= 100*(Valor_ST- lag(Valor_ST, 12))/lag(Valor_ST, 12))%>% 
    select(type, date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch) %>%
    filter(date==input$date)  %>% 
    arrange(desc(Valor_New_ch))%>% mutate_if(is.numeric, round, 2)  %>% 
    rename(Product = type, Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch)
    
})

renderPlotly({
  
  if  (input$unit=="Level")  
  myytitle = "Amount (million euros)"
  else if  (input$unit=="MoM Abs Change")  
  myytitle = "Monthly Amount Change (million euros)"
  else if  (input$unit=="MoM Rel Change")  
  myytitle = "Monthly Percentage Change (%)"
  else if  (input$unit=="YoY Abs Change")  
  myytitle = "Yearly Amount Change (million euros)"
  else if  (input$unit=="YoY Rel Change")  
  myytitle = "Yearly Percentage Change (%)"
  
  datasetop2 <- datasetop() %>% head(10)

  p <- ggplot(data=datasetop2, aes(x= reorder(Product, New),New)) + 
    geom_bar(stat="identity", fill="darkolivegreen3") + 
    coord_flip() +
    theme_minimal() + ggtitle("Top Product") + labs(x="Financial product", y = myytitle)
  
  ggplotly(p)
}) 
```  

### Overdue Credit

```{r}
datasetopo <- reactive({ 
  if (input$unit=="Level")
    bankall %>% filter(date==input$date) %>% filter(pop==input$population) %>% 
    group_by(type) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST), funs(sum)) %>%
    mutate_at(vars(Valor_Glob: Valor_ST), funs(./ 1000000))  %>% 
    arrange(desc(Valor_Vencido))%>% mutate_if(is.numeric, round, 2)  %>% 
    rename(Product = type, Global = Valor_Glob, Effective = Valor_Eff, New = Valor_New, Overdue = Valor_Vencido, Potential = Valor_Pot, Short = Valor_ST)
  
  else if (input$unit=="MoM Abs Change")
    bankall %>% filter(pop==input$population) %>% 
    group_by(type, date) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST), funs(sum)) %>%
    mutate_at(vars(Valor_Glob: Valor_ST), funs(./ 1000000)) %>% 
    arrange(type, date) %>%
    mutate(Valor_Glob_ch= Valor_Glob- lag(Valor_Glob))%>% 
    mutate(Valor_Eff_ch= Valor_Eff- lag(Valor_Eff))%>% 
    mutate(Valor_New_ch= Valor_New- lag(Valor_New))%>% 
    mutate(Valor_Vencido_ch= Valor_Vencido- lag(Valor_Vencido))%>% 
    mutate(Valor_Pot_ch= Valor_Pot- lag(Valor_Pot))%>% 
    mutate(Valor_ST_ch= Valor_ST- lag(Valor_ST))%>% 
    select(type, date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch) %>%
    filter(date==input$date)  %>% 
    arrange(desc(Valor_Vencido_ch))%>% mutate_if(is.numeric, round, 2)  %>% 
    rename(Product = type, Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch)
  
  else if (input$unit=="MoM Rel Change")
  bankall %>% filter(pop==input$population) %>% 
    group_by(type, date) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST), funs(sum)) %>%
    mutate_at(vars(Valor_Glob: Valor_ST), funs(./ 1000000)) %>% 
    arrange(type, date) %>%
    mutate(Valor_Glob_ch= 100*(Valor_Glob- lag(Valor_Glob))/lag(Valor_Glob))%>% 
    mutate(Valor_Eff_ch= 100*(Valor_Eff- lag(Valor_Eff))/lag(Valor_Eff))%>% 
    mutate(Valor_New_ch= 100*(Valor_New- lag(Valor_New))/lag(Valor_New))%>% 
    mutate(Valor_Vencido_ch= 100*(Valor_Vencido- lag(Valor_Vencido))/lag(Valor_Vencido))%>% 
    mutate(Valor_Pot_ch= 100*(Valor_Pot- lag(Valor_Pot))/lag(Valor_Pot))%>% 
    mutate(Valor_ST_ch= 100*(Valor_ST- lag(Valor_ST))/lag(Valor_ST))%>% 
    select(type, date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch) %>%
    filter(date==input$date)  %>% 
    arrange(desc(Valor_Vencido_ch))%>% mutate_if(is.numeric, round, 2)  %>% 
    rename(Product = type, Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch) 
  
  
  else if (input$unit=="YoY Abs Change")
    bankall %>% filter(pop==input$population) %>% 
    group_by(type, date) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST), funs(sum)) %>%
    mutate_at(vars(Valor_Glob: Valor_ST), funs(./ 1000000)) %>% 
    arrange(type, date) %>%
    mutate(Valor_Glob_ch= Valor_Glob- lag(Valor_Glob, 12))%>% 
    mutate(Valor_Eff_ch= Valor_Eff- lag(Valor_Eff, 12))%>% 
    mutate(Valor_New_ch= Valor_New- lag(Valor_New, 12))%>% 
    mutate(Valor_Vencido_ch= Valor_Vencido- lag(Valor_Vencido, 12))%>% 
    mutate(Valor_Pot_ch= Valor_Pot- lag(Valor_Pot, 12))%>% 
    mutate(Valor_ST_ch= Valor_ST- lag(Valor_ST, 12))%>% 
    select(type, date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch) %>%
    filter(date==input$date)  %>% 
    arrange(desc(Valor_Vencido_ch))%>% mutate_if(is.numeric, round, 2)  %>% 
    rename(Product = type, Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch)
  
  else if (input$unit=="YoY Rel Change")
  bankall %>% filter(pop==input$population) %>% 
    group_by(type, date) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST), funs(sum)) %>%
    mutate_at(vars(Valor_Glob: Valor_ST), funs(./ 1000000)) %>% 
    arrange(type, date) %>%
    mutate(Valor_Glob_ch= 100*(Valor_Glob- lag(Valor_Glob, 12))/lag(Valor_Glob, 12))%>% 
    mutate(Valor_Eff_ch= 100*(Valor_Eff- lag(Valor_Eff, 12))/lag(Valor_Eff, 12))%>% 
    mutate(Valor_New_ch= 100*(Valor_New- lag(Valor_New, 12))/lag(Valor_New, 12))%>% 
    mutate(Valor_Vencido_ch= 100*(Valor_Vencido- lag(Valor_Vencido, 12))/lag(Valor_Vencido, 12))%>% 
    mutate(Valor_Pot_ch= 100*(Valor_Pot- lag(Valor_Pot, 12))/lag(Valor_Pot, 12))%>% 
    mutate(Valor_ST_ch= 100*(Valor_ST- lag(Valor_ST, 12))/lag(Valor_ST, 12))%>% 
    select(type, date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch) %>%
    filter(date==input$date)  %>% 
    arrange(desc(Valor_Vencido_ch))%>% mutate_if(is.numeric, round, 2)  %>% 
    rename(Product = type, Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch) 
  
})

renderPlotly({
  
  if  (input$unit=="Level")  
  myytitle = "Amount (million euros)"
  else if  (input$unit=="MoM Abs Change")  
  myytitle = "Monthly Amount Change (million euros)"
  else if  (input$unit=="MoM Rel Change")  
  myytitle = "Monthly Percentage Change (%)"
  else if  (input$unit=="YoY Abs Change")  
  myytitle = "Yearly Amount Change (million euros)"
  else if  (input$unit=="YoY Rel Change")  
  myytitle = "Yearly Percentage Change (%)"
  
  datasetopo2 <- datasetopo() %>% head(10)
  
  p <- ggplot(data=datasetopo2, aes(x= reorder(Product, Overdue),Overdue)) + 
    geom_bar(stat="identity", fill="darkorange1") + 
    coord_flip() +
    theme_minimal() + ggtitle("Top Product") + labs(x="Financial product", y = myytitle)
  
  ggplotly(p)
}) 
```  


### Written-Off Credit

```{r}
datasetopw <- reactive({ 
  if (input$unit=="Level")
    bankall %>% filter(date==input$date) %>% filter(pop==input$population) %>% 
    group_by(type) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST, Valor_AbAtv), funs(sum)) %>%
    mutate_at(vars(Valor_Glob: Valor_AbAtv), funs(./ 1000000))  %>% 
    arrange(desc(Valor_AbAtv)) %>% mutate_if(is.numeric, round, 2)  %>% 
    rename(Product = type, Global = Valor_Glob, Effective = Valor_Eff, New = Valor_New, Overdue = Valor_Vencido, Potential = Valor_Pot, Short = Valor_ST, Writeoff = Valor_AbAtv)
  
  else if (input$unit=="MoM Abs Change")
    bankall %>% filter(pop==input$population) %>% 
    group_by(type, date) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST, Valor_AbAtv), funs(sum)) %>%
    mutate_at(vars(Valor_Glob: Valor_AbAtv), funs(./ 1000000)) %>% 
    arrange(type, date) %>%
    mutate(Valor_Glob_ch= Valor_Glob- lag(Valor_Glob))%>% 
    mutate(Valor_Eff_ch= Valor_Eff- lag(Valor_Eff))%>% 
    mutate(Valor_New_ch= Valor_New- lag(Valor_New))%>% 
    mutate(Valor_Vencido_ch= Valor_Vencido- lag(Valor_Vencido))%>% 
    mutate(Valor_Pot_ch= Valor_Pot- lag(Valor_Pot))%>% 
    mutate(Valor_ST_ch= Valor_ST- lag(Valor_ST))%>% 
    mutate(Valor_AbAtv_ch= Valor_AbAtv- lag(Valor_AbAtv))%>% 
    select(type, date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch, Valor_AbAtv_ch) %>%
    filter(date==input$date)  %>% 
    arrange(desc(Valor_AbAtv_ch))%>% mutate_if(is.numeric, round, 2)  %>% 
    rename(Product = type, Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch, Writeoff = Valor_AbAtv_ch)
  
  else if (input$unit=="MoM Rel Change")
  bankall %>% filter(pop==input$population) %>% 
    group_by(type, date) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST,Valor_AbAtv), funs(sum)) %>%
    mutate_at(vars(Valor_Glob: Valor_AbAtv), funs(./ 1000000)) %>% 
    arrange(type, date) %>%
    mutate(Valor_Glob_ch= 100*(Valor_Glob- lag(Valor_Glob))/lag(Valor_Glob)) %>% 
    mutate(Valor_Eff_ch= 100*(Valor_Eff- lag(Valor_Eff))/lag(Valor_Eff)) %>% 
    mutate(Valor_New_ch= 100*(Valor_New- lag(Valor_New))/lag(Valor_New)) %>% 
    mutate(Valor_Vencido_ch= 100*(Valor_Vencido- lag(Valor_Vencido))/lag(Valor_Vencido)) %>% 
    mutate(Valor_Pot_ch= 100*(Valor_Pot- lag(Valor_Pot))/lag(Valor_Pot)) %>% 
    mutate(Valor_ST_ch= 100*(Valor_ST- lag(Valor_ST))/lag(Valor_ST)) %>% 
    mutate(Valor_AbAtv_ch= 100*(Valor_AbAtv- lag(Valor_AbAtv))/lag(Valor_AbAtv)) %>% 
    select(type, date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch,Valor_AbAtv_ch) %>%
    filter(date==input$date)  %>% 
    arrange(desc(Valor_AbAtv_ch))%>% mutate_if(is.numeric, round, 2)  %>% 
    rename(Product = type, Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch, Writeoff = Valor_AbAtv_ch)  
  
  
  else if (input$unit=="YoY Abs Change")
    bankall %>% filter(pop==input$population) %>% 
    group_by(type, date) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST, Valor_AbAtv), funs(sum)) %>%
    mutate_at(vars(Valor_Glob: Valor_AbAtv), funs(./ 1000000)) %>% 
    arrange(type, date) %>%
    mutate(Valor_Glob_ch= Valor_Glob- lag(Valor_Glob, 12)) %>% 
    mutate(Valor_Eff_ch= Valor_Eff- lag(Valor_Eff, 12)) %>% 
    mutate(Valor_New_ch= Valor_New- lag(Valor_New, 12)) %>% 
    mutate(Valor_Vencido_ch= Valor_Vencido- lag(Valor_Vencido, 12)) %>% 
    mutate(Valor_Pot_ch= Valor_Pot- lag(Valor_Pot, 12)) %>% 
    mutate(Valor_ST_ch= Valor_ST- lag(Valor_ST, 12)) %>% 
    mutate(Valor_AbAtv_ch= Valor_AbAtv- lag(Valor_AbAtv, 12)) %>% 
    select(type, date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch, Valor_AbAtv_ch) %>%
    filter(date==input$date)  %>% 
    arrange(desc(Valor_AbAtv_ch))%>% mutate_if(is.numeric, round, 2)  %>% 
    rename(Product = type, Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch, Writeoff = Valor_AbAtv_ch)
  
  else if (input$unit=="YoY Rel Change")
  bankall %>% filter(pop==input$population) %>% 
    group_by(type, date) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST,Valor_AbAtv), funs(sum)) %>%
    mutate_at(vars(Valor_Glob: Valor_AbAtv), funs(./ 1000000)) %>% 
    arrange(type, date) %>%
    mutate(Valor_Glob_ch= 100*(Valor_Glob- lag(Valor_Glob, 12))/lag(Valor_Glob, 12)) %>% 
    mutate(Valor_Eff_ch= 100*(Valor_Eff- lag(Valor_Eff, 12))/lag(Valor_Eff, 12)) %>% 
    mutate(Valor_New_ch= 100*(Valor_New- lag(Valor_New, 12))/lag(Valor_New, 12)) %>% 
    mutate(Valor_Vencido_ch= 100*(Valor_Vencido- lag(Valor_Vencido, 12))/lag(Valor_Vencido, 12)) %>% 
    mutate(Valor_Pot_ch= 100*(Valor_Pot- lag(Valor_Pot, 12))/lag(Valor_Pot, 12)) %>% 
    mutate(Valor_ST_ch= 100*(Valor_ST- lag(Valor_ST, 12))/lag(Valor_ST, 12)) %>% 
    mutate(Valor_AbAtv_ch= 100*(Valor_AbAtv- lag(Valor_AbAtv, 12))/lag(Valor_AbAtv, 12)) %>% 
    select(type, date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch,Valor_AbAtv_ch) %>%
    filter(date==input$date)  %>% 
    arrange(desc(Valor_AbAtv_ch))%>% mutate_if(is.numeric, round, 2)  %>% 
    rename(Product = type, Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch, Writeoff = Valor_AbAtv_ch)  
})

renderPlotly({
  
  if  (input$unit=="Level")  
  myytitle = "Amount (million euros)"
  else if  (input$unit=="MoM Abs Change")  
  myytitle = "Monthly Amount Change (million euros)"
  else if  (input$unit=="MoM Rel Change")  
  myytitle = "Monthly Percentage Change (%)"
  else if  (input$unit=="YoY Abs Change")  
  myytitle = "Yearly Amount Change (million euros)"
  else if  (input$unit=="YoY Rel Change")  
  myytitle = "Yearly Percentage Change (%)"
  
  datasetopw2 <- datasetopw() %>% head(10)
  
  p <- ggplot(data=datasetopw2, aes(x= reorder(Product, Writeoff),Writeoff)) + 
    geom_bar(stat="identity", fill="lightcoral") + 
    coord_flip() +
    theme_minimal() + ggtitle("Top Product") + labs(x="Financial product", y = myytitle)
  
  ggplotly(p)
}) 
```  



Credit Evolution
=======================================================================


<p style="font-family: times, serif; font-size:15pt; font-style:italic">
    <mark>**Attention!**</mark> **The following filters need to be selected: Population, Mode, Bank, and Product .** 
</p>

```{r}
useShinyjs(rmd = TRUE)
actionButton("reset1", "Reset",
    icon("sliders"), 
    style="color: #fff; background-color: #71afe3; border-radius: 0%; border-color: #71afe3; padding:8px; font-size:100%; width:70px")

observeEvent(input$reset1, {
 shinyjs::reset("population")
 shinyjs::reset("unit")
 shinyjs::reset("bank")
 shinyjs::reset("prod")
})
```

```{r}
renderText({
  paste("Your Choice: Population = ", input$population, ", Mode = ", input$unit, ", Bank = ", input$bank, ", Product = ", input$prod) 
})

renderText({
  paste(" ") 
  
})
```

Row  {.tabset}
----------------------------------------------------------------------

```{r}   
mysample <- reactive({ 
  if (input$unit=="Level" & input$bank=="All" & input$prod=="All")
    bankall  %>% filter(pop==input$population) %>% 
    group_by(date) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST, Valor_AbAtv), funs(sum)) %>%
    mutate_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST, Valor_AbAtv), funs(./ 1000000)) %>%
    rename(Global = Valor_Glob, Effective = Valor_Eff, New = Valor_New, Overdue = Valor_Vencido, Potential = Valor_Pot, Short = Valor_ST, Writtenoff = Valor_AbAtv)
  
  else if (input$unit=="MoM Abs Change" & input$bank=="All" & input$prod=="All")
    bankall  %>% filter(pop==input$population) %>% 
    group_by(date) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST, Valor_AbAtv), funs(sum)) %>%
    mutate_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST, Valor_AbAtv), funs(./ 1000000)) %>%
    arrange(date) %>%
    mutate(Valor_Glob_ch= Valor_Glob- lag(Valor_Glob))%>% 
    mutate(Valor_Eff_ch= Valor_Eff- lag(Valor_Eff))%>% 
    mutate(Valor_New_ch= Valor_New- lag(Valor_New))%>% 
    mutate(Valor_Vencido_ch= Valor_Vencido- lag(Valor_Vencido))%>% 
    mutate(Valor_Pot_ch= Valor_Pot- lag(Valor_Pot))%>% 
    mutate(Valor_ST_ch= Valor_ST- lag(Valor_ST))%>%  
    mutate(Valor_AbAtv_ch= Valor_AbAtv- lag(Valor_AbAtv))%>%
    filter(date!="2018-09-30") %>% 
    select(date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch, Valor_AbAtv_ch) %>%
    rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch, Writtenoff = Valor_AbAtv_ch)
  
  else if (input$unit=="MoM Rel Change" & input$bank=="All" & input$prod=="All")
    bankall  %>% filter(pop==input$population) %>% 
    group_by(date) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST, Valor_AbAtv), funs(sum)) %>%
    mutate_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST, Valor_AbAtv), funs(./ 1000000)) %>%
    arrange(date) %>%
    mutate(Valor_Glob_ch= 100*(Valor_Glob- lag(Valor_Glob))/lag(Valor_Glob))%>% 
    mutate(Valor_Eff_ch= 100*(Valor_Eff- lag(Valor_Eff))/lag(Valor_Eff))%>% 
    mutate(Valor_New_ch= 100*(Valor_New- lag(Valor_New))/lag(Valor_New))%>% 
    mutate(Valor_Vencido_ch= 100*(Valor_Vencido- lag(Valor_Vencido))/lag(Valor_Vencido))%>% 
    mutate(Valor_Pot_ch= 100*(Valor_Pot- lag(Valor_Pot))/lag(Valor_Pot))%>% 
    mutate(Valor_ST_ch= 100*(Valor_ST- lag(Valor_ST))/lag(Valor_ST))%>%  
    mutate(Valor_AbAtv_ch= 100*(Valor_AbAtv- lag(Valor_AbAtv))/lag(Valor_AbAtv))%>%
    filter(date!="2018-09-30") %>% 
    select(date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch, Valor_AbAtv_ch) %>%
    rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch, Writtenoff = Valor_AbAtv_ch)
  
  else if (input$unit=="Level" & input$bank=="All" & input$prod!="All")
    bankall  %>% filter(pop==input$population) %>% 
    group_by(type, date) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST, Valor_AbAtv), funs(sum)) %>%
    mutate_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST, Valor_AbAtv), funs(./ 1000000)) %>%
    rename(Global = Valor_Glob, Effective = Valor_Eff, New = Valor_New, Overdue = Valor_Vencido, Potential = Valor_Pot, Short = Valor_ST, Writtenoff = Valor_AbAtv) %>% 
    filter(type==input$prod) %>%
    ungroup() %>%
    select(-type)

  else if (input$unit=="MoM Abs Change" & input$bank=="All" & input$prod!="All")
    bankall  %>% filter(pop==input$population) %>% 
    group_by(type, date) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST, Valor_AbAtv), funs(sum)) %>%
    mutate_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST, Valor_AbAtv), funs(./ 1000000)) %>%
    arrange(type, date) %>%
    mutate(Valor_Glob_ch= Valor_Glob- lag(Valor_Glob))%>% 
    mutate(Valor_Eff_ch= Valor_Eff- lag(Valor_Eff))%>% 
    mutate(Valor_New_ch= Valor_New- lag(Valor_New))%>% 
    mutate(Valor_Vencido_ch= Valor_Vencido- lag(Valor_Vencido))%>% 
    mutate(Valor_Pot_ch= Valor_Pot- lag(Valor_Pot))%>% 
    mutate(Valor_ST_ch= Valor_ST- lag(Valor_ST))%>%  
    mutate(Valor_AbAtv_ch= Valor_AbAtv- lag(Valor_AbAtv))%>%
    filter(date!="2018-09-30") %>% 
    select(type, date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch, Valor_AbAtv_ch) %>%
    rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch, Writtenoff = Valor_AbAtv_ch) %>%
    filter(type==input$prod) %>% 
    ungroup() %>% 
    select(-type) 
  
  else if (input$unit=="MoM Rel Change" & input$bank=="All" & input$prod!="All")
    bankall  %>% filter(pop==input$population) %>% 
    group_by(type, date) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST, Valor_AbAtv), funs(sum)) %>%
    mutate_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST, Valor_AbAtv), funs(./ 1000000)) %>%
    arrange(type, date) %>%
    mutate(Valor_Glob_ch= 100*(Valor_Glob- lag(Valor_Glob))/lag(Valor_Glob))%>% 
    mutate(Valor_Eff_ch= 100*(Valor_Eff- lag(Valor_Eff))/lag(Valor_Eff))%>% 
    mutate(Valor_New_ch= 100*(Valor_New- lag(Valor_New))/lag(Valor_New))%>% 
    mutate(Valor_Vencido_ch= 100*(Valor_Vencido- lag(Valor_Vencido))/lag(Valor_Vencido))%>% 
    mutate(Valor_Pot_ch= 100*(Valor_Pot- lag(Valor_Pot))/lag(Valor_Pot))%>% 
    mutate(Valor_ST_ch= 100*(Valor_ST- lag(Valor_ST))/lag(Valor_ST))%>%  
    mutate(Valor_AbAtv_ch= 100*(Valor_AbAtv- lag(Valor_AbAtv))/lag(Valor_AbAtv))%>%
    filter(date!="2018-09-30") %>% 
    select(type, date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch, Valor_AbAtv_ch) %>%
    rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch, Writtenoff = Valor_AbAtv_ch) %>%
    filter(type==input$prod) %>% 
    ungroup() %>% 
    select(-type) 

  else if (input$unit=="Level" & input$bank!="All" & input$prod=="All")
    bankall  %>% filter(pop==input$population) %>% 
    group_by(Bank, date) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST, Valor_AbAtv), funs(sum)) %>%
    mutate_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST, Valor_AbAtv), funs(./ 1000000)) %>%
    rename(Global = Valor_Glob, Effective = Valor_Eff, New = Valor_New, Overdue = Valor_Vencido, Potential = Valor_Pot, Short = Valor_ST, Writtenoff = Valor_AbAtv) %>%
    filter(Bank==input$bank) %>% 
    ungroup() %>%
    select(-Bank)
  
  else if (input$unit=="MoM Abs Change" & input$bank!="All" & input$prod=="All")
    bankall  %>% filter(pop==input$population) %>% 
    group_by(Bank, date) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST, Valor_AbAtv), funs(sum)) %>%
    mutate_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST, Valor_AbAtv), funs(./ 1000000)) %>%
    arrange(Bank, date) %>%
    mutate(Valor_Glob_ch= 100*(Valor_Glob- lag(Valor_Glob))/lag(Valor_Glob))%>% 
    mutate(Valor_Eff_ch= 100*(Valor_Eff- lag(Valor_Eff))/lag(Valor_Eff))%>% 
    mutate(Valor_New_ch= 100*(Valor_New- lag(Valor_New))/lag(Valor_New))%>% 
    mutate(Valor_Vencido_ch= 100*(Valor_Vencido- lag(Valor_Vencido))/lag(Valor_Vencido))%>% 
    mutate(Valor_Pot_ch= 100*(Valor_Pot- lag(Valor_Pot))/lag(Valor_Pot))%>% 
    mutate(Valor_ST_ch= 100*(Valor_ST- lag(Valor_ST))/lag(Valor_ST))%>%  
    mutate(Valor_AbAtv_ch= 100*(Valor_AbAtv- lag(Valor_AbAtv))/lag(Valor_AbAtv))%>%
    filter(date!="2018-09-30") %>% 
    select(Bank, date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch, Valor_AbAtv_ch) %>%
    rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch, Writtenoff = Valor_AbAtv_ch)  %>% 
    filter(Bank==input$bank) %>% 
    ungroup() %>% 
    select(-Bank)    
  
  else if (input$unit=="MoM Rel Change" & input$bank!="All" & input$prod=="All")
    bankall  %>% filter(pop==input$population) %>% 
    group_by(Bank, date) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST, Valor_AbAtv), funs(sum)) %>%
    mutate_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST, Valor_AbAtv), funs(./ 1000000)) %>%
    arrange(Bank, date) %>%
    mutate(Valor_Glob_ch= 100*(Valor_Glob- lag(Valor_Glob))/lag(Valor_Glob))%>% 
    mutate(Valor_Eff_ch= 100*(Valor_Eff- lag(Valor_Eff))/lag(Valor_Eff))%>% 
    mutate(Valor_New_ch= 100*(Valor_New- lag(Valor_New))/lag(Valor_New))%>% 
    mutate(Valor_Vencido_ch= 100*(Valor_Vencido- lag(Valor_Vencido))/lag(Valor_Vencido))%>% 
    mutate(Valor_Pot_ch= 100*(Valor_Pot- lag(Valor_Pot))/lag(Valor_Pot))%>% 
    mutate(Valor_ST_ch= 100*(Valor_ST- lag(Valor_ST))/lag(Valor_ST))%>%  
    mutate(Valor_AbAtv_ch= 100*(Valor_AbAtv- lag(Valor_AbAtv))/lag(Valor_AbAtv))%>%
    filter(date!="2018-09-30") %>% 
    select(Bank, date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch, Valor_AbAtv_ch) %>%
    rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch, Writtenoff = Valor_AbAtv_ch)  %>% 
    filter(Bank==input$bank) %>% 
    ungroup() %>% 
    select(-Bank)  
  
  
  else if (input$unit=="Level" & input$bank!="All" & input$prod!="All")
    bankall  %>% filter(pop==input$population) %>% 
    group_by(Bank, type, date) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST, Valor_AbAtv), funs(sum)) %>%
    mutate_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST, Valor_AbAtv), funs(./ 1000000)) %>%
    rename(Global = Valor_Glob, Effective = Valor_Eff, New = Valor_New, Overdue = Valor_Vencido, Potential = Valor_Pot, Short = Valor_ST, Writtenoff = Valor_AbAtv) %>% 
    filter(Bank==input$bank) %>% filter(type==input$prod) %>% 
    ungroup() %>%
    select(-Bank) %>%
    select(-type) 
  
  else if (input$unit=="MoM Abs Change" & input$bank!="All" & input$prod!="All")
    bankall  %>% filter(pop==input$population) %>% 
    group_by(Bank, type, date) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST, Valor_AbAtv), funs(sum)) %>%
    mutate_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST, Valor_AbAtv), funs(./ 1000000)) %>%
    arrange(Bank, type, date) %>%
    mutate(Valor_Glob_ch= Valor_Glob- lag(Valor_Glob))%>% 
    mutate(Valor_Eff_ch= Valor_Eff- lag(Valor_Eff))%>% 
    mutate(Valor_New_ch= Valor_New- lag(Valor_New))%>% 
    mutate(Valor_Vencido_ch= Valor_Vencido- lag(Valor_Vencido))%>% 
    mutate(Valor_Pot_ch= Valor_Pot- lag(Valor_Pot))%>% 
    mutate(Valor_ST_ch= Valor_ST- lag(Valor_ST))%>%  
    mutate(Valor_AbAtv_ch= Valor_AbAtv- lag(Valor_AbAtv))%>%
    filter(date!="2018-09-30") %>% 
    select(Bank, type, date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch, Valor_AbAtv_ch) %>%
    rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch, Writtenoff = Valor_AbAtv_ch) %>% 
    filter(Bank==input$bank) %>% filter(type==input$prod) %>%  
    ungroup() %>%  
    select(-Bank) %>% 
    select(-type) 
  
  else if (input$unit=="MoM Rel Change" & input$bank!="All" & input$prod!="All")
    bankall  %>% filter(pop==input$population) %>% 
    group_by(Bank, type, date) %>% 
    summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST, Valor_AbAtv), funs(sum)) %>%
    mutate_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST, Valor_AbAtv), funs(./ 1000000)) %>%
    arrange(Bank, type, date) %>%
    mutate(Valor_Glob_ch= 100*(Valor_Glob- lag(Valor_Glob))/lag(Valor_Glob))%>% 
    mutate(Valor_Eff_ch= 100*(Valor_Eff- lag(Valor_Eff))/lag(Valor_Eff))%>% 
    mutate(Valor_New_ch= 100*(Valor_New- lag(Valor_New))/lag(Valor_New))%>% 
    mutate(Valor_Vencido_ch= 100*(Valor_Vencido- lag(Valor_Vencido))/lag(Valor_Vencido))%>% 
    mutate(Valor_Pot_ch= 100*(Valor_Pot- lag(Valor_Pot))/lag(Valor_Pot))%>% 
    mutate(Valor_ST_ch= 100*(Valor_ST- lag(Valor_ST))/lag(Valor_ST))%>%  
    mutate(Valor_AbAtv_ch= 100*(Valor_AbAtv- lag(Valor_AbAtv))/lag(Valor_AbAtv))%>%
    filter(date!="2018-09-30") %>% 
    select(Bank, type, date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch, Valor_AbAtv_ch) %>%
    rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch, Writtenoff = Valor_AbAtv_ch) %>% 
    filter(Bank==input$bank) %>% filter(type==input$prod) %>%  
    ungroup() %>%  
    select(-Bank) %>% 
    select(-type)   
  
  
else if (input$unit=="YoY Abs Change" & input$bank=="All" & input$prod=="All")
  bankall  %>% filter(pop==input$population) %>% 
  group_by(date) %>% 
  summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST, Valor_AbAtv), funs(sum)) %>%
  mutate_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST, Valor_AbAtv), funs(./ 1000000)) %>%
  arrange(date) %>%
  mutate(Valor_Glob_ch= Valor_Glob- lag(Valor_Glob, 12))%>% 
  mutate(Valor_Eff_ch= Valor_Eff- lag(Valor_Eff, 12))%>% 
  mutate(Valor_New_ch= Valor_New- lag(Valor_New, 12))%>% 
  mutate(Valor_Vencido_ch= Valor_Vencido- lag(Valor_Vencido, 12))%>% 
  mutate(Valor_Pot_ch= Valor_Pot- lag(Valor_Pot, 12))%>% 
  mutate(Valor_ST_ch= Valor_ST- lag(Valor_ST, 12))%>%  
  mutate(Valor_AbAtv_ch= Valor_AbAtv- lag(Valor_AbAtv, 12))%>%
  filter(date>="2019-09-30") %>%
  select(date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch, Valor_AbAtv_ch) %>%
  rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch, Writtenoff = Valor_AbAtv_ch)

else if (input$unit=="YoY Rel Change" & input$bank=="All" & input$prod=="All")
  bankall  %>% filter(pop==input$population) %>% 
  group_by(date) %>% 
  summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST, Valor_AbAtv), funs(sum)) %>%
  mutate_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST, Valor_AbAtv), funs(./ 1000000)) %>%
  arrange(date) %>%
  mutate(Valor_Glob_ch= 100*(Valor_Glob- lag(Valor_Glob, 12))/lag(Valor_Glob, 12))%>% 
  mutate(Valor_Eff_ch= 100*(Valor_Eff- lag(Valor_Eff, 12))/lag(Valor_Eff, 12))%>% 
  mutate(Valor_New_ch= 100*(Valor_New- lag(Valor_New, 12))/lag(Valor_New, 12))%>% 
  mutate(Valor_Vencido_ch= 100*(Valor_Vencido- lag(Valor_Vencido, 12))/lag(Valor_Vencido, 12))%>% 
  mutate(Valor_Pot_ch= 100*(Valor_Pot- lag(Valor_Pot, 12))/lag(Valor_Pot, 12))%>% 
  mutate(Valor_ST_ch= 100*(Valor_ST- lag(Valor_ST, 12))/lag(Valor_ST, 12))%>%  
  mutate(Valor_AbAtv_ch= 100*(Valor_AbAtv- lag(Valor_AbAtv, 12))/lag(Valor_AbAtv, 12))%>%
  filter(date>="2019-09-30") %>%
  select(date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch, Valor_AbAtv_ch) %>%
  rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch, Writtenoff = Valor_AbAtv_ch)


else if (input$unit=="YoY Abs Change" & input$bank=="All" & input$prod!="All")
  bankall  %>% filter(pop==input$population) %>% 
  group_by(type, date) %>% 
  summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST, Valor_AbAtv), funs(sum)) %>%
  mutate_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST, Valor_AbAtv), funs(./ 1000000)) %>%
  arrange(type, date) %>%
  mutate(Valor_Glob_ch= Valor_Glob- lag(Valor_Glob, 12))%>% 
  mutate(Valor_Eff_ch= Valor_Eff- lag(Valor_Eff, 12))%>% 
  mutate(Valor_New_ch= Valor_New- lag(Valor_New, 12))%>% 
  mutate(Valor_Vencido_ch= Valor_Vencido- lag(Valor_Vencido, 12))%>% 
  mutate(Valor_Pot_ch= Valor_Pot- lag(Valor_Pot, 12))%>% 
  mutate(Valor_ST_ch= Valor_ST- lag(Valor_ST, 12))%>%  
  mutate(Valor_AbAtv_ch= Valor_AbAtv- lag(Valor_AbAtv, 12))%>%
  filter(date>="2019-09-30") %>%
  select(type, date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch, Valor_AbAtv_ch) %>%
  rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch, Writtenoff = Valor_AbAtv_ch) %>%
  filter(type==input$prod) %>% 
  ungroup() %>% 
  select(-type) 

else if (input$unit=="YoY Rel Change" & input$bank=="All" & input$prod!="All")
  bankall  %>% filter(pop==input$population) %>% 
  group_by(type, date) %>% 
  summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST, Valor_AbAtv), funs(sum)) %>%
  mutate_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST, Valor_AbAtv), funs(./ 1000000)) %>%
  arrange(type, date) %>%
  mutate(Valor_Glob_ch= 100*(Valor_Glob- lag(Valor_Glob, 12))/lag(Valor_Glob, 12))%>% 
  mutate(Valor_Eff_ch= 100*(Valor_Eff- lag(Valor_Eff, 12))/lag(Valor_Eff, 12))%>% 
  mutate(Valor_New_ch= 100*(Valor_New- lag(Valor_New, 12))/lag(Valor_New, 12))%>% 
  mutate(Valor_Vencido_ch= 100*(Valor_Vencido- lag(Valor_Vencido, 12))/lag(Valor_Vencido, 12))%>% 
  mutate(Valor_Pot_ch= 100*(Valor_Pot- lag(Valor_Pot, 12))/lag(Valor_Pot, 12))%>% 
  mutate(Valor_ST_ch= 100*(Valor_ST- lag(Valor_ST, 12))/lag(Valor_ST, 12))%>%  
  mutate(Valor_AbAtv_ch= 100*(Valor_AbAtv- lag(Valor_AbAtv, 12))/lag(Valor_AbAtv, 12))%>%
  filter(date>="2019-09-30") %>%
  select(type, date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch, Valor_AbAtv_ch) %>%
  rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch, Writtenoff = Valor_AbAtv_ch) %>%
  filter(type==input$prod) %>% 
  ungroup() %>% 
  select(-type) 


else if (input$unit=="YoY Abs Change" & input$bank!="All" & input$prod=="All")
  bankall  %>% filter(pop==input$population) %>% 
  group_by(Bank, date) %>% 
  summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST, Valor_AbAtv), funs(sum)) %>%
  mutate_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST, Valor_AbAtv), funs(./ 1000000)) %>%
  arrange(Bank, date) %>%
  mutate(Valor_Glob_ch= 100*(Valor_Glob- lag(Valor_Glob, 12))/lag(Valor_Glob, 12))%>% 
  mutate(Valor_Eff_ch= 100*(Valor_Eff- lag(Valor_Eff, 12))/lag(Valor_Eff, 12))%>% 
  mutate(Valor_New_ch= 100*(Valor_New- lag(Valor_New, 12))/lag(Valor_New, 12))%>% 
  mutate(Valor_Vencido_ch= 100*(Valor_Vencido- lag(Valor_Vencido, 12))/lag(Valor_Vencido, 12))%>% 
  mutate(Valor_Pot_ch= 100*(Valor_Pot- lag(Valor_Pot, 12))/lag(Valor_Pot, 12))%>% 
  mutate(Valor_ST_ch= 100*(Valor_ST- lag(Valor_ST, 12))/lag(Valor_ST, 12))%>%  
  mutate(Valor_AbAtv_ch= 100*(Valor_AbAtv- lag(Valor_AbAtv, 12))/lag(Valor_AbAtv, 12))%>%
  filter(date>="2019-09-30") %>%
  select(Bank, date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch, Valor_AbAtv_ch) %>%
  rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch, Writtenoff = Valor_AbAtv_ch)  %>% 
  filter(Bank==input$bank) %>% 
  ungroup() %>% 
  select(-Bank)    

else if (input$unit=="YoY Rel Change" & input$bank!="All" & input$prod=="All")
  bankall  %>% filter(pop==input$population) %>% 
  group_by(Bank, date) %>% 
  summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST, Valor_AbAtv), funs(sum)) %>%
  mutate_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST, Valor_AbAtv), funs(./ 1000000)) %>%
  arrange(Bank, date) %>%
  mutate(Valor_Glob_ch= 100*(Valor_Glob- lag(Valor_Glob, 12))/lag(Valor_Glob, 12))%>% 
  mutate(Valor_Eff_ch= 100*(Valor_Eff- lag(Valor_Eff, 12))/lag(Valor_Eff, 12))%>% 
  mutate(Valor_New_ch= 100*(Valor_New- lag(Valor_New, 12))/lag(Valor_New, 12))%>% 
  mutate(Valor_Vencido_ch= 100*(Valor_Vencido- lag(Valor_Vencido, 12))/lag(Valor_Vencido, 12))%>% 
  mutate(Valor_Pot_ch= 100*(Valor_Pot- lag(Valor_Pot, 12))/lag(Valor_Pot, 12))%>% 
  mutate(Valor_ST_ch= 100*(Valor_ST- lag(Valor_ST, 12))/lag(Valor_ST, 12))%>%  
  mutate(Valor_AbAtv_ch= 100*(Valor_AbAtv- lag(Valor_AbAtv, 12))/lag(Valor_AbAtv, 12))%>%
  filter(date>="2019-09-30") %>%
  select(Bank, date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch, Valor_AbAtv_ch) %>%
  rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch, Writtenoff = Valor_AbAtv_ch)  %>% 
  filter(Bank==input$bank) %>% 
  ungroup() %>% 
  select(-Bank)  

else if (input$unit=="YoY Abs Change" & input$bank!="All" & input$prod!="All")
  bankall  %>% filter(pop==input$population) %>% 
  group_by(Bank, type, date) %>% 
  summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST, Valor_AbAtv), funs(sum)) %>%
  mutate_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST, Valor_AbAtv), funs(./ 1000000)) %>%
  arrange(Bank, type, date) %>%
  mutate(Valor_Glob_ch= Valor_Glob- lag(Valor_Glob, 12))%>% 
  mutate(Valor_Eff_ch= Valor_Eff- lag(Valor_Eff, 12))%>% 
  mutate(Valor_New_ch= Valor_New- lag(Valor_New, 12))%>% 
  mutate(Valor_Vencido_ch= Valor_Vencido- lag(Valor_Vencido, 12))%>% 
  mutate(Valor_Pot_ch= Valor_Pot- lag(Valor_Pot, 12))%>% 
  mutate(Valor_ST_ch= Valor_ST- lag(Valor_ST, 12))%>%  
  mutate(Valor_AbAtv_ch= Valor_AbAtv- lag(Valor_AbAtv, 12))%>%
  filter(date>="2019-09-30") %>% 
  select(Bank, type, date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch, Valor_AbAtv_ch) %>%
  rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch, Writtenoff = Valor_AbAtv_ch) %>% 
  filter(Bank==input$bank) %>% filter(type==input$prod) %>%  
  ungroup() %>%  
  select(-Bank) %>% 
  select(-type) 

else if (input$unit=="YoY Rel Change" & input$bank!="All" & input$prod!="All")
  bankall  %>% filter(pop==input$population) %>% 
  group_by(Bank, type, date) %>% 
  summarise_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST, Valor_AbAtv), funs(sum)) %>%
  mutate_at(vars(Valor_Glob, Valor_Eff, Valor_New, Valor_Vencido, Valor_Pot, Valor_ST, Valor_AbAtv), funs(./ 1000000)) %>%
  arrange(Bank, type, date) %>%
  mutate(Valor_Glob_ch= 100*(Valor_Glob- lag(Valor_Glob, 12))/lag(Valor_Glob, 12))%>% 
  mutate(Valor_Eff_ch= 100*(Valor_Eff- lag(Valor_Eff, 12))/lag(Valor_Eff, 12))%>% 
  mutate(Valor_New_ch= 100*(Valor_New- lag(Valor_New, 12))/lag(Valor_New, 12))%>% 
  mutate(Valor_Vencido_ch= 100*(Valor_Vencido- lag(Valor_Vencido, 12))/lag(Valor_Vencido, 12))%>% 
  mutate(Valor_Pot_ch= 100*(Valor_Pot- lag(Valor_Pot, 12))/lag(Valor_Pot, 12))%>% 
  mutate(Valor_ST_ch= 100*(Valor_ST- lag(Valor_ST, 12))/lag(Valor_ST, 12))%>%  
  mutate(Valor_AbAtv_ch= 100*(Valor_AbAtv- lag(Valor_AbAtv, 12))/lag(Valor_AbAtv, 12))%>%
  filter(date>="2019-09-30") %>% 
  select(Bank, type, date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch, Valor_AbAtv_ch) %>%
  rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch, Writtenoff = Valor_AbAtv_ch) %>% 
  filter(Bank==input$bank) %>% filter(type==input$prod) %>%  
  ungroup() %>%  
  select(-Bank) %>% 
  select(-type)   
  

})


```


### Credit Composition

```{r}
renderDygraph({
  
  if  (input$unit=="Level")  
  mylabel = "Amount (million euros)"
  else if  (input$unit=="MoM Abs Change")  
  mylabel = "Monthly Amount Change (million euros)"
  else if  (input$unit=="MoM Rel Change")  
  mylabel = "Monthly Percentage Change (%)"
  else if  (input$unit=="YoY Abs Change")  
  mylabel = "Yearly Amount Change (million euros)"
  else if  (input$unit=="YoY Rel Change")  
  mylabel = "Yearly Percentage Change (%)"
  
  don <- xts(x = mysample()[,-1], order.by = mysample()$date)

# Finally the plot
  dygraph(don, main = "Credit Composition") %>%
    dyOptions(stackedGraph = TRUE) %>%
    dyRangeSelector(height = 20) %>%
    dyAxis("y", label = mylabel)
  
})

```


### Global Credit

```{r}
renderDygraph({
  
  if  (input$unit=="Level")  
  mylabel = "Amount (million euros)"
  else if  (input$unit=="MoM Abs Change")  
  mylabel = "Monthly Amount Change (million euros)"
  else if  (input$unit=="MoM Rel Change")  
  mylabel = "Monthly Percentage Change (%)"
  else if  (input$unit=="YoY Abs Change")  
  mylabel = "Yearly Amount Change (million euros)"
  else if  (input$unit=="YoY Rel Change")  
  mylabel = "Yearly Percentage Change (%)"
  
  don <- xts(x = mysample()$Global, order.by = mysample()$date)
  
  # Finally the plot
  dygraph(don, main = "Global Credit") %>%
    dySeries("V1", label = "Global Credit") %>%
    dyOptions(stackedGraph = TRUE) %>%
    dyRangeSelector(height = 20) %>%
    dyAxis("y", label = mylabel)
})
```


### New Credit

```{r}
renderDygraph({
  
  if  (input$unit=="Level")  
  mylabel = "Amount (million euros)"
  else if  (input$unit=="MoM Abs Change")  
  mylabel = "Monthly Amount Change (million euros)"
  else if  (input$unit=="MoM Rel Change")  
  mylabel = "Monthly Percentage Change (%)"
  else if  (input$unit=="YoY Abs Change")  
  mylabel = "Yearly Amount Change (million euros)"
  else if  (input$unit=="YoY Rel Change")  
  mylabel = "Yearly Percentage Change (%)"
  
  don <- xts(x = mysample()$New, order.by = mysample()$date)
  
  # Finally the plot
  dygraph(don, main = "New Credit") %>%
    dySeries("V1", label = "New Credit") %>%
    dyOptions(stackedGraph = TRUE) %>%
    dyRangeSelector(height = 20) %>%
    dyAxis("y", label = mylabel)
})
```


### Overdue Credit

```{r}
renderDygraph({
  
  if  (input$unit=="Level")  
  mylabel = "Amount (million euros)"
  else if  (input$unit=="MoM Abs Change")  
  mylabel = "Monthly Amount Change (million euros)"
  else if  (input$unit=="MoM Rel Change")  
  mylabel = "Monthly Percentage Change (%)"
  else if  (input$unit=="YoY Abs Change")  
  mylabel = "Yearly Amount Change (million euros)"
  else if  (input$unit=="YoY Rel Change")  
  mylabel = "Yearly Percentage Change (%)"
  
  don <- xts(x = mysample()$Overdue, order.by = mysample()$date)
  
  # Finally the plot
  dygraph(don, main = "Overdue Credit") %>%
    dySeries("V1", label = "Overdue Credit") %>%
    dyOptions(stackedGraph = TRUE) %>%
    dyRangeSelector(height = 20) %>%
    dyAxis("y", label = mylabel)
})
```

### Written-Off Credit


```{r}
renderDygraph({
  
  if  (input$unit=="Level")  
  mylabel = "Amount (million euros)"
  else if  (input$unit=="MoM Abs Change")  
  mylabel = "Monthly Amount Change (million euros)"
  else if  (input$unit=="MoM Rel Change")  
  mylabel = "Monthly Percentage Change (%)"
  else if  (input$unit=="YoY Abs Change")  
  mylabel = "Yearly Amount Change (million euros)"
  else if  (input$unit=="YoY Rel Change")  
  mylabel = "Yearly Percentage Change (%)"
  
  don <- xts(x = mysample()$Writtenoff, order.by = mysample()$date)
  
  # Finally the plot
  dygraph(don, main = "Written-Off Credit") %>%
    dySeries("V1", label = "Written-Off Credit") %>%
    dyOptions(stackedGraph = TRUE) %>%
    dyRangeSelector(height = 20) %>%
    dyAxis("y", label = mylabel)
})

```


### Effective Credit

```{r}
renderDygraph({
  
  if  (input$unit=="Level")  
  mylabel = "Amount (million euros)"
  else if  (input$unit=="MoM Abs Change")  
  mylabel = "Monthly Amount Change (million euros)"
  else if  (input$unit=="MoM Rel Change")  
  mylabel = "Monthly Percentage Change (%)"
  else if  (input$unit=="YoY Abs Change")  
  mylabel = "Yearly Amount Change (million euros)"
  else if  (input$unit=="YoY Rel Change")  
  mylabel = "Yearly Percentage Change (%)"
  
  don <- xts(x = mysample()$Effective, order.by = mysample()$date)
  
  # Finally the plot
  dygraph(don, main = "Effective Credit") %>%
    dySeries("V1", label = "Effective Credit") %>%
    dyOptions(stackedGraph = TRUE) %>%
    dyRangeSelector(height = 20) %>%
    dyAxis("y", label = mylabel)
})

```

### Potential Credit

```{r}
renderDygraph({
  
  if  (input$unit=="Level")  
  mylabel = "Amount (million euros)"
  else if  (input$unit=="MoM Abs Change")  
  mylabel = "Monthly Amount Change (million euros)"
  else if  (input$unit=="MoM Rel Change")  
  mylabel = "Monthly Percentage Change (%)"
  else if  (input$unit=="YoY Abs Change")  
  mylabel = "Yearly Amount Change (million euros)"
  else if  (input$unit=="YoY Rel Change")  
  mylabel = "Yearly Percentage Change (%)"
  
  don <- xts(x = mysample()$Potential, order.by = mysample()$date)
  
  # Finally the plot
  dygraph(don, main = "Potential Credit") %>%
    dySeries("V1", label = "Potential Credit") %>%
    dyOptions(stackedGraph = TRUE) %>%
    dyRangeSelector(height = 20) %>%
    dyAxis("y", label = mylabel)
})
```


### Short-Term Credit

```{r}
renderDygraph({
  
  if  (input$unit=="Level")  
  mylabel = "Amount (million euros)"
  else if  (input$unit=="MoM Abs Change")  
  mylabel = "Monthly Amount Change (million euros)"
  else if  (input$unit=="MoM Rel Change")  
  mylabel = "Monthly Percentage Change (%)"
  else if  (input$unit=="YoY Abs Change")  
  mylabel = "Yearly Amount Change (million euros)"
  else if  (input$unit=="YoY Rel Change")  
  mylabel = "Yearly Percentage Change (%)"
  
  don <- xts(x = mysample()$Short, order.by = mysample()$date)
  
  # Finally the plot
  dygraph(don, main = "Short-Term Credit") %>%
    dySeries("V1", label = "Short-Term Credit") %>%
    dyOptions(stackedGraph = TRUE) %>%
    dyRangeSelector(height = 20) %>%
    dyAxis("y", label = mylabel)
})
```


Bank and Product
=======================================================================

<p style="font-family: times, serif; font-size:15pt; font-style:italic">
    <mark>**Attention!**</mark> **The following filters need to be selected: Population, Mode, Bank, and Product.** 
</p>

```{r}
useShinyjs(rmd = TRUE)
actionButton("reset2", "Reset",
    icon("sliders"), 
    style="color: #fff; background-color: #71afe3; border-radius: 0%; border-color: #71afe3; padding:8px; font-size:100%; width:70px")

observeEvent(input$reset2, {
 shinyjs::reset("population")
 shinyjs::reset("unit")
 shinyjs::reset("bank")
 shinyjs::reset("prod")
})
```

```{r}
renderText({
  paste("Your Choice: Population = ", input$population, ", Mode = ", input$unit, ", Bank = ", input$bank, ", Product = ", input$prod) 
})

renderText({
  paste(" ") 
  
})
```


Row  {.tabset}
---------------------------------------------------------------------- 

```{r}   
mysamplep <- reactive({ 
  
  req(input$prod)    
  
  if (input$prod == "All") {
    filt2 <- quote(type != "@?><")
  } else {
    filt2 <- quote(type == input$prod)
  }
  
    bankall  %>% filter(pop==input$population) %>% 
    filter_(filt2) %>% 
    mutate_at(vars(Valor_Glob: Valor_ST), funs(./1000000)) %>%
    rename(Global = Valor_Glob, Effective = Valor_Eff, New = Valor_New, Overdue = Valor_Vencido, Potential = Valor_Pot, Short = Valor_ST, Writtenoff = Valor_AbAtv) %>%       
    group_by(date) %>% 
    summarise_at(vars(Global, Effective, New, Overdue, Potential, Short, Writtenoff), funs(sum)) %>%  
    mutate_if(is.numeric, round, 2) 
  
})


mysamplebp <- reactive({ 
  
  if (input$unit=="Level")
    mysamplep()  %>%  
    mutate_if(is.numeric, round, 2)
  
  else if (input$unit=="MoM Abs Change")
    mysamplep() %>% 
    arrange(date) %>%
    mutate(Valor_Glob_ch= Global- lag(Global))%>% 
    mutate(Valor_Eff_ch= Effective- lag(Effective))%>% 
    mutate(Valor_New_ch= New- lag(New))%>% 
    mutate(Valor_Vencido_ch= Overdue- lag(Overdue))%>% 
    mutate(Valor_Pot_ch= Potential- lag(Potential))%>% 
    mutate(Valor_ST_ch= Short- lag(Short))%>%  
    mutate(Valor_AbAtv_ch= Writtenoff- lag(Writtenoff))%>%
    filter(date!="2018-09-30") %>% 
    select(date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch, Valor_AbAtv_ch) %>%
    rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch, Writtenoff = Valor_AbAtv_ch)
  
  else if (input$unit=="MoM Rel Change")
    mysamplep() %>% 
    arrange(date) %>%
    mutate(Valor_Glob_ch= 100*(Global- lag(Global))/lag(Global))%>% 
    mutate(Valor_Eff_ch= 100*(Effective- lag(Effective))/lag(Effective))%>% 
    mutate(Valor_New_ch= 100*(New- lag(New))/lag(New))%>% 
    mutate(Valor_Vencido_ch= 100*(Overdue- lag(Overdue))/lag(Overdue))%>% 
    mutate(Valor_Pot_ch= 100*(Potential- lag(Potential))/lag(Potential))%>% 
    mutate(Valor_ST_ch= 100*(Short- lag(Short))/lag(Short))%>%  
    mutate(Valor_AbAtv_ch= 100*(Writtenoff- lag(Writtenoff))/lag(Writtenoff))%>%
    filter(date!="2018-09-30") %>% 
    select(date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch, Valor_AbAtv_ch) %>%
    rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch, Writtenoff = Valor_AbAtv_ch) 
  
  else if (input$unit=="YoY Abs Change")
    mysamplep() %>% 
    arrange(date) %>%
    mutate(Valor_Glob_ch= Global- lag(Global, 12))%>% 
    mutate(Valor_Eff_ch= Effective- lag(Effective, 12))%>% 
    mutate(Valor_New_ch= New- lag(New, 12))%>% 
    mutate(Valor_Vencido_ch= Overdue- lag(Overdue, 12))%>% 
    mutate(Valor_Pot_ch= Potential- lag(Potential, 12))%>% 
    mutate(Valor_ST_ch= Short- lag(Short, 12))%>%  
    mutate(Valor_AbAtv_ch= Writtenoff- lag(Writtenoff, 12))%>%
    filter(date>="2019-09-30") %>% 
    select(date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch, Valor_AbAtv_ch) %>%
    rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch, Writtenoff = Valor_AbAtv_ch)
  
  else if (input$unit=="YoY Rel Change")
    mysamplep() %>% 
    arrange(date) %>%
    mutate(Valor_Glob_ch= 100*(Global- lag(Global, 12))/lag(Global, 12))%>% 
    mutate(Valor_Eff_ch= 100*(Effective- lag(Effective, 12))/lag(Effective, 12))%>% 
    mutate(Valor_New_ch= 100*(New- lag(New, 12))/lag(New, 12))%>% 
    mutate(Valor_Vencido_ch= 100*(Overdue- lag(Overdue, 12))/lag(Overdue, 12))%>% 
    mutate(Valor_Pot_ch= 100*(Potential- lag(Potential, 12))/lag(Potential, 12))%>% 
    mutate(Valor_ST_ch= 100*(Short- lag(Short, 12))/lag(Short, 12))%>%  
    mutate(Valor_AbAtv_ch= 100*(Writtenoff- lag(Writtenoff, 12))/lag(Writtenoff, 12))%>%
    filter(date>="2019-09-30") %>% 
    select(date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch, Valor_AbAtv_ch) %>%
    rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch, Writtenoff = Valor_AbAtv_ch)  
  
})
```

### Global Credit

```{r}
renderDygraph({
  if (input$prod!="All") {
    
    if  (input$unit=="Level")  
    mylabel = "Amount (million euros)"
    else if  (input$unit=="MoM Abs Change")  
    mylabel = "Monthly Amount Change (million euros)"
    else if  (input$unit=="MoM Rel Change")  
    mylabel = "Monthly Percentage Change (%)"
    else if  (input$unit=="YoY Abs Change")  
    mylabel = "Yearly Amount Change (million euros)"
    else if  (input$unit=="YoY Rel Change")  
    mylabel = "Yearly Percentage Change (%)"
    
    if (dim(mysamplebp()[1])==0)
      return(NULL)
    
    don <- xts(x = mysamplebp()$Global, order.by = mysamplebp()$date)
    
    # Finally the plot
    dygraph(don, main = input$prod) %>%
      dySeries("V1", label = "Global Credit") %>%
      dyOptions(stackedGraph = TRUE) %>%
      dyRangeSelector(height = 20) %>%
      dyAxis("y", label = mylabel)
  }
})
```


### New Credit

```{r}
renderDygraph({
  if (input$prod!="All") {
    
    if  (input$unit=="Level")  
    mylabel = "Amount (million euros)"
    else if  (input$unit=="MoM Abs Change")  
    mylabel = "Monthly Amount Change (million euros)"
    else if  (input$unit=="MoM Rel Change")  
    mylabel = "Monthly Percentage Change (%)"
    else if  (input$unit=="YoY Abs Change")  
    mylabel = "Yearly Amount Change (million euros)"
    else if  (input$unit=="YoY Rel Change")  
    mylabel = "Yearly Percentage Change (%)"
    
    if (dim(mysamplebp()[1])==0)
      return(NULL)
    
    don <- xts(x = mysamplebp()$New, order.by = mysamplebp()$date)
    
    # Finally the plot
    dygraph(don, main = input$prod) %>%
      dySeries("V1", label = "New Credit") %>%
      dyOptions(stackedGraph = TRUE) %>%
      dyRangeSelector(height = 20) %>%
      dyAxis("y", label = mylabel)
  }
})
```


### Overdue Credit

```{r}
renderDygraph({
  if (input$prod!="All") {
    
    if  (input$unit=="Level")  
    mylabel = "Amount (million euros)"
    else if  (input$unit=="MoM Abs Change")  
    mylabel = "Monthly Amount Change (million euros)"
    else if  (input$unit=="MoM Rel Change")  
    mylabel = "Monthly Percentage Change (%)"
    else if  (input$unit=="YoY Abs Change")  
    mylabel = "Yearly Amount Change (million euros)"
    else if  (input$unit=="YoY Rel Change")  
    mylabel = "Yearly Percentage Change (%)"
    
    if (dim(mysamplebp()[1])==0)
      return(NULL)
    
    don <- xts(x = mysamplebp()$Overdue, order.by = mysamplebp()$date)
    
    # Finally the plot
    dygraph(don, main = input$prod) %>%
      dySeries("V1", label = "Overdue Credit") %>%
      dyOptions(stackedGraph = TRUE) %>%
      dyRangeSelector(height = 20) %>%
      dyAxis("y", label = mylabel)
  }
})
```

### Written-Off Credit


```{r}
renderDygraph({
  if (input$prod!="All") {
    
    if  (input$unit=="Level")  
    mylabel = "Amount (million euros)"
    else if  (input$unit=="MoM Abs Change")  
    mylabel = "Monthly Amount Change (million euros)"
    else if  (input$unit=="MoM Rel Change")  
    mylabel = "Monthly Percentage Change (%)"
    else if  (input$unit=="YoY Abs Change")  
    mylabel = "Yearly Amount Change (million euros)"
    else if  (input$unit=="YoY Rel Change")  
    mylabel = "Yearly Percentage Change (%)"
    
    if (dim(mysamplebp()[1])==0)
      return(NULL)
    
    don <- xts(x = mysamplebp()$Writtenoff, order.by = mysamplebp()$date)
    
    # Finally the plot
    dygraph(don, main = input$prod) %>%
      dySeries("V1", label = "Written-Off Credit") %>%
      dyOptions(stackedGraph = TRUE) %>%
      dyRangeSelector(height = 20) %>%
      dyAxis("y", label = mylabel)
  }
})
```


### Effective Credit

```{r}
renderDygraph({
  if (input$prod!="All") {
    
    if  (input$unit=="Level")  
    mylabel = "Amount (million euros)"
    else if  (input$unit=="MoM Abs Change")  
    mylabel = "Monthly Amount Change (million euros)"
    else if  (input$unit=="MoM Rel Change")  
    mylabel = "Monthly Percentage Change (%)"
    else if  (input$unit=="YoY Abs Change")  
    mylabel = "Yearly Amount Change (million euros)"
    else if  (input$unit=="YoY Rel Change")  
    mylabel = "Yearly Percentage Change (%)"
    
    
    if (dim(mysamplebp()[1])==0)
      return(NULL)
    
    don <- xts(x = mysamplebp()$Effective, order.by = mysamplebp()$date)
    
    # Finally the plot
    dygraph(don, main = input$prod) %>%
      dySeries("V1", label = "Effective Credit") %>%
      dyOptions(stackedGraph = TRUE) %>%
      dyRangeSelector(height = 20) %>%
      dyAxis("y", label = mylabel)
  }
})

```

### Potential Credit

```{r}
renderDygraph({
  if (input$prod!="All") {
    
    if  (input$unit=="Level")  
    mylabel = "Amount (million euros)"
    else if  (input$unit=="MoM Abs Change")  
    mylabel = "Monthly Amount Change (million euros)"
    else if  (input$unit=="MoM Rel Change")  
    mylabel = "Monthly Percentage Change (%)"
    else if  (input$unit=="YoY Abs Change")  
    mylabel = "Yearly Amount Change (million euros)"
    else if  (input$unit=="YoY Rel Change")  
    mylabel = "Yearly Percentage Change (%)"
    
    if (dim(mysamplebp()[1])==0)
      return(NULL)
    
    don <- xts(x = mysamplebp()$Potential, order.by = mysamplebp()$date)
    
    # Finally the plot
    dygraph(don, main = input$prod) %>%
      dySeries("V1", label = "Potential Credit") %>%
      dyOptions(stackedGraph = TRUE) %>%
      dyRangeSelector(height = 20) %>%
      dyAxis("y", label = mylabel)
  }
})
```


### Short-Term Credit

```{r}
renderDygraph({
  if (input$prod!="All") {
    
    if  (input$unit=="Level")  
    mylabel = "Amount (million euros)"
    else if  (input$unit=="MoM Abs Change")  
    mylabel = "Monthly Amount Change (million euros)"
    else if  (input$unit=="MoM Rel Change")  
    mylabel = "Monthly Percentage Change (%)"
    else if  (input$unit=="YoY Abs Change")  
    mylabel = "Yearly Amount Change (million euros)"
    else if  (input$unit=="YoY Rel Change")  
    mylabel = "Yearly Percentage Change (%)"
    
    if (dim(mysamplebp()[1])==0)
      return(NULL)
    
    don <- xts(x = mysamplebp()$Short, order.by = mysamplebp()$date)
    
    # Finally the plot
    dygraph(don, main = input$prod) %>%
      dySeries("V1", label = "Short-Term Credit") %>%
      dyOptions(stackedGraph = TRUE) %>%
      dyRangeSelector(height = 20) %>%
      dyAxis("y", label = mylabel)
  }
})
```


Row  {.tabset}
---------------------------------------------------------------------- 


```{r}   
mysamplep2 <- reactive({ 
  
  req(input$bank)
  
  if(input$bank == "All") {
    filt1 <- quote(Bank != "@?><")
  } else {
    filt1 <- quote(Bank == input$bank) 
  }
  
  
    bankall  %>% filter(pop==input$population) %>% 
    filter_(filt1) %>%
    mutate_at(vars(Valor_Glob: Valor_ST), funs(./1000000)) %>%
    rename(Global = Valor_Glob, Effective = Valor_Eff, New = Valor_New, Overdue = Valor_Vencido, Potential = Valor_Pot, Short = Valor_ST, Writtenoff = Valor_AbAtv) %>%       
    group_by(date) %>% 
    summarise_at(vars(Global, Effective, New, Overdue, Potential, Short, Writtenoff), funs(sum)) %>%  
    mutate_if(is.numeric, round, 2) 
  
})


mysamplebp2 <- reactive({ 
  
  if (input$unit=="Level")
    mysamplep2()  %>%  
    mutate_if(is.numeric, round, 2)
  
  else if (input$unit=="MoM Abs Change")
    mysamplep2() %>% 
    arrange(date) %>%
    mutate(Valor_Glob_ch= Global- lag(Global))%>% 
    mutate(Valor_Eff_ch= Effective- lag(Effective))%>% 
    mutate(Valor_New_ch= New- lag(New))%>% 
    mutate(Valor_Vencido_ch= Overdue- lag(Overdue))%>% 
    mutate(Valor_Pot_ch= Potential- lag(Potential))%>% 
    mutate(Valor_ST_ch= Short- lag(Short))%>%  
    mutate(Valor_AbAtv_ch= Writtenoff- lag(Writtenoff))%>%
    filter(date!="2018-09-30") %>% 
    select(date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch, Valor_AbAtv_ch) %>%
    rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch, Writtenoff = Valor_AbAtv_ch)
  
  else if (input$unit=="MoM Rel Change")
    mysamplep2() %>% 
    arrange(date) %>%
    mutate(Valor_Glob_ch= 100*(Global- lag(Global))/lag(Global))%>% 
    mutate(Valor_Eff_ch= 100*(Effective- lag(Effective))/lag(Effective))%>% 
    mutate(Valor_New_ch= 100*(New- lag(New))/lag(New))%>% 
    mutate(Valor_Vencido_ch= 100*(Overdue- lag(Overdue))/lag(Overdue))%>% 
    mutate(Valor_Pot_ch= 100*(Potential- lag(Potential))/lag(Potential))%>% 
    mutate(Valor_ST_ch= 100*(Short- lag(Short))/lag(Short))%>%  
    mutate(Valor_AbAtv_ch= 100*(Writtenoff- lag(Writtenoff))/lag(Writtenoff))%>%
    filter(date!="2018-09-30") %>% 
    select(date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch, Valor_AbAtv_ch) %>%
    rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch, Writtenoff = Valor_AbAtv_ch) 
  
  else if (input$unit=="YoY Abs Change")
    mysamplep2() %>% 
    arrange(date) %>%
    mutate(Valor_Glob_ch= Global- lag(Global, 12))%>% 
    mutate(Valor_Eff_ch= Effective- lag(Effective, 12))%>% 
    mutate(Valor_New_ch= New- lag(New, 12))%>% 
    mutate(Valor_Vencido_ch= Overdue- lag(Overdue, 12))%>% 
    mutate(Valor_Pot_ch= Potential- lag(Potential, 12))%>% 
    mutate(Valor_ST_ch= Short- lag(Short, 12))%>%  
    mutate(Valor_AbAtv_ch= Writtenoff- lag(Writtenoff, 12))%>%
    filter(date>="2019-09-30") %>% 
    select(date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch, Valor_AbAtv_ch) %>%
    rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch, Writtenoff = Valor_AbAtv_ch)
  
  else if (input$unit=="YoY Rel Change")
    mysamplep2() %>% 
    arrange(date) %>%
    mutate(Valor_Glob_ch= 100*(Global- lag(Global, 12))/lag(Global, 12))%>% 
    mutate(Valor_Eff_ch= 100*(Effective- lag(Effective, 12))/lag(Effective, 12))%>% 
    mutate(Valor_New_ch= 100*(New- lag(New, 12))/lag(New, 12))%>% 
    mutate(Valor_Vencido_ch= 100*(Overdue- lag(Overdue, 12))/lag(Overdue, 12))%>% 
    mutate(Valor_Pot_ch= 100*(Potential- lag(Potential, 12))/lag(Potential, 12))%>% 
    mutate(Valor_ST_ch= 100*(Short- lag(Short, 12))/lag(Short, 12))%>%  
    mutate(Valor_AbAtv_ch= 100*(Writtenoff- lag(Writtenoff, 12))/lag(Writtenoff, 12))%>%
    filter(date>="2019-09-30") %>% 
    select(date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch, Valor_AbAtv_ch) %>%
    rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch, Writtenoff = Valor_AbAtv_ch)  
  
})

```


### Global Credit

```{r}
renderDygraph({
  if (input$bank!="All") {
    
    if  (input$unit=="Level")  
    mylabel = "Amount (million euros)"
    else if  (input$unit=="MoM Abs Change")  
    mylabel = "Monthly Amount Change (million euros)"
    else if  (input$unit=="MoM Rel Change")  
    mylabel = "Monthly Percentage Change (%)"
    else if  (input$unit=="YoY Abs Change")  
    mylabel = "Yearly Amount Change (million euros)"
    else if  (input$unit=="YoY Rel Change")  
    mylabel = "Yearly Percentage Change (%)"
    
    if (dim(mysamplebp2()[1])==0)
      return(NULL)
    
    don <- xts(x = mysamplebp2()$Global, order.by = mysamplebp2()$date)
    
    # Finally the plot
    dygraph(don, main = input$bank) %>%
      dySeries("V1", label = "Global Credit") %>%
      dyOptions(stackedGraph = TRUE) %>%
      dyRangeSelector(height = 20) %>%
      dyAxis("y", label = mylabel)
  }
})
```


### New Credit

```{r}
renderDygraph({
  if (input$bank!="All") {
    
    if  (input$unit=="Level")  
    mylabel = "Amount (million euros)"
    else if  (input$unit=="MoM Abs Change")  
    mylabel = "Monthly Amount Change (million euros)"
    else if  (input$unit=="MoM Rel Change")  
    mylabel = "Monthly Percentage Change (%)"
    else if  (input$unit=="YoY Abs Change")  
    mylabel = "Yearly Amount Change (million euros)"
    else if  (input$unit=="YoY Rel Change")  
    mylabel = "Yearly Percentage Change (%)"
    
    if (dim(mysamplebp2()[1])==0)
      return(NULL)
    
    don <- xts(x = mysamplebp2()$New, order.by = mysamplebp2()$date)
    
    # Finally the plot
    dygraph(don, main = input$bank) %>%
      dySeries("V1", label = "New Credit") %>%
      dyOptions(stackedGraph = TRUE) %>%
      dyRangeSelector(height = 20) %>%
      dyAxis("y", label = mylabel)
  }
})
```


### Overdue Credit

```{r}
renderDygraph({
  if (input$bank!="All") {  
    
    if  (input$unit=="Level")  
    mylabel = "Amount (million euros)"
    else if  (input$unit=="MoM Abs Change")  
    mylabel = "Monthly Amount Change (million euros)"
    else if  (input$unit=="MoM Rel Change")  
    mylabel = "Monthly Percentage Change (%)"
    else if  (input$unit=="YoY Abs Change")  
    mylabel = "Yearly Amount Change (million euros)"
    else if  (input$unit=="YoY Rel Change")  
    mylabel = "Yearly Percentage Change (%)"
    
    if (dim(mysamplebp2()[1])==0)
      return(NULL)
    
    don <- xts(x = mysamplebp2()$Overdue, order.by = mysamplebp2()$date)
    
    # Finally the plot
    dygraph(don, main = input$bank) %>%
      dySeries("V1", label = "Overdue Credit") %>%
      dyOptions(stackedGraph = TRUE) %>%
      dyRangeSelector(height = 20) %>%
      dyAxis("y", label = mylabel)
  }
})
```

### Written-Off Credit


```{r}
renderDygraph({
  if (input$bank!="All") {
    
    if  (input$unit=="Level")  
    mylabel = "Amount (million euros)"
    else if  (input$unit=="MoM Abs Change")  
    mylabel = "Monthly Amount Change (million euros)"
    else if  (input$unit=="MoM Rel Change")  
    mylabel = "Monthly Percentage Change (%)"
    else if  (input$unit=="YoY Abs Change")  
    mylabel = "Yearly Amount Change (million euros)"
    else if  (input$unit=="YoY Rel Change")  
    mylabel = "Yearly Percentage Change (%)"
    
    if (dim(mysamplebp2()[1])==0)
      return(NULL)
    
    don <- xts(x = mysamplebp2()$Writtenoff, order.by = mysamplebp2()$date)
    
    # Finally the plot
    dygraph(don, main = input$bank) %>%
      dySeries("V1", label = "Written-Off Credit") %>%
      dyOptions(stackedGraph = TRUE) %>%
      dyRangeSelector(height = 20) %>%
      dyAxis("y", label = mylabel)
  }
})
```


### Effective Credit

```{r}
renderDygraph({
  if (input$bank!="All") {
    
    if  (input$unit=="Level")  
    mylabel = "Amount (million euros)"
    else if  (input$unit=="MoM Abs Change")  
    mylabel = "Monthly Amount Change (million euros)"
    else if  (input$unit=="MoM Rel Change")  
    mylabel = "Monthly Percentage Change (%)"
    else if  (input$unit=="YoY Abs Change")  
    mylabel = "Yearly Amount Change (million euros)"
    else if  (input$unit=="YoY Rel Change")  
    mylabel = "Yearly Percentage Change (%)"
    
    if (dim(mysamplebp2()[1])==0)
      return(NULL)
    
    don <- xts(x = mysamplebp2()$Effective, order.by = mysamplebp2()$date)
    
    # Finally the plot
    dygraph(don, main = input$bank) %>%
      dySeries("V1", label = "Effective Credit") %>%
      dyOptions(stackedGraph = TRUE) %>%
      dyRangeSelector(height = 20) %>%
      dyAxis("y", label = mylabel)
  }
})

```

### Potential Credit

```{r}
renderDygraph({
  if (input$bank!="All") {
    
    if  (input$unit=="Level")  
    mylabel = "Amount (million euros)"
    else if  (input$unit=="MoM Abs Change")  
    mylabel = "Monthly Amount Change (million euros)"
    else if  (input$unit=="MoM Rel Change")  
    mylabel = "Monthly Percentage Change (%)"
    else if  (input$unit=="YoY Abs Change")  
    mylabel = "Yearly Amount Change (million euros)"
    else if  (input$unit=="YoY Rel Change")  
    mylabel = "Yearly Percentage Change (%)"
    
    if (dim(mysamplebp2()[1])==0)
      return(NULL)
    
    don <- xts(x = mysamplebp2()$Potential, order.by = mysamplebp2()$date)
    
    # Finally the plot
    dygraph(don, main = input$bank) %>%
      dySeries("V1", label = "Potential Credit") %>%
      dyOptions(stackedGraph = TRUE) %>%
      dyRangeSelector(height = 20) %>%
      dyAxis("y", label = mylabel)
  }
})
```


### Short-Term Credit

```{r}
renderDygraph({
  if (input$bank!="All") {
    
    if  (input$unit=="Level")  
    mylabel = "Amount (million euros)"
    else if  (input$unit=="MoM Abs Change")  
    mylabel = "Monthly Amount Change (million euros)"
    else if  (input$unit=="MoM Rel Change")  
    mylabel = "Monthly Percentage Change (%)"
    else if  (input$unit=="YoY Abs Change")  
    mylabel = "Yearly Amount Change (million euros)"
    else if  (input$unit=="YoY Rel Change")  
    mylabel = "Yearly Percentage Change (%)"
    
    if (dim(mysamplebp2()[1])==0)
      return(NULL)
    
    don <- xts(x = mysamplebp2()$Short, order.by = mysamplebp2()$date)
    
    # Finally the plot
    dygraph(don, main = input$bank) %>%
      dySeries("V1", label = "Short-Term Credit") %>%
      dyOptions(stackedGraph = TRUE) %>%
      dyRangeSelector(height = 20) %>%
      dyAxis("y", label = mylabel)
  }
})
```



Row  {.tabset}
---------------------------------------------------------------------- 

```{r}   
mysamplep3 <- reactive({ 
  
  req(input$bank)
  req(input$prod)    
  
  if(input$bank == "All") {
    filt1 <- quote(Bank != "@?><")
  } else {
    filt1 <- quote(Bank == input$bank) 
  }
  
  
  if (input$prod == "All") {
    filt2 <- quote(type != "@?><")
  } else {
    filt2 <- quote(type == input$prod)
  }
  
    bankall  %>% filter(pop==input$population) %>% 
    filter_(filt1) %>%
    filter_(filt2) %>% 
    mutate_at(vars(Valor_Glob: Valor_ST), funs(./1000000)) %>%
    rename(Global = Valor_Glob, Effective = Valor_Eff, New = Valor_New, Overdue = Valor_Vencido, Potential = Valor_Pot, Short = Valor_ST, Writtenoff = Valor_AbAtv) %>%       
    group_by(date) %>% 
    summarise_at(vars(Global, Effective, New, Overdue, Potential, Short, Writtenoff), funs(sum)) %>%  
    mutate_if(is.numeric, round, 2) 
  
})


mysamplebp3 <- reactive({ 
  
  if (input$unit=="Level")
    mysamplep3()  %>%  
    mutate_if(is.numeric, round, 2)
  
  else if (input$unit=="MoM Abs Change")
    mysamplep3() %>% 
    arrange(date) %>%
    mutate(Valor_Glob_ch= Global- lag(Global))%>% 
    mutate(Valor_Eff_ch= Effective- lag(Effective))%>% 
    mutate(Valor_New_ch= New- lag(New))%>% 
    mutate(Valor_Vencido_ch= Overdue- lag(Overdue))%>% 
    mutate(Valor_Pot_ch= Potential- lag(Potential))%>% 
    mutate(Valor_ST_ch= Short- lag(Short))%>%  
    mutate(Valor_AbAtv_ch= Writtenoff- lag(Writtenoff))%>%
    filter(date!="2018-09-30") %>% 
    select(date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch, Valor_AbAtv_ch) %>%
    rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch, Writtenoff = Valor_AbAtv_ch)
  
  else if (input$unit=="MoM Rel Change")
    mysamplep3() %>% 
    arrange(date) %>%
    mutate(Valor_Glob_ch= 100*(Global- lag(Global))/lag(Global))%>% 
    mutate(Valor_Eff_ch= 100*(Effective- lag(Effective))/lag(Effective))%>% 
    mutate(Valor_New_ch= 100*(New- lag(New))/lag(New))%>% 
    mutate(Valor_Vencido_ch= 100*(Overdue- lag(Overdue))/lag(Overdue))%>% 
    mutate(Valor_Pot_ch= 100*(Potential- lag(Potential))/lag(Potential))%>% 
    mutate(Valor_ST_ch= 100*(Short- lag(Short))/lag(Short))%>%  
    mutate(Valor_AbAtv_ch= 100*(Writtenoff- lag(Writtenoff))/lag(Writtenoff))%>%
    filter(date!="2018-09-30") %>% 
    select(date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch, Valor_AbAtv_ch) %>%
    rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch, Writtenoff = Valor_AbAtv_ch) 
  
  else if (input$unit=="YoY Abs Change")
    mysamplep3() %>% 
    arrange(date) %>%
    mutate(Valor_Glob_ch= Global- lag(Global, 12))%>% 
    mutate(Valor_Eff_ch= Effective- lag(Effective, 12))%>% 
    mutate(Valor_New_ch= New- lag(New, 12))%>% 
    mutate(Valor_Vencido_ch= Overdue- lag(Overdue, 12))%>% 
    mutate(Valor_Pot_ch= Potential- lag(Potential, 12))%>% 
    mutate(Valor_ST_ch= Short- lag(Short, 12))%>%  
    mutate(Valor_AbAtv_ch= Writtenoff- lag(Writtenoff, 12))%>%
    filter(date>="2019-09-30") %>% 
    select(date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch, Valor_AbAtv_ch) %>%
    rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch, Writtenoff = Valor_AbAtv_ch)
  
  else if (input$unit=="YoY Rel Change")
    mysamplep3() %>% 
    arrange(date) %>%
    mutate(Valor_Glob_ch= 100*(Global- lag(Global, 12))/lag(Global, 12))%>% 
    mutate(Valor_Eff_ch= 100*(Effective- lag(Effective, 12))/lag(Effective, 12))%>% 
    mutate(Valor_New_ch= 100*(New- lag(New, 12))/lag(New, 12))%>% 
    mutate(Valor_Vencido_ch= 100*(Overdue- lag(Overdue, 12))/lag(Overdue, 12))%>% 
    mutate(Valor_Pot_ch= 100*(Potential- lag(Potential, 12))/lag(Potential, 12))%>% 
    mutate(Valor_ST_ch= 100*(Short- lag(Short, 12))/lag(Short, 12))%>%  
    mutate(Valor_AbAtv_ch= 100*(Writtenoff- lag(Writtenoff, 12))/lag(Writtenoff, 12))%>%
    filter(date>="2019-09-30") %>% 
    select(date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch, Valor_AbAtv_ch) %>%
    rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch, Writtenoff = Valor_AbAtv_ch)  
  
})

```



### Global Credit

```{r}
renderDygraph({
  mytext = paste(input$prod, "of", input$bank)
    
  if (input$bank!="All" & input$prod!="All") {
    
    if  (input$unit=="Level")  
    mylabel = "Amount (million euros)"
    else if  (input$unit=="MoM Abs Change")  
    mylabel = "Monthly Amount Change (million euros)"
    else if  (input$unit=="MoM Rel Change")  
    mylabel = "Monthly Percentage Change (%)"
    else if  (input$unit=="YoY Abs Change")  
    mylabel = "Yearly Amount Change (million euros)"
    else if  (input$unit=="YoY Rel Change")  
    mylabel = "Yearly Percentage Change (%)"
    
    if (dim(mysamplebp3()[1])==0)
      return(NULL)
    
    don <- xts(x = mysamplebp3()$Global, order.by = mysamplebp3()$date)
    
    # Finally the plot
    dygraph(don, main = mytext) %>%
      dySeries("V1", label = "Global Credit") %>%
      dyOptions(stackedGraph = TRUE) %>%
      dyRangeSelector(height = 20) %>%
      dyAxis("y", label = mylabel)
  }
})
```


### New Credit

```{r}
renderDygraph({
  mytext = paste(input$prod, "of", input$bank)
  
  if (input$bank!="All" & input$prod!="All") {
    
    if  (input$unit=="Level")  
    mylabel = "Amount (million euros)"
    else if  (input$unit=="MoM Abs Change")  
    mylabel = "Monthly Amount Change (million euros)"
    else if  (input$unit=="MoM Rel Change")  
    mylabel = "Monthly Percentage Change (%)"
    else if  (input$unit=="YoY Abs Change")  
    mylabel = "Yearly Amount Change (million euros)"
    else if  (input$unit=="YoY Rel Change")  
    mylabel = "Yearly Percentage Change (%)"
    
    if (dim(mysamplebp3()[1])==0)
      return(NULL)
    
    don <- xts(x = mysamplebp3()$New, order.by = mysamplebp3()$date)
    
    # Finally the plot
    dygraph(don, main = mytext) %>%
      dySeries("V1", label = "New Credit") %>%
      dyOptions(stackedGraph = TRUE) %>%
      dyRangeSelector(height = 20) %>%
      dyAxis("y", label = mylabel)
  }
})
```


### Overdue Credit

```{r}
renderDygraph({
  mytext = paste(input$prod, "of", input$bank)
  if (input$bank!="All" & input$prod!="All") {
    
    if  (input$unit=="Level")  
    mylabel = "Amount (million euros)"
    else if  (input$unit=="MoM Abs Change")  
    mylabel = "Monthly Amount Change (million euros)"
    else if  (input$unit=="MoM Rel Change")  
    mylabel = "Monthly Percentage Change (%)"
    else if  (input$unit=="YoY Abs Change")  
    mylabel = "Yearly Amount Change (million euros)"
    else if  (input$unit=="YoY Rel Change")  
    mylabel = "Yearly Percentage Change (%)"
    
    if (dim(mysamplebp3()[1])==0)
      return(NULL)
    
    don <- xts(x = mysamplebp3()$Overdue, order.by = mysamplebp3()$date)
    
    # Finally the plot
    dygraph(don, main = mytext) %>%
      dySeries("V1", label = "Overdue Credit") %>%
      dyOptions(stackedGraph = TRUE) %>%
      dyRangeSelector(height = 20) %>%
      dyAxis("y", label = mylabel)
  }
})
```

### Written-Off Credit


```{r}
renderDygraph({
  mytext = paste(input$prod, "of", input$bank)
  if (input$bank!="All" & input$prod!="All") {
    
    if  (input$unit=="Level")  
    mylabel = "Amount (million euros)"
    else if  (input$unit=="MoM Abs Change")  
    mylabel = "Monthly Amount Change (million euros)"
    else if  (input$unit=="MoM Rel Change")  
    mylabel = "Monthly Percentage Change (%)"
    else if  (input$unit=="YoY Abs Change")  
    mylabel = "Yearly Amount Change (million euros)"
    else if  (input$unit=="YoY Rel Change")  
    mylabel = "Yearly Percentage Change (%)"
    
    if (dim(mysamplebp3()[1])==0)
      return(NULL)
    
    don <- xts(x = mysamplebp3()$Writtenoff, order.by = mysamplebp3()$date)
    
    # Finally the plot
    dygraph(don, main = mytext) %>%
      dySeries("V1", label = "Written-Off Credit") %>%
      dyOptions(stackedGraph = TRUE) %>%
      dyRangeSelector(height = 20) %>%
      dyAxis("y", label = mylabel)
  }
})

```


### Effective Credit

```{r}
renderDygraph({
  mytext = paste(input$prod, "of", input$bank)
  if (input$bank!="All" & input$prod!="All") {
    
    if  (input$unit=="Level")  
    mylabel = "Amount (million euros)"
    else if  (input$unit=="MoM Abs Change")  
    mylabel = "Monthly Amount Change (million euros)"
    else if  (input$unit=="MoM Rel Change")  
    mylabel = "Monthly Percentage Change (%)"
    else if  (input$unit=="YoY Abs Change")  
    mylabel = "Yearly Amount Change (million euros)"
    else if  (input$unit=="YoY Rel Change")  
    mylabel = "Yearly Percentage Change (%)"
    
    if (dim(mysamplebp3()[1])==0)
      return(NULL)
    
    don <- xts(x = mysamplebp3()$Effective, order.by = mysamplebp3()$date)
    
    # Finally the plot
    dygraph(don, main = mytext) %>%
      dySeries("V1", label = "Effective Credit") %>%
      dyOptions(stackedGraph = TRUE) %>%
      dyRangeSelector(height = 20) %>%
      dyAxis("y", label = mylabel)
  }
})

```

### Potential Credit

```{r}
renderDygraph({
  mytext = paste(input$prod, "of", input$bank)
  if (input$bank!="All" & input$prod!="All") {
    
    if  (input$unit=="Level")  
    mylabel = "Amount (million euros)"
    else if  (input$unit=="MoM Abs Change")  
    mylabel = "Monthly Amount Change (million euros)"
    else if  (input$unit=="MoM Rel Change")  
    mylabel = "Monthly Percentage Change (%)"
    else if  (input$unit=="YoY Abs Change")  
    mylabel = "Yearly Amount Change (million euros)"
    else if  (input$unit=="YoY Rel Change")  
    mylabel = "Yearly Percentage Change (%)"
    
    if (dim(mysamplebp3()[1])==0)
      return(NULL)
    
    don <- xts(x = mysamplebp3()$Potential, order.by = mysamplebp3()$date)
    
    # Finally the plot
    dygraph(don, main = mytext) %>%
      dySeries("V1", label = "Potential Credit") %>%
      dyOptions(stackedGraph = TRUE) %>%
      dyRangeSelector(height = 20) %>%
      dyAxis("y", label = mylabel)
  }
})
```


### Short-Term Credit

```{r}
renderDygraph({
  mytext = paste(input$prod, "of", input$bank)
  if (input$bank!="All" & input$prod!="All") {
    
    if  (input$unit=="Level")  
    mylabel = "Amount (million euros)"
    else if  (input$unit=="MoM Abs Change")  
    mylabel = "Monthly Amount Change (million euros)"
    else if  (input$unit=="MoM Rel Change")  
    mylabel = "Monthly Percentage Change (%)"
    else if  (input$unit=="YoY Abs Change")  
    mylabel = "Yearly Amount Change (million euros)"
    else if  (input$unit=="YoY Rel Change")  
    mylabel = "Yearly Percentage Change (%)"
    
    if (dim(mysamplebp3()[1])==0)
      return(NULL)
    
    don <- xts(x = mysamplebp3()$Short, order.by = mysamplebp3()$date)
    
    # Finally the plot
    dygraph(don, main = mytext) %>%
      dySeries("V1", label = "Short-Term Credit") %>%
      dyOptions(stackedGraph = TRUE) %>%
      dyRangeSelector(height = 20) %>%
      dyAxis("y", label = mylabel)
  }
})
```


Debtor Characteristics
=======================================================================


<p style="font-family: times, serif; font-size:15pt; font-style:italic">
    <mark>**Attention!**</mark> **The following filters  need to be selected: Population, Mode, Bank, Product and Debtor Characteristics.** 
</p>

```{r}
useShinyjs(rmd = TRUE)
actionButton("reset3", "Reset",
    icon("sliders"), 
    style="color: #fff; background-color: #71afe3; border-radius: 0%; border-color: #71afe3; padding:8px; font-size:100%; width:70px")

observeEvent(input$reset3, {
 shinyjs::reset("population")
 shinyjs::reset("unit")
 shinyjs::reset("bank")
 shinyjs::reset("prod")
 shinyjs::reset("size")
 shinyjs::reset("firmage")
 shinyjs::reset("region")
 shinyjs::reset("sector")
 shinyjs::reset("age")
 shinyjs::reset("gender")
 shinyjs::reset("hregion")
 shinyjs::reset("prof")
 shinyjs::reset("edu")
 shinyjs::reset("fam")
 shinyjs::reset("samplesize1")
 shinyjs::reset("samplesize2")
})
```


```{r}

renderText({
  if (input$population == "FRM")
  paste("Your Choice: Population = ", input$population, ", Mode = ", input$unit, ", Bank = ", input$bank, ", Product = ", input$prod, ", Size = ", input$size, ", Age = ", input$firmage, ", Region = ", input$region, ", Sector = ", input$sector) 
  
  else if (input$population == "PRV")
  paste("Your Choice: Population = ", input$population, ", Mode = ", input$unit, ", Bank = ", input$bank, ", Product = ", input$prod, ", Age = ", input$age, ", Region = ", input$hregion, ", Gender = ", input$gender, ", Profession = ", input$prof, ", Education = ", input$edu, ", Family = ", input$fam)  

})

renderText({
  
  paste(" ") 
  
})

```


```{r}   
basesample <- reactive({ 
  
    req(input$bank)
    req(input$prod)    
    req(input$size)
    req(input$firmage)    
    req(input$region)
    req(input$sector)     
    req(input$age)
    req(input$gender)    
    req(input$hregion)
    req(input$prof)    
    req(input$edu)
    req(input$fam) 
    
  
    if(input$bank == "All") {
      filt1 <- quote(Bank != "@?><")
    } else {
      filt1 <- quote(Bank == input$bank) 
    }
    
    
    if (input$prod == "All") {
      filt2 <- quote(type != "@?><")
    } else {
      filt2 <- quote(type == input$prod)
    }
    
    # size
    
    if (input$size == "All") {
      filt3 <- quote(size != "@?><")
    } else {
      filt3 <- quote(size == input$size)
    }
    
    if (input$firmage == "All") {
      filt4 <- quote(FAge != "@?><")
    } else {
      filt4 <- quote(FAge == input$firmage)
    }
    
    if (input$region == "All") {
      filt5 <- quote(Regiao != "@?><")
    } else {
      filt5 <- quote(Regiao == input$region)
    } 
    
    if (input$sector == "All") {
      filt6 <- quote(Sector != "@?><")
    } else {
      filt6 <- quote(Sector == input$sector)
    } 
    

    
    # household
    if (input$age == "All") {
      filt7 <- quote(Age != "@?><")
    } else {
      filt7 <- quote(Age == input$age)
    }
    
    if (input$gender == "All") {
      filt8 <- quote(Gender != "@?><")
    } else {
      filt8 <- quote(Gender == input$gender)
    } 
    
    if (input$hregion == "All") {
      filt9 <- quote(Regiao != "@?><")
    } else {
      filt9 <- quote(Regiao == input$hregion)
    }     
    
    if (input$prof == "All") {
      filt10 <- quote(Profession != "@?><")
    } else {
      filt10 <- quote(Profession == input$prof)
    }
    
    if (input$edu == "All") {
      filt11 <- quote(Education != "@?><")
    } else {
      filt11 <- quote(Education == input$edu)
    } 
    
    if (input$fam == "All") {
      filt12 <- quote(Family != "@?><")
    } else {
      filt12 <- quote(Family == input$fam)
    }  

    
    if (input$population=="FRM")  
      bankall_FRM %>%
        filter_(filt1) %>%
        filter_(filt2) %>% 
        filter_(filt3) %>% 
        filter_(filt4) %>% 
        filter_(filt5) %>% 
        filter_(filt6) %>%  
        mutate_at(vars(Valor_Glob: Valor_ST), funs(./1000000)) %>%
        rename(Global = Valor_Glob, Effective = Valor_Eff, New = Valor_New, Overdue = Valor_Vencido, Potential = Valor_Pot, Short = Valor_ST, Writtenoff = Valor_AbAtv, Loan = nb_loan) %>%       
        group_by(date) %>% 
        summarise_at(vars(Global, Effective, New, Overdue, Potential, Short, Writtenoff, Loan), funs(sum)) %>%  
        mutate_if(is.numeric, round, 2) 
    
    else if (input$population=="PRV")  
      bankall_PRV %>% 
        filter_(filt1) %>%
        filter_(filt2) %>% 
        filter_(filt7) %>% 
        filter_(filt8) %>% 
        filter_(filt9) %>% 
        filter_(filt10) %>% 
        filter_(filt11) %>% 
        filter_(filt12) %>% 
        mutate_at(vars(Valor_Glob: Valor_ST), funs(./1000000)) %>%
        rename(Global = Valor_Glob, Effective = Valor_Eff, New = Valor_New, Overdue = Valor_Vencido, Potential = Valor_Pot, Short = Valor_ST, Writtenoff = Valor_AbAtv, Loan = nb_loan) %>%       
        group_by(date) %>% 
        summarise_at(vars(Global, Effective, New, Overdue, Potential, Short, Writtenoff, Loan), funs(sum)) %>%  
        mutate_if(is.numeric, round, 2) 
    
})



basesample2 <- reactive({ 

  if (input$unit=="Level")
    basesample()  %>%  
        mutate_if(is.numeric, round, 2)
  
  else if (input$unit=="MoM Abs Change")
    basesample() %>% 
    arrange(date) %>%
    mutate(Valor_Glob_ch= Global- lag(Global))%>% 
    mutate(Valor_Eff_ch= Effective- lag(Effective))%>% 
    mutate(Valor_New_ch= New- lag(New))%>% 
    mutate(Valor_Vencido_ch= Overdue- lag(Overdue))%>% 
    mutate(Valor_Pot_ch= Potential- lag(Potential))%>% 
    mutate(Valor_ST_ch= Short- lag(Short))%>%  
    mutate(Valor_AbAtv_ch= Writtenoff- lag(Writtenoff))%>%
    mutate(nb_loan_ch= Loan- lag(Loan))%>%
    filter(date!="2018-09-30") %>% 
    select(date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch, Valor_AbAtv_ch, nb_loan_ch) %>%
    rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch, Writtenoff = Valor_AbAtv_ch, Loan = nb_loan_ch)
  
  else if (input$unit=="MoM Rel Change")
    basesample() %>% 
    arrange(date) %>%
    mutate(Valor_Glob_ch= 100*(Global- lag(Global))/lag(Global))%>% 
    mutate(Valor_Eff_ch= 100*(Effective- lag(Effective))/lag(Effective))%>% 
    mutate(Valor_New_ch= 100*(New- lag(New))/lag(New))%>% 
    mutate(Valor_Vencido_ch= 100*(Overdue- lag(Overdue))/lag(Overdue))%>% 
    mutate(Valor_Pot_ch= 100*(Potential- lag(Potential))/lag(Potential))%>% 
    mutate(Valor_ST_ch= 100*(Short- lag(Short))/lag(Short))%>%  
    mutate(Valor_AbAtv_ch= 100*(Writtenoff- lag(Writtenoff))/lag(Writtenoff))%>%
    mutate(nb_loan_ch= 100*(Loan- lag(Loan))/lag(Loan))%>%
    filter(date!="2018-09-30") %>% 
    select(date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch, Valor_AbAtv_ch, nb_loan_ch) %>%
    rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch, Writtenoff = Valor_AbAtv_ch, Loan = nb_loan_ch) 
  
  else if (input$unit=="YoY Abs Change")
    basesample() %>% 
    arrange(date) %>%
    mutate(Valor_Glob_ch= Global- lag(Global, 12))%>% 
    mutate(Valor_Eff_ch= Effective- lag(Effective, 12))%>% 
    mutate(Valor_New_ch= New- lag(New, 12))%>% 
    mutate(Valor_Vencido_ch= Overdue- lag(Overdue, 12))%>% 
    mutate(Valor_Pot_ch= Potential- lag(Potential, 12))%>% 
    mutate(Valor_ST_ch= Short- lag(Short, 12))%>%  
    mutate(Valor_AbAtv_ch= Writtenoff- lag(Writtenoff, 12))%>%
    mutate(nb_loan_ch= Loan- lag(Loan, 12))%>%
    filter(date>="2019-09-30") %>% 
    select(date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch, Valor_AbAtv_ch, nb_loan_ch) %>%
    rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch, Writtenoff = Valor_AbAtv_ch, Loan = nb_loan_ch)
  
  else if (input$unit=="YoY Rel Change")
    basesample() %>% 
    arrange(date) %>%
    mutate(Valor_Glob_ch= 100*(Global- lag(Global, 12))/lag(Global, 12))%>% 
    mutate(Valor_Eff_ch= 100*(Effective- lag(Effective, 12))/lag(Effective, 12))%>% 
    mutate(Valor_New_ch= 100*(New- lag(New, 12))/lag(New, 12))%>% 
    mutate(Valor_Vencido_ch= 100*(Overdue- lag(Overdue, 12))/lag(Overdue, 12))%>% 
    mutate(Valor_Pot_ch= 100*(Potential- lag(Potential, 12))/lag(Potential, 12))%>% 
    mutate(Valor_ST_ch= 100*(Short- lag(Short, 12))/lag(Short, 12))%>%  
    mutate(Valor_AbAtv_ch= 100*(Writtenoff- lag(Writtenoff, 12))/lag(Writtenoff, 12))%>%
    mutate(nb_loan_ch= 100*(Loan- lag(Loan, 12))/lag(Loan, 12))%>%
    filter(date>="2019-09-30") %>% 
    select(date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch, Valor_AbAtv_ch, nb_loan_ch) %>%
    rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch, Writtenoff = Valor_AbAtv_ch, Loan = nb_loan_ch)  
  
})


myobs1 <- reactive({ 
  
    basesample() %>% 
    group_by(date) %>% 
    summarise_at(vars(Loan), funs(sum))
        
})

myobs2 <- reactive({ 
  if (input$population=="FRM")  
  bankall_FRM  %>% 
  group_by(date) %>% 
  summarise_at(vars(nb_loan), funs(sum))
  
  else if (input$population=="PRV")  
  bankall_PRV  %>% 
  group_by(date) %>% 
  summarise_at(vars(nb_loan), funs(sum))  
})

myobs3 <- reactive({ 
  merge(myobs1(), myobs2(),by="date")
})

myobs4 <- reactive({ 
    myobs3() %>%
    filter(nb_loan !=0) %>% 
    mutate(percent_sample= 100*Loan/nb_loan)
})


```



Row  {.tabset}
---------------------------------------------------------------------- 


### Global Credit

```{r}
renderDygraph({
  
  if (dim(basesample2()[1])==0)
    return(NULL)
  
  if  (input$unit=="Level")  
  mylabel = "Amount (million euros)"
  else if  (input$unit=="MoM Abs Change")  
  mylabel = "Monthly Amount Change (million euros)"
  else if  (input$unit=="MoM Rel Change")  
  mylabel = "Monthly Percentage Change (%)"
  else if  (input$unit=="YoY Abs Change")  
  mylabel = "Yearly Amount Change (million euros)"
  else if  (input$unit=="YoY Rel Change")  
  mylabel = "Yearly Percentage Change (%)"
  
  if  (input$sector=="A") 
  mysector = "A - Agriculture, farming of animals, hunting and forestry"
  else if  (input$sector=="B") 
  mysector = "B - Mining and quarrying"
  else if  (input$sector=="C") 
  mysector = "C - Manufacturing" 
  else if  (input$sector=="D") 
  mysector = "D - Electricity, gas, steam, cold and hot water and cold air"
  else if  (input$sector=="E") 
  mysector = "E - Water collection, treatment and distribution; sewerage, waste management and remediation activities"
  else if  (input$sector=="F") 
  mysector = "F - Construction"
  else if  (input$sector=="G") 
  mysector = "G - Wholesale and retail trade; repair of motor vehicles and motorcycles"
  else if  (input$sector=="H") 
  mysector = "H - Transportation and storage" 
  else if  (input$sector=="I") 
  mysector = "I - Accommodation and food service activities"
  else if  (input$sector=="J") 
  mysector = "J - Information and communication activities"
  else if  (input$sector=="K") 
  mysector = "K - Financial and insurance activities"
  else if  (input$sector=="L") 
  mysector = "L - Real estate activities"
  else if  (input$sector=="M") 
  mysector = "M - Consultancy, scientific and technical activities"
  else if  (input$sector=="N") 
  mysector = "N - Administrative and support service activities"
  else if  (input$sector=="O") 
  mysector = "O - Public administration and defence; compulsory social security"
  else if  (input$sector=="P") 
  mysector = "P - Education"
  else if  (input$sector=="Q") 
  mysector = "Q - Human health and social work activities"
  else if  (input$sector=="R") 
  mysector = "R - Arts, entertainment, sports and recreation activities"
  else if  (input$sector=="S") 
  mysector = "S - Other service activities"
  else if  (input$sector=="T") 
  mysector = "T - Activities of households as employers; undifferentiated goods- and services-producing activities of households for own use" 
  else if  (input$sector=="NA") 
  mysector = "NA" 
  else if  (input$sector=="All") 
  mysector = "All"
  
  a<- min(myobs4()$percent_sample)
  
  a<- round(a,digits=2)
  
  aa<- max(myobs4()$percent_sample)
  
  aa<- round(aa,digits=2)
  
  if (input$population=="FRM")  
  mytext = paste("Product:", input$prod, "||", "Bank:", input$bank, "||", "Size:", input$size, "||", "Age:", input$firmage, "||", "Region:", input$region, "||", "Sector:", mysector, "<br> At its lowest / highest, your sample represents ", a, "/", aa, " percent of the total firm loans")
  
  else if (input$population=="PRV")  
  mytext = paste("Product:", input$prod, "||", "Bank:", input$bank, "||", "Age:", input$age, "||", "Gender:", input$gender, "||", "Region:", input$region, "||", "Profession:", input$prof, "||", "Education:", input$edu, "||", "Family:", input$fam, "<br> At its lowest / highest, your sample represents ", a, "/", aa, " percent of the total household loans")
  
    don <- xts(x = basesample2()$Global, order.by = basesample2()$date)
    
    # Finally the plot
    dygraph(don, main = mytext) %>%
      dySeries("V1", label = "Global Credit") %>%
      dyOptions(stackedGraph = TRUE) %>%
      dyRangeSelector(height = 20) %>%
      dyAxis("y", label = mylabel)
})
```


### New Credit

```{r}
renderDygraph({
  
  if (dim(basesample2()[1])==0)
    return(NULL)
  
  if  (input$unit=="Level")  
  mylabel = "Amount (million euros)"
  else if  (input$unit=="MoM Abs Change")  
  mylabel = "Monthly Amount Change (million euros)"
  else if  (input$unit=="MoM Rel Change")  
  mylabel = "Monthly Percentage Change (%)"
  else if  (input$unit=="YoY Abs Change")  
  mylabel = "Yearly Amount Change (million euros)"
  else if  (input$unit=="YoY Rel Change")  
  mylabel = "Yearly Percentage Change (%)"
  
  if  (input$sector=="A") 
  mysector = "A - Agriculture, farming of animals, hunting and forestry"
  else if  (input$sector=="B") 
  mysector = "B - Mining and quarrying"
  else if  (input$sector=="C") 
  mysector = "C - Manufacturing" 
  else if  (input$sector=="D") 
  mysector = "D - Electricity, gas, steam, cold and hot water and cold air"
  else if  (input$sector=="E") 
  mysector = "E - Water collection, treatment and distribution; sewerage, waste management and remediation activities"
  else if  (input$sector=="F") 
  mysector = "F - Construction"
  else if  (input$sector=="G") 
  mysector = "G - Wholesale and retail trade; repair of motor vehicles and motorcycles"
  else if  (input$sector=="H") 
  mysector = "H - Transportation and storage" 
  else if  (input$sector=="I") 
  mysector = "I - Accommodation and food service activities"
  else if  (input$sector=="J") 
  mysector = "J - Information and communication activities"
  else if  (input$sector=="K") 
  mysector = "K - Financial and insurance activities"
  else if  (input$sector=="L") 
  mysector = "L - Real estate activities"
  else if  (input$sector=="M") 
  mysector = "M - Consultancy, scientific and technical activities"
  else if  (input$sector=="N") 
  mysector = "N - Administrative and support service activities"
  else if  (input$sector=="O") 
  mysector = "O - Public administration and defence; compulsory social security"
  else if  (input$sector=="P") 
  mysector = "P - Education"
  else if  (input$sector=="Q") 
  mysector = "Q - Human health and social work activities"
  else if  (input$sector=="R") 
  mysector = "R - Arts, entertainment, sports and recreation activities"
  else if  (input$sector=="S") 
  mysector = "S - Other service activities"
  else if  (input$sector=="T") 
  mysector = "T - Activities of households as employers; undifferentiated goods- and services-producing activities of households for own use" 
  else if  (input$sector=="NA") 
  mysector = "NA" 
  else if  (input$sector=="All") 
  mysector = "All"
  
  a<- min(myobs4()$percent_sample)
  
  a<- round(a,digits=2)
  
  aa<- max(myobs4()$percent_sample)
  
  aa<- round(aa,digits=2)
  
  if (input$population=="FRM")  
  mytext = paste("Product:", input$prod, "||", "Bank:", input$bank, "||", "Size:", input$size, "||", "Age:", input$firmage, "||", "Region:", input$region, "||", "Sector:", mysector, "<br> At its lowest / highest, your sample represents ", a, "/", aa, " percent of the total firm loans")
  
  else if (input$population=="PRV")  
  mytext = paste("Product:", input$prod, "||", "Bank:", input$bank, "||", "Age:", input$age, "||", "Gender:", input$gender, "||", "Region:", input$region, "||", "Profession:", input$prof, "||", "Education:", input$edu, "||", "Family:", input$fam, "<br> At its lowest / highest, your sample represents ", a, "/", aa, " percent of the total household loans")
  
    don <- xts(x = basesample2()$New, order.by = basesample2()$date)
    
    # Finally the plot
    dygraph(don, main = mytext) %>%
      dySeries("V1", label = "New Credit") %>%
      dyOptions(stackedGraph = TRUE) %>%
      dyRangeSelector(height = 20) %>%
      dyAxis("y", label = mylabel)
})
```


### Overdue Credit

```{r}
renderDygraph({
  
  if (dim(basesample2()[1])==0)
    return(NULL)
  
  if  (input$unit=="Level")  
  mylabel = "Amount (million euros)"
  else if  (input$unit=="MoM Abs Change")  
  mylabel = "Monthly Amount Change (million euros)"
  else if  (input$unit=="MoM Rel Change")  
  mylabel = "Monthly Percentage Change (%)"
  else if  (input$unit=="YoY Abs Change")  
  mylabel = "Yearly Amount Change (million euros)"
  else if  (input$unit=="YoY Rel Change")  
  mylabel = "Yearly Percentage Change (%)"
  
  if  (input$sector=="A") 
  mysector = "A - Agriculture, farming of animals, hunting and forestry"
  else if  (input$sector=="B") 
  mysector = "B - Mining and quarrying"
  else if  (input$sector=="C") 
  mysector = "C - Manufacturing" 
  else if  (input$sector=="D") 
  mysector = "D - Electricity, gas, steam, cold and hot water and cold air"
  else if  (input$sector=="E") 
  mysector = "E - Water collection, treatment and distribution; sewerage, waste management and remediation activities"
  else if  (input$sector=="F") 
  mysector = "F - Construction"
  else if  (input$sector=="G") 
  mysector = "G - Wholesale and retail trade; repair of motor vehicles and motorcycles"
  else if  (input$sector=="H") 
  mysector = "H - Transportation and storage" 
  else if  (input$sector=="I") 
  mysector = "I - Accommodation and food service activities"
  else if  (input$sector=="J") 
  mysector = "J - Information and communication activities"
  else if  (input$sector=="K") 
  mysector = "K - Financial and insurance activities"
  else if  (input$sector=="L") 
  mysector = "L - Real estate activities"
  else if  (input$sector=="M") 
  mysector = "M - Consultancy, scientific and technical activities"
  else if  (input$sector=="N") 
  mysector = "N - Administrative and support service activities"
  else if  (input$sector=="O") 
  mysector = "O - Public administration and defence; compulsory social security"
  else if  (input$sector=="P") 
  mysector = "P - Education"
  else if  (input$sector=="Q") 
  mysector = "Q - Human health and social work activities"
  else if  (input$sector=="R") 
  mysector = "R - Arts, entertainment, sports and recreation activities"
  else if  (input$sector=="S") 
  mysector = "S - Other service activities"
  else if  (input$sector=="T") 
  mysector = "T - Activities of households as employers; undifferentiated goods- and services-producing activities of households for own use" 
  else if  (input$sector=="NA") 
  mysector = "NA" 
  else if  (input$sector=="All") 
  mysector = "All"
  
  a<- min(myobs4()$percent_sample)
  
  a<- round(a,digits=2)
  
  aa<- max(myobs4()$percent_sample)
  
  aa<- round(aa,digits=2)
  
  if (input$population=="FRM")  
  mytext = paste("Product:", input$prod, "||", "Bank:", input$bank, "||", "Size:", input$size, "||", "Age:", input$firmage, "||", "Region:", input$region, "||", "Sector:", mysector, "<br> At its lowest / highest, your sample represents ", a, "/", aa, " percent of the total firm loans")
  
  else if (input$population=="PRV")  
  mytext = paste("Product:", input$prod, "||", "Bank:", input$bank, "||", "Age:", input$age, "||", "Gender:", input$gender, "||", "Region:", input$region, "||", "Profession:", input$prof, "||", "Education:", input$edu, "||", "Family:", input$fam, "<br> At its lowest / highest, your sample represents ", a, "/", aa, " percent of the total household loans")
  
    don <- xts(x = basesample2()$Overdue, order.by = basesample2()$date)
    
    # Finally the plot
    dygraph(don, main = mytext) %>%
      dySeries("V1", label = "Overdue Credit") %>%
      dyOptions(stackedGraph = TRUE) %>%
      dyRangeSelector(height = 20) %>%
      dyAxis("y", label = mylabel)
})
```

### Written-Off Credit


```{r}
renderDygraph({
  
  if (dim(basesample2()[1])==0)
    return(NULL)
  
  if  (input$unit=="Level")  
  mylabel = "Amount (million euros)"
  else if  (input$unit=="MoM Abs Change")  
  mylabel = "Monthly Amount Change (million euros)"
  else if  (input$unit=="MoM Rel Change")  
  mylabel = "Monthly Percentage Change (%)"
  else if  (input$unit=="YoY Abs Change")  
  mylabel = "Yearly Amount Change (million euros)"
  else if  (input$unit=="YoY Rel Change")  
  mylabel = "Yearly Percentage Change (%)"
  
  if  (input$sector=="A") 
  mysector = "A - Agriculture, farming of animals, hunting and forestry"
  else if  (input$sector=="B") 
  mysector = "B - Mining and quarrying"
  else if  (input$sector=="C") 
  mysector = "C - Manufacturing" 
  else if  (input$sector=="D") 
  mysector = "D - Electricity, gas, steam, cold and hot water and cold air"
  else if  (input$sector=="E") 
  mysector = "E - Water collection, treatment and distribution; sewerage, waste management and remediation activities"
  else if  (input$sector=="F") 
  mysector = "F - Construction"
  else if  (input$sector=="G") 
  mysector = "G - Wholesale and retail trade; repair of motor vehicles and motorcycles"
  else if  (input$sector=="H") 
  mysector = "H - Transportation and storage" 
  else if  (input$sector=="I") 
  mysector = "I - Accommodation and food service activities"
  else if  (input$sector=="J") 
  mysector = "J - Information and communication activities"
  else if  (input$sector=="K") 
  mysector = "K - Financial and insurance activities"
  else if  (input$sector=="L") 
  mysector = "L - Real estate activities"
  else if  (input$sector=="M") 
  mysector = "M - Consultancy, scientific and technical activities"
  else if  (input$sector=="N") 
  mysector = "N - Administrative and support service activities"
  else if  (input$sector=="O") 
  mysector = "O - Public administration and defence; compulsory social security"
  else if  (input$sector=="P") 
  mysector = "P - Education"
  else if  (input$sector=="Q") 
  mysector = "Q - Human health and social work activities"
  else if  (input$sector=="R") 
  mysector = "R - Arts, entertainment, sports and recreation activities"
  else if  (input$sector=="S") 
  mysector = "S - Other service activities"
  else if  (input$sector=="T") 
  mysector = "T - Activities of households as employers; undifferentiated goods- and services-producing activities of households for own use" 
  else if  (input$sector=="NA") 
  mysector = "NA" 
  else if  (input$sector=="All") 
  mysector = "All"
  
  a<- min(myobs4()$percent_sample)
  
  a<- round(a,digits=2)
  
  aa<- max(myobs4()$percent_sample)
  
  aa<- round(aa,digits=2)
  
  if (input$population=="FRM")  
  mytext = paste("Product:", input$prod, "||", "Bank:", input$bank, "||", "Size:", input$size, "||", "Age:", input$firmage, "||", "Region:", input$region, "||", "Sector:", mysector, "<br> At its lowest / highest, your sample represents ", a, "/", aa, " percent of the total firm loans")
  
  else if (input$population=="PRV")  
  mytext = paste("Product:", input$prod, "||", "Bank:", input$bank, "||", "Age:", input$age, "||", "Gender:", input$gender, "||", "Region:", input$region, "||", "Profession:", input$prof, "||", "Education:", input$edu, "||", "Family:", input$fam, "<br> At its lowest / highest, your sample represents ", a, "/", aa, " percent of the total household loans")

    don <- xts(x = basesample2()$Writtenoff, order.by = basesample2()$date)

    
    # Finally the plot
    dygraph(don, main = mytext) %>%
      dySeries("V1", label = "Written-Off Credit") %>%
      dyOptions(stackedGraph = TRUE) %>%
      dyRangeSelector(height = 20) %>%
      dyAxis("y", label = mylabel)
})

```


### Effective Credit

```{r}
renderDygraph({
  
  if (dim(basesample2()[1])==0)
    return(NULL)
  
  if  (input$unit=="Level")  
  mylabel = "Amount (million euros)"
  else if  (input$unit=="MoM Abs Change")  
  mylabel = "Monthly Amount Change (million euros)"
  else if  (input$unit=="MoM Rel Change")  
  mylabel = "Monthly Percentage Change (%)"
  else if  (input$unit=="YoY Abs Change")  
  mylabel = "Yearly Amount Change (million euros)"
  else if  (input$unit=="YoY Rel Change")  
  mylabel = "Yearly Percentage Change (%)"
  
  if  (input$sector=="A") 
  mysector = "A - Agriculture, farming of animals, hunting and forestry"
  else if  (input$sector=="B") 
  mysector = "B - Mining and quarrying"
  else if  (input$sector=="C") 
  mysector = "C - Manufacturing" 
  else if  (input$sector=="D") 
  mysector = "D - Electricity, gas, steam, cold and hot water and cold air"
  else if  (input$sector=="E") 
  mysector = "E - Water collection, treatment and distribution; sewerage, waste management and remediation activities"
  else if  (input$sector=="F") 
  mysector = "F - Construction"
  else if  (input$sector=="G") 
  mysector = "G - Wholesale and retail trade; repair of motor vehicles and motorcycles"
  else if  (input$sector=="H") 
  mysector = "H - Transportation and storage" 
  else if  (input$sector=="I") 
  mysector = "I - Accommodation and food service activities"
  else if  (input$sector=="J") 
  mysector = "J - Information and communication activities"
  else if  (input$sector=="K") 
  mysector = "K - Financial and insurance activities"
  else if  (input$sector=="L") 
  mysector = "L - Real estate activities"
  else if  (input$sector=="M") 
  mysector = "M - Consultancy, scientific and technical activities"
  else if  (input$sector=="N") 
  mysector = "N - Administrative and support service activities"
  else if  (input$sector=="O") 
  mysector = "O - Public administration and defence; compulsory social security"
  else if  (input$sector=="P") 
  mysector = "P - Education"
  else if  (input$sector=="Q") 
  mysector = "Q - Human health and social work activities"
  else if  (input$sector=="R") 
  mysector = "R - Arts, entertainment, sports and recreation activities"
  else if  (input$sector=="S") 
  mysector = "S - Other service activities"
  else if  (input$sector=="T") 
  mysector = "T - Activities of households as employers; undifferentiated goods- and services-producing activities of households for own use" 
  else if  (input$sector=="NA") 
  mysector = "NA" 
  else if  (input$sector=="All") 
  mysector = "All"
  
  a<- min(myobs4()$percent_sample)
  
  a<- round(a,digits=2)
  
  aa<- max(myobs4()$percent_sample)
  
  aa<- round(aa,digits=2)
  
  if (input$population=="FRM")  
  mytext = paste("Product:", input$prod, "||", "Bank:", input$bank, "||", "Size:", input$size, "||", "Age:", input$firmage, "||", "Region:", input$region, "||", "Sector:", mysector, "<br> At its lowest / highest, your sample represents ", a, "/", aa, " percent of the total firm loans")
  
  else if (input$population=="PRV")  
  mytext = paste("Product:", input$prod, "||", "Bank:", input$bank, "||", "Age:", input$age, "||", "Gender:", input$gender, "||", "Region:", input$region, "||", "Profession:", input$prof, "||", "Education:", input$edu, "||", "Family:", input$fam, "<br> At its lowest / highest, your sample represents ", a, "/", aa, " percent of the total household loans")

    don <- xts(x = basesample2()$Effective, order.by = basesample2()$date)
    
    
    # Finally the plot
    dygraph(don, main = mytext) %>%
      dySeries("V1", label = "Effective Credit") %>%
      dyOptions(stackedGraph = TRUE) %>%
      dyRangeSelector(height = 20) %>%
      dyAxis("y", label = mylabel)
})

```

### Potential Credit

```{r}
renderDygraph({
  
  if (dim(basesample2()[1])==0)
    return(NULL)
  
  if  (input$unit=="Level")  
  mylabel = "Amount (million euros)"
  else if  (input$unit=="MoM Abs Change")  
  mylabel = "Monthly Amount Change (million euros)"
  else if  (input$unit=="MoM Rel Change")  
  mylabel = "Monthly Percentage Change (%)"
  else if  (input$unit=="YoY Abs Change")  
  mylabel = "Yearly Amount Change (million euros)"
  else if  (input$unit=="YoY Rel Change")  
  mylabel = "Yearly Percentage Change (%)"
  
  if  (input$sector=="A") 
  mysector = "A - Agriculture, farming of animals, hunting and forestry"
  else if  (input$sector=="B") 
  mysector = "B - Mining and quarrying"
  else if  (input$sector=="C") 
  mysector = "C - Manufacturing" 
  else if  (input$sector=="D") 
  mysector = "D - Electricity, gas, steam, cold and hot water and cold air"
  else if  (input$sector=="E") 
  mysector = "E - Water collection, treatment and distribution; sewerage, waste management and remediation activities"
  else if  (input$sector=="F") 
  mysector = "F - Construction"
  else if  (input$sector=="G") 
  mysector = "G - Wholesale and retail trade; repair of motor vehicles and motorcycles"
  else if  (input$sector=="H") 
  mysector = "H - Transportation and storage" 
  else if  (input$sector=="I") 
  mysector = "I - Accommodation and food service activities"
  else if  (input$sector=="J") 
  mysector = "J - Information and communication activities"
  else if  (input$sector=="K") 
  mysector = "K - Financial and insurance activities"
  else if  (input$sector=="L") 
  mysector = "L - Real estate activities"
  else if  (input$sector=="M") 
  mysector = "M - Consultancy, scientific and technical activities"
  else if  (input$sector=="N") 
  mysector = "N - Administrative and support service activities"
  else if  (input$sector=="O") 
  mysector = "O - Public administration and defence; compulsory social security"
  else if  (input$sector=="P") 
  mysector = "P - Education"
  else if  (input$sector=="Q") 
  mysector = "Q - Human health and social work activities"
  else if  (input$sector=="R") 
  mysector = "R - Arts, entertainment, sports and recreation activities"
  else if  (input$sector=="S") 
  mysector = "S - Other service activities"
  else if  (input$sector=="T") 
  mysector = "T - Activities of households as employers; undifferentiated goods- and services-producing activities of households for own use" 
  else if  (input$sector=="NA") 
  mysector = "NA" 
  else if  (input$sector=="All") 
  mysector = "All"
    
  a<- min(myobs4()$percent_sample)
  
  a<- round(a,digits=2)
  
  aa<- max(myobs4()$percent_sample)
  
  aa<- round(aa,digits=2)
  
  if (input$population=="FRM")  
  mytext = paste("Product:", input$prod, "||", "Bank:", input$bank, "||", "Size:", input$size, "||", "Age:", input$firmage, "||", "Region:", input$region, "||", "Sector:", mysector, "<br> At its lowest / highest, your sample represents ", a, "/", aa, " percent of the total firm loans")
  
  else if (input$population=="PRV")  
  mytext = paste("Product:", input$prod, "||", "Bank:", input$bank, "||", "Age:", input$age, "||", "Gender:", input$gender, "||", "Region:", input$region, "||", "Profession:", input$prof, "||", "Education:", input$edu, "||", "Family:", input$fam, "<br> At its lowest / highest, your sample represents ", a, "/", aa, " percent of the total household loans")

    don <- xts(x = basesample2()$Potential, order.by = basesample2()$date)
  
    
    # Finally the plot
    dygraph(don, main = mytext) %>%
      dySeries("V1", label = "Potential Credit") %>%
      dyOptions(stackedGraph = TRUE) %>%
      dyRangeSelector(height = 20) %>%
      dyAxis("y", label = mylabel)
})
```


### Short-Term Credit

```{r}
renderDygraph({
  
  if (dim(basesample2()[1])==0)
    return(NULL)
  
  if  (input$unit=="Level")  
  mylabel = "Amount (million euros)"
  else if  (input$unit=="MoM Abs Change")  
  mylabel = "Monthly Amount Change (million euros)"
  else if  (input$unit=="MoM Rel Change")  
  mylabel = "Monthly Percentage Change (%)"
  else if  (input$unit=="YoY Abs Change")  
  mylabel = "Yearly Amount Change (million euros)"
  else if  (input$unit=="YoY Rel Change")  
  mylabel = "Yearly Percentage Change (%)"
  
  if  (input$sector=="A") 
  mysector = "A - Agriculture, farming of animals, hunting and forestry"
  else if  (input$sector=="B") 
  mysector = "B - Mining and quarrying"
  else if  (input$sector=="C") 
  mysector = "C - Manufacturing" 
  else if  (input$sector=="D") 
  mysector = "D - Electricity, gas, steam, cold and hot water and cold air"
  else if  (input$sector=="E") 
  mysector = "E - Water collection, treatment and distribution; sewerage, waste management and remediation activities"
  else if  (input$sector=="F") 
  mysector = "F - Construction"
  else if  (input$sector=="G") 
  mysector = "G - Wholesale and retail trade; repair of motor vehicles and motorcycles"
  else if  (input$sector=="H") 
  mysector = "H - Transportation and storage" 
  else if  (input$sector=="I") 
  mysector = "I - Accommodation and food service activities"
  else if  (input$sector=="J") 
  mysector = "J - Information and communication activities"
  else if  (input$sector=="K") 
  mysector = "K - Financial and insurance activities"
  else if  (input$sector=="L") 
  mysector = "L - Real estate activities"
  else if  (input$sector=="M") 
  mysector = "M - Consultancy, scientific and technical activities"
  else if  (input$sector=="N") 
  mysector = "N - Administrative and support service activities"
  else if  (input$sector=="O") 
  mysector = "O - Public administration and defence; compulsory social security"
  else if  (input$sector=="P") 
  mysector = "P - Education"
  else if  (input$sector=="Q") 
  mysector = "Q - Human health and social work activities"
  else if  (input$sector=="R") 
  mysector = "R - Arts, entertainment, sports and recreation activities"
  else if  (input$sector=="S") 
  mysector = "S - Other service activities"
  else if  (input$sector=="T") 
  mysector = "T - Activities of households as employers; undifferentiated goods- and services-producing activities of households for own use" 
  else if  (input$sector=="NA") 
  mysector = "NA" 
  else if  (input$sector=="All") 
  mysector = "All"
  
  a<- min(myobs4()$percent_sample)
  
  a<- round(a,digits=2)
  
  aa<- max(myobs4()$percent_sample)
  
  aa<- round(aa,digits=2)
  
  if (input$population=="FRM")  
  mytext = paste("Product:", input$prod, "||", "Bank:", input$bank, "||", "Size:", input$size, "||", "Age:", input$firmage, "||", "Region:", input$region, "||", "Sector:", mysector, "<br> At its lowest / highest, your sample represents ", a, "/", aa, " percent of the total firm loans")
  
  else if (input$population=="PRV")  
  mytext = paste("Product:", input$prod, "||", "Bank:", input$bank, "||", "Age:", input$age, "||", "Gender:", input$gender, "||", "Region:", input$region, "||", "Profession:", input$prof, "||", "Education:", input$edu, "||", "Family:", input$fam, "<br> At its lowest / highest, your sample represents ", a, "/", aa, " percent of the total household loans")

    don <- xts(x = basesample2()$Short, order.by = basesample2()$date)
    
    # Finally the plot
    dygraph(don, main = mytext) %>%
      dySeries("V1", label = "Short-Term Credit") %>%
      dyOptions(stackedGraph = TRUE) %>%
      dyRangeSelector(height = 20) %>%
      dyAxis("y", label = mylabel)
})
```


### Number of Loans

```{r}
renderDygraph({
  
  
  if (dim(basesample2()[1])==0)
    return(NULL)
  
  if  (input$unit=="Level")  
  mylabel = "Number"
  else if  (input$unit=="MoM Abs Change")  
  mylabel = "Monthly Amount Change"
  else if  (input$unit=="MoM Rel Change")  
  mylabel = "Monthly Percentage Change (%)"
  else if  (input$unit=="YoY Abs Change")  
  mylabel = "Yearly Amount Change"
  else if  (input$unit=="YoY Rel Change")  
  mylabel = "Yearly Percentage Change (%)"
  
  if  (input$sector=="A") 
  mysector = "A - Agriculture, farming of animals, hunting and forestry"
  else if  (input$sector=="B") 
  mysector = "B - Mining and quarrying"
  else if  (input$sector=="C") 
  mysector = "C - Manufacturing" 
  else if  (input$sector=="D") 
  mysector = "D - Electricity, gas, steam, cold and hot water and cold air"
  else if  (input$sector=="E") 
  mysector = "E - Water collection, treatment and distribution; sewerage, waste management and remediation activities"
  else if  (input$sector=="F") 
  mysector = "F - Construction"
  else if  (input$sector=="G") 
  mysector = "G - Wholesale and retail trade; repair of motor vehicles and motorcycles"
  else if  (input$sector=="H") 
  mysector = "H - Transportation and storage" 
  else if  (input$sector=="I") 
  mysector = "I - Accommodation and food service activities"
  else if  (input$sector=="J") 
  mysector = "J - Information and communication activities"
  else if  (input$sector=="K") 
  mysector = "K - Financial and insurance activities"
  else if  (input$sector=="L") 
  mysector = "L - Real estate activities"
  else if  (input$sector=="M") 
  mysector = "M - Consultancy, scientific and technical activities"
  else if  (input$sector=="N") 
  mysector = "N - Administrative and support service activities"
  else if  (input$sector=="O") 
  mysector = "O - Public administration and defence; compulsory social security"
  else if  (input$sector=="P") 
  mysector = "P - Education"
  else if  (input$sector=="Q") 
  mysector = "Q - Human health and social work activities"
  else if  (input$sector=="R") 
  mysector = "R - Arts, entertainment, sports and recreation activities"
  else if  (input$sector=="S") 
  mysector = "S - Other service activities"
  else if  (input$sector=="T") 
  mysector = "T - Activities of households as employers; undifferentiated goods- and services-producing activities of households for own use" 
  else if  (input$sector=="NA") 
  mysector = "NA" 
  else if  (input$sector=="All") 
  mysector = "All"
  
  a<- min(myobs4()$percent_sample)
  
  a<- round(a,digits=2)
  
  aa<- max(myobs4()$percent_sample)
  
  aa<- round(aa,digits=2)
  
  if (input$population=="FRM")  
  mytext = paste("Product:", input$prod, "||", "Bank:", input$bank, "||", "Size:", input$size, "||", "Age:", input$firmage, "||", "Region:", input$region, "||", "Sector:", mysector, "<br> At its lowest / highest, your sample represents ", a, "/", aa, " percent of the total firm loans")
  
  else if (input$population=="PRV")  
  mytext = paste("Product:", input$prod, "||", "Bank:", input$bank, "||", "Age:", input$age, "||", "Gender:", input$gender, "||", "Region:", input$region, "||", "Profession:", input$prof, "||", "Education:", input$edu, "||", "Family:", input$fam, "<br> At its lowest / highest, your sample represents ", a, "/", aa, " percent of the total household loans")

    don <- xts(x = basesample2()$Loan, order.by = basesample2()$date)

    
    # Finally the plot
    dygraph(don, main = mytext) %>%
      dySeries("V1", label = "Number of Loans") %>%
      dyOptions(stackedGraph = TRUE) %>%
      dyRangeSelector(height = 20) %>%
      dyAxis("y", label = mylabel)

    
})
```


Moratorium
=======================================================================

<p style="font-family: times, serif; font-size:15pt; font-style:italic">
    <mark>**Attention!**</mark> **The following filters need to be selected: Moratorium, Population, Mode, Bank, Product and Debtor Characteristics.** 
</p>


```{r}
useShinyjs(rmd = TRUE)
actionButton("reset4", "Reset",
    icon("sliders"), 
    style="color: #fff; background-color: #71afe3; border-radius: 0%; border-color: #71afe3; padding:8px; font-size:100%; width:70px")

observeEvent(input$reset4, {
 shinyjs::reset("population")
 shinyjs::reset("unit")
 shinyjs::reset("bank")
 shinyjs::reset("prod")
 shinyjs::reset("size")
 shinyjs::reset("firmage")
 shinyjs::reset("region")
 shinyjs::reset("sector")
 shinyjs::reset("age")
 shinyjs::reset("gender")
 shinyjs::reset("hregion")
 shinyjs::reset("prof")
 shinyjs::reset("edu")
 shinyjs::reset("fam")
 shinyjs::reset("mosamplesize1")
 shinyjs::reset("mosamplesize2")
})
```



```{r}

renderText({
  if (input$population == "FRM")
  paste("Your Choice: Population = ", input$population, ", Mode = ", input$unit, ", Bank = ", input$bank, ", Product = ", input$prod, ", Size = ", input$size, ", Age = ", input$firmage, ", Region = ", input$region, ", Sector = ", input$sector, ", Moratorium = ", input$moratoria) 
  
  else if (input$population == "PRV")
  paste("Your Choice: Population = ", input$population, ", Mode = ", input$unit, ", Bank = ", input$bank, ", Product = ", input$prod, ", Age = ", input$age, ", Region = ", input$hregion, ", Gender = ", input$gender, ", Profession = ", input$prof, ", Education = ", input$edu, ", Family = ", input$fam, ", Moratorium = ", input$moratoria)  

})

renderText({
  
  paste(" ") 
  
})

```


```{r}   
mobasesample <- reactive({ 
  
    req(input$bank)
    req(input$prod)    
    req(input$size)
    req(input$firmage)    
    req(input$region)
    req(input$sector)     
    req(input$age)
    req(input$gender)    
    req(input$hregion)
    req(input$prof)    
    req(input$edu)
    req(input$fam) 
  
    if(input$bank == "All") {
      filt1 <- quote(Bank != "@?><")
    } else {
      filt1 <- quote(Bank == input$bank) 
    }
    
    
    if (input$prod == "All") {
      filt2 <- quote(type != "@?><")
    } else {
      filt2 <- quote(type == input$prod)
    }
    
    # size
    
    if (input$size == "All") {
      filt3 <- quote(size != "@?><")
    } else {
      filt3 <- quote(size == input$size)
    }
    
    if (input$firmage == "All") {
      filt4 <- quote(FAge != "@?><")
    } else {
      filt4 <- quote(FAge == input$firmage)
    }
    
    if (input$region == "All") {
      filt5 <- quote(Regiao != "@?><")
    } else {
      filt5 <- quote(Regiao == input$region)
    } 
    
    if (input$sector == "All") {
      filt6 <- quote(Sector != "@?><")
    } else {
      filt6 <- quote(Sector == input$sector)
    } 
    
    # household
    if (input$age == "All") {
      filt7 <- quote(Age != "@?><")
    } else {
      filt7 <- quote(Age == input$age)
    }
    
    if (input$gender == "All") {
      filt8 <- quote(Gender != "@?><")
    } else {
      filt8 <- quote(Gender == input$gender)
    } 
    
    if (input$hregion == "All") {
      filt9 <- quote(Regiao != "@?><")
    } else {
      filt9 <- quote(Regiao == input$hregion)
    }     
    
    if (input$prof == "All") {
      filt10 <- quote(Profession != "@?><")
    } else {
      filt10 <- quote(Profession == input$prof)
    }
    
    if (input$edu == "All") {
      filt11 <- quote(Education != "@?><")
    } else {
      filt11 <- quote(Education == input$edu)
    } 
    
    if (input$fam == "All") {
      filt12 <- quote(Family != "@?><")
    } else {
      filt12 <- quote(Family == input$fam)
    }  
    
    if (input$moratoria == "All") {
      filt13 <- quote(moratoria != "@?><")
    } else {
      filt13 <- quote(moratoria == input$moratoria)
    }  

    
    if (input$population=="FRM")  
      bankall_FRM_moratoria %>%
        filter_(filt1) %>%
        filter_(filt2) %>% 
        filter_(filt3) %>% 
        filter_(filt4) %>% 
        filter_(filt5) %>% 
        filter_(filt6) %>%  
        filter_(filt13) %>%  
        mutate_at(vars(Valor_Glob: Valor_ST), funs(./1000000)) %>%
        rename(Global = Valor_Glob, Effective = Valor_Eff, New = Valor_New, Overdue = Valor_Vencido, Potential = Valor_Pot, Short = Valor_ST, Writtenoff = Valor_AbAtv, Loan = nb_loan) %>%       
        group_by(date) %>% 
        summarise_at(vars(Global, Effective, New, Overdue, Potential, Short, Writtenoff, Loan), funs(sum)) %>%  
        mutate_if(is.numeric, round, 2) 
    
    else if (input$population=="PRV")  
      bankall_PRV_moratoria %>% 
        filter_(filt1) %>%
        filter_(filt2) %>% 
        filter_(filt7) %>% 
        filter_(filt8) %>% 
        filter_(filt9) %>% 
        filter_(filt10) %>% 
        filter_(filt11) %>% 
        filter_(filt12) %>% 
        filter_(filt13) %>% 
        mutate_at(vars(Valor_Glob: Valor_ST), funs(./1000000)) %>%
        rename(Global = Valor_Glob, Effective = Valor_Eff, New = Valor_New, Overdue = Valor_Vencido, Potential = Valor_Pot, Short = Valor_ST, Writtenoff = Valor_AbAtv, Loan = nb_loan) %>%       
        group_by(date) %>% 
        summarise_at(vars(Global, Effective, New, Overdue, Potential, Short, Writtenoff, Loan), funs(sum)) %>%  
        mutate_if(is.numeric, round, 2) 
    
})



mobasesample2 <- reactive({ 

  if (input$unit=="Level")
    mobasesample()  %>%  
        mutate_if(is.numeric, round, 2)
  
  else if (input$unit=="MoM Abs Change")
    mobasesample() %>% 
    arrange(date) %>%
    mutate(Valor_Glob_ch= Global- lag(Global))%>% 
    mutate(Valor_Eff_ch= Effective- lag(Effective))%>% 
    mutate(Valor_New_ch= New- lag(New))%>% 
    mutate(Valor_Vencido_ch= Overdue- lag(Overdue))%>% 
    mutate(Valor_Pot_ch= Potential- lag(Potential))%>% 
    mutate(Valor_ST_ch= Short- lag(Short))%>%  
    mutate(Valor_AbAtv_ch= Writtenoff- lag(Writtenoff))%>%
    mutate(nb_loan_ch= Loan- lag(Loan))%>%
    filter(date!="2020-03-31") %>% 
    select(date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch, Valor_AbAtv_ch, nb_loan_ch) %>%
    rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch, Writtenoff = Valor_AbAtv_ch, Loan = nb_loan_ch)
  
  else if (input$unit=="MoM Rel Change")
    mobasesample() %>% 
    arrange(date) %>%
    mutate(Valor_Glob_ch= 100*(Global- lag(Global))/lag(Global))%>% 
    mutate(Valor_Eff_ch= 100*(Effective- lag(Effective))/lag(Effective))%>% 
    mutate(Valor_New_ch= 100*(New- lag(New))/lag(New))%>% 
    mutate(Valor_Vencido_ch= 100*(Overdue- lag(Overdue))/lag(Overdue))%>% 
    mutate(Valor_Pot_ch= 100*(Potential- lag(Potential))/lag(Potential))%>% 
    mutate(Valor_ST_ch= 100*(Short- lag(Short))/lag(Short))%>%  
    mutate(Valor_AbAtv_ch= 100*(Writtenoff- lag(Writtenoff))/lag(Writtenoff))%>%
    mutate(nb_loan_ch= 100*(Loan- lag(Loan))/lag(Loan))%>%
    filter(date!="2020-03-31") %>% 
    select(date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch, Valor_AbAtv_ch, nb_loan_ch) %>%
    rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch, Writtenoff = Valor_AbAtv_ch, Loan = nb_loan_ch) 
  
  else if (input$unit=="YoY Abs Change")
    mobasesample() %>% 
    arrange(date) %>%
    mutate(Valor_Glob_ch= Global- lag(Global, 12))%>% 
    mutate(Valor_Eff_ch= Effective- lag(Effective, 12))%>% 
    mutate(Valor_New_ch= New- lag(New, 12))%>% 
    mutate(Valor_Vencido_ch= Overdue- lag(Overdue, 12))%>% 
    mutate(Valor_Pot_ch= Potential- lag(Potential, 12))%>% 
    mutate(Valor_ST_ch= Short- lag(Short, 12))%>%  
    mutate(Valor_AbAtv_ch= Writtenoff- lag(Writtenoff, 12))%>%
    mutate(nb_loan_ch= Loan- lag(Loan, 12))%>%
    filter(date!="2020-03-31") %>% 
    select(date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch, Valor_AbAtv_ch, nb_loan_ch) %>%
    rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch, Writtenoff = Valor_AbAtv_ch, Loan = nb_loan_ch)
  
  else if (input$unit=="YoY Rel Change")
    mobasesample() %>% 
    arrange(date) %>%
    mutate(Valor_Glob_ch= 100*(Global- lag(Global, 12))/lag(Global, 12))%>% 
    mutate(Valor_Eff_ch= 100*(Effective- lag(Effective, 12))/lag(Effective, 12))%>% 
    mutate(Valor_New_ch= 100*(New- lag(New, 12))/lag(New, 12))%>% 
    mutate(Valor_Vencido_ch= 100*(Overdue- lag(Overdue, 12))/lag(Overdue, 12))%>% 
    mutate(Valor_Pot_ch= 100*(Potential- lag(Potential, 12))/lag(Potential, 12))%>% 
    mutate(Valor_ST_ch= 100*(Short- lag(Short, 12))/lag(Short, 12))%>%  
    mutate(Valor_AbAtv_ch= 100*(Writtenoff- lag(Writtenoff, 12))/lag(Writtenoff, 12))%>%
    mutate(nb_loan_ch= 100*(Loan- lag(Loan, 12))/lag(Loan, 12))%>%
    filter(date!="2020-03-31") %>% 
    select(date, Valor_Glob_ch, Valor_Eff_ch, Valor_New_ch, Valor_Vencido_ch, Valor_Pot_ch, Valor_ST_ch, Valor_AbAtv_ch, nb_loan_ch) %>%
    rename(Global = Valor_Glob_ch, Effective = Valor_Eff_ch, New = Valor_New_ch, Overdue = Valor_Vencido_ch, Potential = Valor_Pot_ch, Short = Valor_ST_ch, Writtenoff = Valor_AbAtv_ch, Loan = nb_loan_ch)  
  
})


momyobs1 <- reactive({ 
  
    mobasesample() %>% 
    group_by(date) %>% 
    summarise_at(vars(Loan), funs(sum))
        
})

momyobs2 <- reactive({ 
  if (input$population=="FRM")  
  bankall_FRM_moratoria  %>% 
  group_by(date) %>% 
  summarise_at(vars(nb_loan), funs(sum))
  
  else if (input$population=="PRV")  
  bankall_PRV_moratoria  %>% 
  group_by(date) %>% 
  summarise_at(vars(nb_loan), funs(sum))  
})

momyobs3 <- reactive({ 
  merge(momyobs1(), momyobs2(),by="date")
})


momyobs4 <- reactive({ 
    momyobs3() %>%
    filter(nb_loan !=0) %>% 
    mutate(percent_sample= 100*Loan/nb_loan)
})

```


Row  {.tabset}
---------------------------------------------------------------------- 


### Global Credit

```{r}
renderDygraph({
  
  if (dim(mobasesample2()[1])==0)
    return(NULL)
  
  if  (input$unit=="Level")  
  mylabel = "Amount (million euros)"
  else if  (input$unit=="MoM Abs Change")  
  mylabel = "Monthly Amount Change (million euros)"
  else if  (input$unit=="MoM Rel Change")  
  mylabel = "Monthly Percentage Change (%)"
  else if  (input$unit=="YoY Abs Change")  
  mylabel = "Yearly Amount Change (million euros)"
  else if  (input$unit=="YoY Rel Change")  
  mylabel = "Yearly Percentage Change (%)"
  
  if  (input$sector=="A") 
  mysector = "A - Agriculture, farming of animals, hunting and forestry"
  else if  (input$sector=="B") 
  mysector = "B - Mining and quarrying"
  else if  (input$sector=="C") 
  mysector = "C - Manufacturing" 
  else if  (input$sector=="D") 
  mysector = "D - Electricity, gas, steam, cold and hot water and cold air"
  else if  (input$sector=="E") 
  mysector = "E - Water collection, treatment and distribution; sewerage, waste management and remediation activities"
  else if  (input$sector=="F") 
  mysector = "F - Construction"
  else if  (input$sector=="G") 
  mysector = "G - Wholesale and retail trade; repair of motor vehicles and motorcycles"
  else if  (input$sector=="H") 
  mysector = "H - Transportation and storage" 
  else if  (input$sector=="I") 
  mysector = "I - Accommodation and food service activities"
  else if  (input$sector=="J") 
  mysector = "J - Information and communication activities"
  else if  (input$sector=="K") 
  mysector = "K - Financial and insurance activities"
  else if  (input$sector=="L") 
  mysector = "L - Real estate activities"
  else if  (input$sector=="M") 
  mysector = "M - Consultancy, scientific and technical activities"
  else if  (input$sector=="N") 
  mysector = "N - Administrative and support service activities"
  else if  (input$sector=="O") 
  mysector = "O - Public administration and defence; compulsory social security"
  else if  (input$sector=="P") 
  mysector = "P - Education"
  else if  (input$sector=="Q") 
  mysector = "Q - Human health and social work activities"
  else if  (input$sector=="R") 
  mysector = "R - Arts, entertainment, sports and recreation activities"
  else if  (input$sector=="S") 
  mysector = "S - Other service activities"
  else if  (input$sector=="T") 
  mysector = "T - Activities of households as employers; undifferentiated goods- and services-producing activities of households for own use" 
  else if  (input$sector=="NA") 
  mysector = "NA" 
  else if  (input$sector=="All") 
  mysector = "All"
  
  
  b<- min(momyobs4()$percent_sample)
 
  b<- round(b,digits=2)
  
  bb<- max(momyobs4()$percent_sample)
  
  bb<- round(bb,digits=2)
 
  
  if (input$population=="FRM")  
  mytext = paste("Product:", input$prod, "||", "Bank:", input$bank, "||", "Size:", input$size, "||", "Age:", input$firmage, "||", "Region:", input$region, "||", "Sector:", mysector, "||", "Moratorium:", input$moratoria, "<br> At its lowest / highest, your sample represents ", b, "/", bb, " percent of the total firm loans")
  
  else if (input$population=="PRV")  
  mytext = paste("Product:", input$prod, "||", "Bank:", input$bank, "||", "Age:", input$age, "||", "Gender:", input$gender, "||", "Region:", input$region, "||", "Profession:", input$prof, "||", "Education:", input$edu, "||", "Family:", input$fam, "||", "Moratorium:", input$moratoria, "<br> At its lowest / highest, your sample represents ", b, "/", bb, " percent of the total household loans")
  
    don <- xts(x = mobasesample2()$Global, order.by = mobasesample2()$date)
    
    # Finally the plot
    dygraph(don, main = mytext) %>%
      dySeries("V1", label = "Global Credit") %>%
      dyOptions(stackedGraph = TRUE) %>%
      dyRangeSelector(height = 20) %>%
      dyAxis("y", label = mylabel)
})
```


### New Credit

```{r}
renderDygraph({
  
  if (dim(mobasesample2()[1])==0)
    return(NULL)
  
  if  (input$unit=="Level")  
  mylabel = "Amount (million euros)"
  else if  (input$unit=="MoM Abs Change")  
  mylabel = "Monthly Amount Change (million euros)"
  else if  (input$unit=="MoM Rel Change")  
  mylabel = "Monthly Percentage Change (%)"
  else if  (input$unit=="YoY Abs Change")  
  mylabel = "Yearly Amount Change (million euros)"
  else if  (input$unit=="YoY Rel Change")  
  mylabel = "Yearly Percentage Change (%)"
  
  if  (input$sector=="A") 
  mysector = "A - Agriculture, farming of animals, hunting and forestry"
  else if  (input$sector=="B") 
  mysector = "B - Mining and quarrying"
  else if  (input$sector=="C") 
  mysector = "C - Manufacturing" 
  else if  (input$sector=="D") 
  mysector = "D - Electricity, gas, steam, cold and hot water and cold air"
  else if  (input$sector=="E") 
  mysector = "E - Water collection, treatment and distribution; sewerage, waste management and remediation activities"
  else if  (input$sector=="F") 
  mysector = "F - Construction"
  else if  (input$sector=="G") 
  mysector = "G - Wholesale and retail trade; repair of motor vehicles and motorcycles"
  else if  (input$sector=="H") 
  mysector = "H - Transportation and storage" 
  else if  (input$sector=="I") 
  mysector = "I - Accommodation and food service activities"
  else if  (input$sector=="J") 
  mysector = "J - Information and communication activities"
  else if  (input$sector=="K") 
  mysector = "K - Financial and insurance activities"
  else if  (input$sector=="L") 
  mysector = "L - Real estate activities"
  else if  (input$sector=="M") 
  mysector = "M - Consultancy, scientific and technical activities"
  else if  (input$sector=="N") 
  mysector = "N - Administrative and support service activities"
  else if  (input$sector=="O") 
  mysector = "O - Public administration and defence; compulsory social security"
  else if  (input$sector=="P") 
  mysector = "P - Education"
  else if  (input$sector=="Q") 
  mysector = "Q - Human health and social work activities"
  else if  (input$sector=="R") 
  mysector = "R - Arts, entertainment, sports and recreation activities"
  else if  (input$sector=="S") 
  mysector = "S - Other service activities"
  else if  (input$sector=="T") 
  mysector = "T - Activities of households as employers; undifferentiated goods- and services-producing activities of households for own use" 
  else if  (input$sector=="NA") 
  mysector = "NA" 
  else if  (input$sector=="All") 
  mysector = "All"
  
  b<- min(momyobs4()$percent_sample)
 
  b<- round(b,digits=2)
 
  
  bb<- max(momyobs4()$percent_sample)
  
  bb<- round(bb,digits=2)
 
  
  if (input$population=="FRM")  
  mytext = paste("Product:", input$prod, "||", "Bank:", input$bank, "||", "Size:", input$size, "||", "Age:", input$firmage, "||", "Region:", input$region, "||", "Sector:", mysector, "||", "Moratorium:", input$moratoria, "<br> At its lowest / highest, your sample represents ", b, "/", bb, " percent of the total firm loans")
  
  else if (input$population=="PRV")  
  mytext = paste("Product:", input$prod, "||", "Bank:", input$bank, "||", "Age:", input$age, "||", "Gender:", input$gender, "||", "Region:", input$region, "||", "Profession:", input$prof, "||", "Education:", input$edu, "||", "Family:", input$fam, "||", "Moratorium:", input$moratoria, "<br> At its lowest / highest, your sample represents ", b, "/", bb, " percent of the total household loans")
  
    don <- xts(x = mobasesample2()$New, order.by = mobasesample2()$date)

    # Finally the plot
    dygraph(don, main = mytext) %>%
      dySeries("V1", label = "New Credit") %>%
      dyOptions(stackedGraph = TRUE) %>%
      dyRangeSelector(height = 20) %>%
      dyAxis("y", label = mylabel)
})
```


### Overdue Credit

```{r}
renderDygraph({
  
  if (dim(mobasesample2()[1])==0)
    return(NULL)
  
  if  (input$unit=="Level")  
  mylabel = "Amount (million euros)"
  else if  (input$unit=="MoM Abs Change")  
  mylabel = "Monthly Amount Change (million euros)"
  else if  (input$unit=="MoM Rel Change")  
  mylabel = "Monthly Percentage Change (%)"
  else if  (input$unit=="YoY Abs Change")  
  mylabel = "Yearly Amount Change (million euros)"
  else if  (input$unit=="YoY Rel Change")  
  mylabel = "Yearly Percentage Change (%)"
  
  if  (input$sector=="A") 
  mysector = "A - Agriculture, farming of animals, hunting and forestry"
  else if  (input$sector=="B") 
  mysector = "B - Mining and quarrying"
  else if  (input$sector=="C") 
  mysector = "C - Manufacturing" 
  else if  (input$sector=="D") 
  mysector = "D - Electricity, gas, steam, cold and hot water and cold air"
  else if  (input$sector=="E") 
  mysector = "E - Water collection, treatment and distribution; sewerage, waste management and remediation activities"
  else if  (input$sector=="F") 
  mysector = "F - Construction"
  else if  (input$sector=="G") 
  mysector = "G - Wholesale and retail trade; repair of motor vehicles and motorcycles"
  else if  (input$sector=="H") 
  mysector = "H - Transportation and storage" 
  else if  (input$sector=="I") 
  mysector = "I - Accommodation and food service activities"
  else if  (input$sector=="J") 
  mysector = "J - Information and communication activities"
  else if  (input$sector=="K") 
  mysector = "K - Financial and insurance activities"
  else if  (input$sector=="L") 
  mysector = "L - Real estate activities"
  else if  (input$sector=="M") 
  mysector = "M - Consultancy, scientific and technical activities"
  else if  (input$sector=="N") 
  mysector = "N - Administrative and support service activities"
  else if  (input$sector=="O") 
  mysector = "O - Public administration and defence; compulsory social security"
  else if  (input$sector=="P") 
  mysector = "P - Education"
  else if  (input$sector=="Q") 
  mysector = "Q - Human health and social work activities"
  else if  (input$sector=="R") 
  mysector = "R - Arts, entertainment, sports and recreation activities"
  else if  (input$sector=="S") 
  mysector = "S - Other service activities"
  else if  (input$sector=="T") 
  mysector = "T - Activities of households as employers; undifferentiated goods- and services-producing activities of households for own use" 
  else if  (input$sector=="NA") 
  mysector = "NA" 
  else if  (input$sector=="All") 
  mysector = "All"
  
  b<- min(momyobs4()$percent_sample)
 
  b<- round(b,digits=2)
 
  bb<- max(momyobs4()$percent_sample)
  
  bb<- round(bb,digits=2)
 
  
  if (input$population=="FRM")  
  mytext = paste("Product:", input$prod, "||", "Bank:", input$bank, "||", "Size:", input$size, "||", "Age:", input$firmage, "||", "Region:", input$region, "||", "Sector:", mysector, "||", "Moratorium:", input$moratoria, "<br> At its lowest / highest, your sample represents ", b, "/", bb, " percent of the total firm loans")
  
  else if (input$population=="PRV")  
  mytext = paste("Product:", input$prod, "||", "Bank:", input$bank, "||", "Age:", input$age, "||", "Gender:", input$gender, "||", "Region:", input$region, "||", "Profession:", input$prof, "||", "Education:", input$edu, "||", "Family:", input$fam, "||", "Moratorium:", input$moratoria, "<br> At its lowest / highest, your sample represents ", b, "/", bb, " percent of the total household loans")
  
    don <- xts(x = mobasesample2()$Overdue, order.by = mobasesample2()$date)

    
    # Finally the plot
    dygraph(don, main = mytext) %>%
      dySeries("V1", label = "Overdue Credit") %>%
      dyOptions(stackedGraph = TRUE) %>%
      dyRangeSelector(height = 20) %>%
      dyAxis("y", label = mylabel)
})
```

### Written-Off Credit


```{r}
renderDygraph({
  
  if (dim(mobasesample2()[1])==0)
    return(NULL)
  
  if  (input$unit=="Level")  
  mylabel = "Amount (million euros)"
  else if  (input$unit=="MoM Abs Change")  
  mylabel = "Monthly Amount Change (million euros)"
  else if  (input$unit=="MoM Rel Change")  
  mylabel = "Monthly Percentage Change (%)"
  else if  (input$unit=="YoY Abs Change")  
  mylabel = "Yearly Amount Change (million euros)"
  else if  (input$unit=="YoY Rel Change")  
  mylabel = "Yearly Percentage Change (%)"
  
  if  (input$sector=="A") 
  mysector = "A - Agriculture, farming of animals, hunting and forestry"
  else if  (input$sector=="B") 
  mysector = "B - Mining and quarrying"
  else if  (input$sector=="C") 
  mysector = "C - Manufacturing" 
  else if  (input$sector=="D") 
  mysector = "D - Electricity, gas, steam, cold and hot water and cold air"
  else if  (input$sector=="E") 
  mysector = "E - Water collection, treatment and distribution; sewerage, waste management and remediation activities"
  else if  (input$sector=="F") 
  mysector = "F - Construction"
  else if  (input$sector=="G") 
  mysector = "G - Wholesale and retail trade; repair of motor vehicles and motorcycles"
  else if  (input$sector=="H") 
  mysector = "H - Transportation and storage" 
  else if  (input$sector=="I") 
  mysector = "I - Accommodation and food service activities"
  else if  (input$sector=="J") 
  mysector = "J - Information and communication activities"
  else if  (input$sector=="K") 
  mysector = "K - Financial and insurance activities"
  else if  (input$sector=="L") 
  mysector = "L - Real estate activities"
  else if  (input$sector=="M") 
  mysector = "M - Consultancy, scientific and technical activities"
  else if  (input$sector=="N") 
  mysector = "N - Administrative and support service activities"
  else if  (input$sector=="O") 
  mysector = "O - Public administration and defence; compulsory social security"
  else if  (input$sector=="P") 
  mysector = "P - Education"
  else if  (input$sector=="Q") 
  mysector = "Q - Human health and social work activities"
  else if  (input$sector=="R") 
  mysector = "R - Arts, entertainment, sports and recreation activities"
  else if  (input$sector=="S") 
  mysector = "S - Other service activities"
  else if  (input$sector=="T") 
  mysector = "T - Activities of households as employers; undifferentiated goods- and services-producing activities of households for own use" 
  else if  (input$sector=="NA") 
  mysector = "NA" 
  else if  (input$sector=="All") 
  mysector = "All"
  
  b<- min(momyobs4()$percent_sample)
 
  b<- round(b,digits=2)
 
  bb<- max(momyobs4()$percent_sample)
  
  bb<- round(bb,digits=2)
 
  
  if (input$population=="FRM")  
  mytext = paste("Product:", input$prod, "||", "Bank:", input$bank, "||", "Size:", input$size, "||", "Age:", input$firmage, "||", "Region:", input$region, "||", "Sector:", mysector, "||", "Moratorium:", input$moratoria, "<br> At its lowest / highest, your sample represents ", b, "/", bb, " percent of the total firm loans")
  
  else if (input$population=="PRV")  
  mytext = paste("Product:", input$prod, "||", "Bank:", input$bank, "||", "Age:", input$age, "||", "Gender:", input$gender, "||", "Region:", input$region, "||", "Profession:", input$prof, "||", "Education:", input$edu, "||", "Family:", input$fam, "||", "Moratorium:", input$moratoria, "<br> At its lowest / highest, your sample represents ", b, "/", bb, " percent of the total household loans")

    don <- xts(x = mobasesample2()$Writtenoff, order.by = mobasesample2()$date)
    
    # Finally the plot
    dygraph(don, main = mytext) %>%
      dySeries("V1", label = "Written-Off Credit") %>%
      dyOptions(stackedGraph = TRUE) %>%
      dyRangeSelector(height = 20) %>%
      dyAxis("y", label = mylabel)
})

```


### Effective Credit

```{r}
renderDygraph({
  
  if (dim(mobasesample2()[1])==0)
    return(NULL)
  
  if  (input$unit=="Level")  
  mylabel = "Amount (million euros)"
  else if  (input$unit=="MoM Abs Change")  
  mylabel = "Monthly Amount Change (million euros)"
  else if  (input$unit=="MoM Rel Change")  
  mylabel = "Monthly Percentage Change (%)"
  else if  (input$unit=="YoY Abs Change")  
  mylabel = "Yearly Amount Change (million euros)"
  else if  (input$unit=="YoY Rel Change")  
  mylabel = "Yearly Percentage Change (%)"
  
  if  (input$sector=="A") 
  mysector = "A - Agriculture, farming of animals, hunting and forestry"
  else if  (input$sector=="B") 
  mysector = "B - Mining and quarrying"
  else if  (input$sector=="C") 
  mysector = "C - Manufacturing" 
  else if  (input$sector=="D") 
  mysector = "D - Electricity, gas, steam, cold and hot water and cold air"
  else if  (input$sector=="E") 
  mysector = "E - Water collection, treatment and distribution; sewerage, waste management and remediation activities"
  else if  (input$sector=="F") 
  mysector = "F - Construction"
  else if  (input$sector=="G") 
  mysector = "G - Wholesale and retail trade; repair of motor vehicles and motorcycles"
  else if  (input$sector=="H") 
  mysector = "H - Transportation and storage" 
  else if  (input$sector=="I") 
  mysector = "I - Accommodation and food service activities"
  else if  (input$sector=="J") 
  mysector = "J - Information and communication activities"
  else if  (input$sector=="K") 
  mysector = "K - Financial and insurance activities"
  else if  (input$sector=="L") 
  mysector = "L - Real estate activities"
  else if  (input$sector=="M") 
  mysector = "M - Consultancy, scientific and technical activities"
  else if  (input$sector=="N") 
  mysector = "N - Administrative and support service activities"
  else if  (input$sector=="O") 
  mysector = "O - Public administration and defence; compulsory social security"
  else if  (input$sector=="P") 
  mysector = "P - Education"
  else if  (input$sector=="Q") 
  mysector = "Q - Human health and social work activities"
  else if  (input$sector=="R") 
  mysector = "R - Arts, entertainment, sports and recreation activities"
  else if  (input$sector=="S") 
  mysector = "S - Other service activities"
  else if  (input$sector=="T") 
  mysector = "T - Activities of households as employers; undifferentiated goods- and services-producing activities of households for own use" 
  else if  (input$sector=="NA") 
  mysector = "NA" 
  else if  (input$sector=="All") 
  mysector = "All"
  
  b<- min(momyobs4()$percent_sample)
 
  b<- round(b,digits=2)
 
  bb<- max(momyobs4()$percent_sample)
  
  bb<- round(bb,digits=2)
 
  
  if (input$population=="FRM")  
  mytext = paste("Product:", input$prod, "||", "Bank:", input$bank, "||", "Size:", input$size, "||", "Age:", input$firmage, "||", "Region:", input$region, "||", "Sector:", mysector, "||", "Moratorium:", input$moratoria, "<br> At its lowest / highest, your sample represents ", b, "/", bb, " percent of the total firm loans")
  
  else if (input$population=="PRV")  
  mytext = paste("Product:", input$prod, "||", "Bank:", input$bank, "||", "Age:", input$age, "||", "Gender:", input$gender, "||", "Region:", input$region, "||", "Profession:", input$prof, "||", "Education:", input$edu, "||", "Family:", input$fam, "||", "Moratorium:", input$moratoria, "<br> At its lowest / highest, your sample represents ", b, "/", bb, " percent of the total household loans")

    don <- xts(x = mobasesample2()$Effective, order.by = mobasesample2()$date)
    
    # Finally the plot
    dygraph(don, main = mytext) %>%
      dySeries("V1", label = "Effective Credit") %>%
      dyOptions(stackedGraph = TRUE) %>%
      dyRangeSelector(height = 20) %>%
      dyAxis("y", label = mylabel)
})

```

### Potential Credit

```{r}
renderDygraph({
  
  if (dim(mobasesample2()[1])==0)
    return(NULL)
  
  if  (input$unit=="Level")  
  mylabel = "Amount (million euros)"
  else if  (input$unit=="MoM Abs Change")  
  mylabel = "Monthly Amount Change (million euros)"
  else if  (input$unit=="MoM Rel Change")  
  mylabel = "Monthly Percentage Change (%)"
  else if  (input$unit=="YoY Abs Change")  
  mylabel = "Yearly Amount Change (million euros)"
  else if  (input$unit=="YoY Rel Change")  
  mylabel = "Yearly Percentage Change (%)"
  
  if  (input$sector=="A") 
  mysector = "A - Agriculture, farming of animals, hunting and forestry"
  else if  (input$sector=="B") 
  mysector = "B - Mining and quarrying"
  else if  (input$sector=="C") 
  mysector = "C - Manufacturing" 
  else if  (input$sector=="D") 
  mysector = "D - Electricity, gas, steam, cold and hot water and cold air"
  else if  (input$sector=="E") 
  mysector = "E - Water collection, treatment and distribution; sewerage, waste management and remediation activities"
  else if  (input$sector=="F") 
  mysector = "F - Construction"
  else if  (input$sector=="G") 
  mysector = "G - Wholesale and retail trade; repair of motor vehicles and motorcycles"
  else if  (input$sector=="H") 
  mysector = "H - Transportation and storage" 
  else if  (input$sector=="I") 
  mysector = "I - Accommodation and food service activities"
  else if  (input$sector=="J") 
  mysector = "J - Information and communication activities"
  else if  (input$sector=="K") 
  mysector = "K - Financial and insurance activities"
  else if  (input$sector=="L") 
  mysector = "L - Real estate activities"
  else if  (input$sector=="M") 
  mysector = "M - Consultancy, scientific and technical activities"
  else if  (input$sector=="N") 
  mysector = "N - Administrative and support service activities"
  else if  (input$sector=="O") 
  mysector = "O - Public administration and defence; compulsory social security"
  else if  (input$sector=="P") 
  mysector = "P - Education"
  else if  (input$sector=="Q") 
  mysector = "Q - Human health and social work activities"
  else if  (input$sector=="R") 
  mysector = "R - Arts, entertainment, sports and recreation activities"
  else if  (input$sector=="S") 
  mysector = "S - Other service activities"
  else if  (input$sector=="T") 
  mysector = "T - Activities of households as employers; undifferentiated goods- and services-producing activities of households for own use" 
  else if  (input$sector=="NA") 
  mysector = "NA" 
  else if  (input$sector=="All") 
  mysector = "All"
    
  b<- min(momyobs4()$percent_sample)
 
  b<- round(b,digits=2)
 
  bb<- max(momyobs4()$percent_sample)
  
  bb<- round(bb,digits=2)
 
  
  if (input$population=="FRM")  
  mytext = paste("Product:", input$prod, "||", "Bank:", input$bank, "||", "Size:", input$size, "||", "Age:", input$firmage, "||", "Region:", input$region, "||", "Sector:", mysector, "||", "Moratorium:", input$moratoria, "<br> At its lowest / highest, your sample represents ", b, "/", bb, " percent of the total firm loans")
  
  else if (input$population=="PRV")  
  mytext = paste("Product:", input$prod, "||", "Bank:", input$bank, "||", "Age:", input$age, "||", "Gender:", input$gender, "||", "Region:", input$region, "||", "Profession:", input$prof, "||", "Education:", input$edu, "||", "Family:", input$fam, "||", "Moratorium:", input$moratoria, "<br> At its lowest / highest, your sample represents ", b, "/", bb, " percent of the total household loans")

    don <- xts(x = mobasesample2()$Potential, order.by = mobasesample2()$date)
    
    # Finally the plot
    dygraph(don, main = mytext) %>%
      dySeries("V1", label = "Potential Credit") %>%
      dyOptions(stackedGraph = TRUE) %>%
      dyRangeSelector(height = 20) %>%
      dyAxis("y", label = mylabel)
})
```


### Short-Term Credit

```{r}
renderDygraph({
  
  if (dim(mobasesample2()[1])==0)
    return(NULL)
  
  if  (input$unit=="Level")  
  mylabel = "Amount (million euros)"
  else if  (input$unit=="MoM Abs Change")  
  mylabel = "Monthly Amount Change (million euros)"
  else if  (input$unit=="MoM Rel Change")  
  mylabel = "Monthly Percentage Change (%)"
  else if  (input$unit=="YoY Abs Change")  
  mylabel = "Yearly Amount Change (million euros)"
  else if  (input$unit=="YoY Rel Change")  
  mylabel = "Yearly Percentage Change (%)"
  
  if  (input$sector=="A") 
  mysector = "A - Agriculture, farming of animals, hunting and forestry"
  else if  (input$sector=="B") 
  mysector = "B - Mining and quarrying"
  else if  (input$sector=="C") 
  mysector = "C - Manufacturing" 
  else if  (input$sector=="D") 
  mysector = "D - Electricity, gas, steam, cold and hot water and cold air"
  else if  (input$sector=="E") 
  mysector = "E - Water collection, treatment and distribution; sewerage, waste management and remediation activities"
  else if  (input$sector=="F") 
  mysector = "F - Construction"
  else if  (input$sector=="G") 
  mysector = "G - Wholesale and retail trade; repair of motor vehicles and motorcycles"
  else if  (input$sector=="H") 
  mysector = "H - Transportation and storage" 
  else if  (input$sector=="I") 
  mysector = "I - Accommodation and food service activities"
  else if  (input$sector=="J") 
  mysector = "J - Information and communication activities"
  else if  (input$sector=="K") 
  mysector = "K - Financial and insurance activities"
  else if  (input$sector=="L") 
  mysector = "L - Real estate activities"
  else if  (input$sector=="M") 
  mysector = "M - Consultancy, scientific and technical activities"
  else if  (input$sector=="N") 
  mysector = "N - Administrative and support service activities"
  else if  (input$sector=="O") 
  mysector = "O - Public administration and defence; compulsory social security"
  else if  (input$sector=="P") 
  mysector = "P - Education"
  else if  (input$sector=="Q") 
  mysector = "Q - Human health and social work activities"
  else if  (input$sector=="R") 
  mysector = "R - Arts, entertainment, sports and recreation activities"
  else if  (input$sector=="S") 
  mysector = "S - Other service activities"
  else if  (input$sector=="T") 
  mysector = "T - Activities of households as employers; undifferentiated goods- and services-producing activities of households for own use" 
  else if  (input$sector=="NA") 
  mysector = "NA" 
  else if  (input$sector=="All") 
  mysector = "All"
  
  b<- min(momyobs4()$percent_sample)
 
  b<- round(b,digits=2)
 
  bb<- max(momyobs4()$percent_sample)
  
  bb<- round(bb,digits=2)
 
  
  if (input$population=="FRM")  
  mytext = paste("Product:", input$prod, "||", "Bank:", input$bank, "||", "Size:", input$size, "||", "Age:", input$firmage, "||", "Region:", input$region, "||", "Sector:", mysector, "||", "Moratorium:", input$moratoria, "<br> At its lowest / highest, your sample represents ", b, "/", bb, " percent of the total firm loans")
  
  else if (input$population=="PRV")  
  mytext = paste("Product:", input$prod, "||", "Bank:", input$bank, "||", "Age:", input$age, "||", "Gender:", input$gender, "||", "Region:", input$region, "||", "Profession:", input$prof, "||", "Education:", input$edu, "||", "Family:", input$fam, "||", "Moratorium:", input$moratoria, "<br> At its lowest / highest, your sample represents ", b, "/", bb, " percent of the total household loans")

    don <- xts(x = mobasesample2()$Short, order.by = mobasesample2()$date)
    
    # Finally the plot
    dygraph(don, main = mytext) %>%
      dySeries("V1", label = "Short-Term Credit") %>%
      dyOptions(stackedGraph = TRUE) %>%
      dyRangeSelector(height = 20) %>%
      dyAxis("y", label = mylabel)
})
```


### Number of Loans

```{r}
renderDygraph({
  
  if (dim(mobasesample2()[1])==0)
    return(NULL)
  
  if  (input$unit=="Level")  
  mylabel = "Number"
  else if  (input$unit=="MoM Abs Change")  
  mylabel = "Monthly Absolute Change"
  else if  (input$unit=="MoM Rel Change")  
  mylabel = "Monthly Percentage Change (%)"
  else if  (input$unit=="YoY Abs Change")  
  mylabel = "Yearly Absolute Change"
  else if  (input$unit=="YoY Rel Change")  
  mylabel = "Yearly Percentage Change (%)"
  
  if  (input$sector=="A") 
  mysector = "A - Agriculture, farming of animals, hunting and forestry"
  else if  (input$sector=="B") 
  mysector = "B - Mining and quarrying"
  else if  (input$sector=="C") 
  mysector = "C - Manufacturing" 
  else if  (input$sector=="D") 
  mysector = "D - Electricity, gas, steam, cold and hot water and cold air"
  else if  (input$sector=="E") 
  mysector = "E - Water collection, treatment and distribution; sewerage, waste management and remediation activities"
  else if  (input$sector=="F") 
  mysector = "F - Construction"
  else if  (input$sector=="G") 
  mysector = "G - Wholesale and retail trade; repair of motor vehicles and motorcycles"
  else if  (input$sector=="H") 
  mysector = "H - Transportation and storage" 
  else if  (input$sector=="I") 
  mysector = "I - Accommodation and food service activities"
  else if  (input$sector=="J") 
  mysector = "J - Information and communication activities"
  else if  (input$sector=="K") 
  mysector = "K - Financial and insurance activities"
  else if  (input$sector=="L") 
  mysector = "L - Real estate activities"
  else if  (input$sector=="M") 
  mysector = "M - Consultancy, scientific and technical activities"
  else if  (input$sector=="N") 
  mysector = "N - Administrative and support service activities"
  else if  (input$sector=="O") 
  mysector = "O - Public administration and defence; compulsory social security"
  else if  (input$sector=="P") 
  mysector = "P - Education"
  else if  (input$sector=="Q") 
  mysector = "Q - Human health and social work activities"
  else if  (input$sector=="R") 
  mysector = "R - Arts, entertainment, sports and recreation activities"
  else if  (input$sector=="S") 
  mysector = "S - Other service activities"
  else if  (input$sector=="T") 
  mysector = "T - Activities of households as employers; undifferentiated goods- and services-producing activities of households for own use" 
  else if  (input$sector=="NA") 
  mysector = "NA" 
  else if  (input$sector=="All") 
  mysector = "All"
  
  b<- min(momyobs4()$percent_sample)
 
  b<- round(b,digits=2)
 
  bb<- max(momyobs4()$percent_sample)
  
  bb<- round(bb,digits=2)
 
  
  if (input$population=="FRM")  
  mytext = paste("Product:", input$prod, "||", "Bank:", input$bank, "||", "Size:", input$size, "||", "Age:", input$firmage, "||", "Region:", input$region, "||", "Sector:", mysector, "||", "Moratorium:", input$moratoria, "<br> At its lowest / highest, your sample represents ", b, "/", bb, " percent of the total firm loans")
  
  else if (input$population=="PRV")  
  mytext = paste("Product:", input$prod, "||", "Bank:", input$bank, "||", "Age:", input$age, "||", "Gender:", input$gender, "||", "Region:", input$region, "||", "Profession:", input$prof, "||", "Education:", input$edu, "||", "Family:", input$fam, "||", "Moratorium:", input$moratoria, "<br> At its lowest / highest, your sample represents ", b, "/", bb, " percent of the total household loans")

    don <- xts(x = mobasesample2()$Loan, order.by = mobasesample2()$date)
    
    # Finally the plot
    dygraph(don, main = mytext) %>%
      dySeries("V1", label = "Number of Loans") %>%
      dyOptions(stackedGraph = TRUE) %>%
      dyRangeSelector(height = 20) %>%
      dyAxis("y", label = mylabel)
})
```

Useful Infos
=======================================================================

Row  {.tabset}
---------------------------------------------------------------------- 


### Filter
| Filter | Description | Options |
|:--|:--|:--|
| **General Filters** |   |  |
| Date | Reporting Date  | 2018-09 <br/> 2018-10 <br/> 2018-11 <br/> 2018-12 <br/> 2019-01 <br/> 2019-02 <br/> 2019-03 <br/> 2019-04 <br/> 2019-05 <br/> 2019-06 <br/> 2019-07 <br/> 2019-08 <br/> 2019-09 <br/> 2019-10 <br/> 2019-11 <br/> 2019-12 <br/> 2020-01 <br/> 2020-02 <br/> 2020-03 <br/> 2020-04 <br/> 2020-05 <br/> 2020-06 <br/> 2020-07 <br/> 2020-08 <br/> 2020-09 <br/> 2020-10 <br/> 2020-11 <br/> 2020-12 <br/> 2021-01 <br/> 2021-02 <br/> 2021-03 |
| Population  | Type of Debtors  |  FRM (Firms) <br/> PRV (Households) | 
| Mode   | Calculation Method  | Level <br/> MoM Abs Change (Month-to-Month Absolute Change) <br/> MoM Rel Change (Month-to-Month Relative Change in %) <br/> YoY Abs Change (Year-to-Year Absolute Change) <br/> YoY Rel Change (Year-to-Year Relative Change in %) |
| **Bank and Product** |   |  |
| Bank  | Reporting Institution  |  See Bank List | 
| Product  | Reported Financial Product  |  All <br/> Discount <br/> Current account <br/> Overdrafts <br/> None-recourse factoring <br/> Non-real estate leasing <br/> Corporate Financing <br/> Credit card <br/> Mortgage credit <br/> Consumer credit <br/> Automobile credit <br/> Other credit <br/> Bank Guarantees <br/> Other bank guarantees |
| **Firm Characteristics** | 
| Size  | Size  | All <br/> Micro <br/> Small <br/> Medium <br/> Big | 
| Age Group  | Age Group  | All <br/> <3 <br/> [3, 5) <br/> [5, 10) <br/> [10, 20) <br/> [20, 30) <br/> >=30 |
| Region  | Location (NUTS3)  | All <br/> Lisboa <br/> Norte <br/> Centro <br/> Alentejo <br/> Algarve <br/> Madeira <br/> Azores  | 
| Sector  | Business Sector  | All <br/> A - Agriculture, farming of animals, hunting and forestry <br/> B - Mining and quarrying <br/> C - Manufacturing <br/> D - Electricity, gas, steam, cold and hot water and cold air <br/> E - Water collection, treatment and distribution; sewerage, waste management and remediation activities <br/> F - Construction <br/> G - Wholesale and retail trade; repair of motor vehicles and motorcycles <br/> H - Transportation and storage <br/> I - Accommodation and food service activities <br/> J - Information and communication activities <br/> K - Financial and insurance activities <br/> L - Real estate activities <br/> M - Consultancy, scientific and technical activities <br/> N - Administrative and support service activities <br/> O - Public administration and defence; compulsory social security <br/> P - Education <br/> Q - Human health and social work activities <br/> R - Arts, entertainment, sports and recreation activities <br/> S - Other service activities <br/> T - Activities of households as employers; undifferentiated goods- and services-producing activities of households for own use  |
| **Household Characteristics** | 
| Age Group  | Age Group  | All <br/> <25 <br/> [25, 35) <br/> [35, 45) <br/> [45, 55) <br/> [55, 65) <br/> >=65 |
| Gender  | Gender  | All <br/> Female <br/> Male | 
| Region  | Location (NUTS3)  | All <br/> Lisboa <br/> Norte <br/> Centro <br/> Alentejo <br/> Algarve <br/> Madeira <br/> Azores  | 
| Profession  | Profession  | All <br/> Employee <br/> Self-employed <br/> Unemployed <br/> Student <br/> Retired <br/> Outside market |
| Education  | Education Background  | All <br/> No schooling <br/> Basic <br/> Secondary <br/> Superior |
| Family  | Family Number  | All <br/> 1 <br/> 2 <br/> 3 <br/> 4 <br/> >=5 |
| **Moratorium** | 
| Moratorium  | Moratorium Program  | All <br/> Public <br/> Private |

### Variable


| Variable | Definition |
|:--|:--|
| Global Credit  | Total credit amount, including potential credit  |
| New Credit  | Total amount of new credit granted during the reporting month  |
| Overdue Credit  | Total amount of overdue credit |
| Written-Off Credit  | Total amount of written-off credit |
| Effective Credit  | Total amount of effective credit,  excluding potential credit |
| Potential Credit  | Total amount of potential/undrawn credit |
| Short-term Credit  | Total amount of short-term credit with an original maturity less than 1 year |



### Bank List

```{r, echo=FALSE, warning=FALSE, message=FALSE}
DT::datatable(head(banklist, 3000), options = list(
  columnDefs = list(list(className = 'dt-center', targets = 5)),
  pageLength = 20,
  lengthMenu = c(5, 10, 15, 20)
))
```

### Sector

```{r, echo=FALSE, warning=FALSE, message=FALSE}
DT::datatable(head(sectorlist, 21), options = list(
  columnDefs = list(list(className = 'dt-left', targets = 3)),
  pageLength = 20
))
```



About
=======================================================================

### **About [AnaCredit](https://www.ecb.europa.eu/stats/money_credit_banking/anacredit/html/index.en.html)**

AnaCredit which stands for *analytical credit datasets* is a dataset containing detailed information on individual bank loans in the euro area, harmonised across all Member States. The project was initiated in 2011 and data collection started in September 2018. The ECB performs validation checks to ensure that data reported to AnaCredit are complete and consistent, in accordance with the requirements. 

[ECB Regulation](https://www.ecb.europa.eu/stats/money_credit_banking/anacredit/html/index.en.html).


### **About [BPLIM](https://bplim.bportugal.pt/)**

The Banco de Portugal Microdata Research Laboratory (BPLIM) started its activity in 2016 and it is located in the Porto branch of Banco de Portugal. It is an autonomous unit within the Economics and Research Department, with the core mission of supporting the production of research projects and studies about the Portuguese economy. Through BPLIM, both internal and external researchers gain access to well documented and anonymized micro data sets customized to their particular needs, and also have the possibility to use the computational resources available at the laboratory. Since BPLIM allows remote access to the data it hopes to attract the attention of both national and international researchers.


ReadMe
=======================================================================

This dashboard has multiple pages, including **Overview**, **Credit Evolution**, **Bank and Product**, **Debtor Characteristics**, **Moratorium**, **Useful Infos**, and **About**. Each page has its own top-level navigation tab. The dashboard is dynamic in the sense that different filters can be applied to generate the corresponding statistics and plots. Filters are placed on the left side of the dashboard.

Various calculation modes are available, as mentioned in the tab **Useful Infos**. It is important to note that Month-to-Month change is only available from 2018-10-31 onwards and Year-to-Yea change is only available from 2019-09-30 onwards. For Moratorium, Month-to-Month change is only available from 2020-04-30 and Year-to-Year change is not yet available.

The tab **Overview** provides a snapshot of the credit situation in a specific month and for a specific population. 

The tab **Credit situation** plots the time series of the outstanding of various credit types for each population-bank-product combination. 

The tab **Bank and Product** provides the perspective of a bank's and/or a product's standing in the Portuguese banking system.

The tab **Debtor Characteristics** decomposes the credit time series by debtor characteristics. Note that the user needs to select the population of interest (firms or households) first as debtor characteristics vary between firms (population = "FRM") and households (population = "PRV").

The tab **Moratorium** provides an view of the evolution of the Portuguese Moratorium programs, which can be decomposed using different debtor characteristics. 

The tab **Useful Infos** provides details about the levels of each filter.

The tab **About** provides further information about AnaCredit and BPLIM.

</br>


<p style="font-family: times, serif; font-size:18pt; font-style:italic">
    **Note that <mark>different filters should be applied</mark>  depending on the top-level tab that the user navigates, as illustrated below.**
</p>

</br>


| Tab | Active Filters |
|:--|:--|
| **Overview** | Select Date: <br/> Select Population: <br/> Select Mode: |
| **Credit Evolution** | Select Population: <br/> Select Mode: <br/> Select Bank:  <br/> Select Product: |
| **Bank and Product** | Select Population: <br/> Select Mode: <br/> Select Bank:  <br/> Select Product: |
| **Debtor Characteristics for Firms** | Select Population: **FRM** <br/> Select Mode: <br/> Select Bank:  <br/> Select Product:  <br/> Select Size: <br/> Select Age Group: <br/> Select Region: <br/> Select Sector: |
| **Debtor Characteristics for Households** | Select Population: **PRV** <br/> Select Mode: <br/> Select Bank:  <br/> Select Product:  <br/> Select Age Group: <br/> Select Gender: <br/> Select Region: <br/> Select Profession: <br/> Select Education: <br/> Select Family: |
| **Moratorium for Firms** | Select Population: **FRM** <br/> Select Mode: <br/> Select Bank:  <br/> Select Product:  <br/> Select Size: <br/> Select Age Group: <br/> Select Region: <br/> Select Sector: <br/> Select Moratorium Program: |
| **Moratorium  for Households** | Select Population: **PRV** <br/> Select Mode: <br/> Select Bank:  <br/> Select Product:  <br/> Select Age Group: <br/> Select Gender: <br/> Select Region: <br/> Select Profession: <br/> Select Education: <br/> Select Family: <br/> Select Moratorium Program: |

